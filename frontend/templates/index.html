<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºé“¾ç¼–æ’å¹³å° - å·¥ä½œå°</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* å¼¹çª—æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
        }
        
        .close:hover {
            color: #333;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .form-group textarea {
            min-height: 100px;
            font-family: 'Courier New', monospace;
        }
        
        .btn-create {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
        }
        
        .btn-create:hover {
            background: #5568d3;
        }
        
        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            margin-right: 10px;
        }
        
        .btn-execute {
            background: #28a745;
            color: white;
        }
        
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .btn-add {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .btn-add:hover {
            background: #5568d3;
        }
        
        .success-msg, .error-msg {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .success-msg {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error-msg {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡µé¢å¤´éƒ¨ -->
        <header>
            <div class="header-content">
                <div class="header-left">
                    <h1>ğŸ¤– æ™ºé“¾ç¼–æ’å¹³å°</h1>
                    <div class="subtitle">AI Agent å·¥ä½œæµç¼–æ’ - å·¥ä½œå°</div>
                </div>
                <div class="header-right">
                    <a href="/chat" class="btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; padding: 10px 20px; border-radius: 5px; margin-right: 15px;">ğŸ’¬ DeepSeek å¯¹è¯</a>
                    <a href="/tools" class="btn" style="background: #ff9800; color: white; text-decoration: none; padding: 10px 20px; border-radius: 5px; margin-right: 15px;">ğŸ› ï¸ å·¥å…·ç®¡ç†</a>
                    <a href="/dashboard" class="btn" style="background: #28a745; color: white; text-decoration: none; padding: 10px 20px; border-radius: 5px; margin-right: 15px;">ğŸ˜ï¸ ç¤¾åŒºå¹¿åœº</a>
                    {% if role == 'admin' %}
                    <a href="/admin" class="btn" style="background: #ff6b6b; color: white; text-decoration: none; padding: 10px 20px; border-radius: 5px; margin-right: 15px;">ğŸ”§ ç®¡ç†åå°</a>
                    {% endif %}
                    <span class="user-info">ğŸ‘¤ {{ username }}</span>
                    <a href="/logout" class="logout-btn">é€€å‡ºç™»å½•</a>
                </div>
            </div>
        </header>
        
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="agent-count">0</div>
                <div class="stat-label">å·²æ³¨å†Œ Agent</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="workflow-count">0</div>
                <div class="stat-label">å·¥ä½œæµ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="execution-count">0</div>
                <div class="stat-label">æ€»æ‰§è¡Œæ¬¡æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="success-rate">0%</div>
                <div class="stat-label">æˆåŠŸç‡</div>
            </div>
        </div>
        
        <!-- Agent åˆ—è¡¨ -->
        <div class="section">
            <div class="section-header">
                <h2>ğŸ“¦ Agent åº“</h2>
                <button class="btn-add" onclick="openCreateAgentModal()">â• åˆ›å»º Agent</button>
            </div>
            <div class="agent-list" id="agent-list">
                <p style="text-align: center; color: #999; padding: 40px;">â³ åŠ è½½ä¸­...</p>
            </div>
        </div>
        
        <!-- å·¥ä½œæµåˆ—è¡¨ -->
        <div class="section">
            <div class="section-header">
                <h2>ğŸ”„ å·¥ä½œæµ</h2>
                <div style="display: flex; gap: 8px;">
                    <button class="btn-add" onclick="window.open('/workflow-editor', '_blank')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">ğŸ¨ å¯è§†åŒ–åˆ›å»º</button>
                    <button class="btn-add" onclick="openCreateWorkflowModal()">â• JSONåˆ›å»º</button>
                </div>
            </div>
            <div class="workflow-list" id="workflow-list">
                <p style="text-align: center; color: #999; padding: 40px;">â³ åŠ è½½ä¸­...</p>
            </div>
        </div>
        
        <!-- æ—¥å¿—åˆ—è¡¨ -->
        <div class="section">
            <h2>ğŸ“ æœ€è¿‘æ—¥å¿—</h2>
            <div id="log-list">
                <p style="text-align: center; color: #999; padding: 40px;">â³ åŠ è½½ä¸­...</p>
            </div>
        </div>
        
        <!-- é¡µè„š -->
        <footer>
            <p>æ™ºé“¾ç¼–æ’å¹³å° - è®© AI Agent ç¼–æ’åƒæ­ç§¯æœ¨ä¸€æ ·ç®€å•</p>
        </footer>
    </div>
    
    <!-- åˆ›å»º Agent å¼¹çª— -->
    <div id="createAgentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>â• åˆ›å»ºæ–° Agent</h2>
                <span class="close" onclick="closeCreateAgentModal()">&times;</span>
            </div>
            
            <div id="agent-msg-success" class="success-msg"></div>
            <div id="agent-msg-error" class="error-msg"></div>
            
            <form id="createAgentForm" onsubmit="createAgent(event)">
                <div class="form-group">
                    <label>Agent åç§° *</label>
                    <input type="text" id="agent-name" required placeholder="ä¾‹å¦‚ï¼šæ–‡æœ¬å¤„ç†å™¨">
                </div>
                
                <div class="form-group">
                    <label>Agent ç±»å‹ *</label>
                    <select id="agent-type" required>
                        <option value="processor">æ–‡æœ¬å¤„ç† (processor)</option>
                        <option value="analyzer">æ•°æ®åˆ†æ (analyzer)</option>
                        <option value="generator">å†…å®¹ç”Ÿæˆ (generator)</option>
                        <option value="crawler">ç½‘é¡µçˆ¬è™« (crawler)</option>
                        <option value="other">å…¶ä»– (other)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>æè¿°</label>
                    <textarea id="agent-description" placeholder="æè¿°è¿™ä¸ª Agent çš„åŠŸèƒ½..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>å‡½æ•°ä»£ç  *</label>
                    <textarea id="agent-code" required placeholder="def process_text(text: str) -> str:
    return text.upper()"></textarea>
                </div>
                
                <button type="submit" class="btn-create">âœ… åˆ›å»º Agent</button>
            </form>
        </div>
    </div>
    
    <!-- åˆ›å»ºå·¥ä½œæµå¼¹çª— -->
    <div id="createWorkflowModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>â• åˆ›å»ºæ–°å·¥ä½œæµ</h2>
                <span class="close" onclick="closeCreateWorkflowModal()">&times;</span>
            </div>
            
            <div id="workflow-msg-success" class="success-msg"></div>
            <div id="workflow-msg-error" class="error-msg"></div>
            
            <form id="createWorkflowForm" onsubmit="createWorkflow(event)">
                <div class="form-group">
                    <label>å·¥ä½œæµåç§° *</label>
                    <input type="text" id="workflow-name" required placeholder="ä¾‹å¦‚ï¼šæ•°æ®å¤„ç†æµç¨‹">
                </div>
                
                <div class="form-group">
                    <label>æè¿°</label>
                    <textarea id="workflow-description" placeholder="æè¿°è¿™ä¸ªå·¥ä½œæµçš„ç”¨é€”..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>åˆ†ç±»</label>
                    <select id="workflow-category">
                        <option value="æ•°æ®å¤„ç†">æ•°æ®å¤„ç†</option>
                        <option value="å†…å®¹ç”Ÿæˆ">å†…å®¹ç”Ÿæˆ</option>
                        <option value="è‡ªåŠ¨åŒ–">è‡ªåŠ¨åŒ–</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>å·¥ä½œæµå®šä¹‰ï¼ˆJSONæ ¼å¼ï¼‰*</label>
                    <textarea id="workflow-definition" required placeholder='{"agents": ["agent1", "agent2"], "sequence": [{"agent": "agent1", "next": "agent2"}]}'></textarea>
                    <small style="color: #666;">æç¤ºï¼šå®šä¹‰ Agent æ‰§è¡Œé¡ºåºå’Œæ•°æ®æµ</small>
                </div>
                
                <button type="submit" class="btn-create">âœ… åˆ›å»ºå·¥ä½œæµ</button>
            </form>
        </div>
    </div>
    
    <script src="{{ url_for('static', filename='js/main.js') }}?v=20251102125338"></script>
    <script>
        // ============================================================================
        // å†…è”æ‰§è¡Œå‡½æ•° - ç»•è¿‡ç¼“å­˜é—®é¢˜ï¼ˆè¦†ç›–å¤–éƒ¨JSä¸­çš„æ—§å‡½æ•°ï¼‰
        // ============================================================================
        
        // æ˜¾ç¤ºå·¥ä½œæµæ‰§è¡Œç»“æœçš„ç¾è§‚æ¨¡æ€æ¡†
        // ğŸ†• å°†JSONç»“æœè½¬æ¢ä¸ºè‡ªç„¶è¯­è¨€
        function generateNaturalLanguageSummary(result) {
            if (!result.output || typeof result.output !== 'object') {
                return '<div style="color: #6b7280;">æš‚æ— è¾“å‡ºç»“æœ</div>';
            }
            
            // å°è¯•æ™ºèƒ½è§£æä¸åŒç±»å‹çš„è¾“å‡º
            const output = result.output;
            let summary = '';
            
            // æ£€æµ‹æ˜¯å¦æ˜¯æ—…æ¸¸è§„åˆ’ç±»å‹
            if (output.itinerary_agent_result || output.weather_info || output.attractions) {
                summary = formatTravelPlan(output);
            }
            // æ£€æµ‹æ˜¯å¦æœ‰å¤šä¸ªagentç»“æœ
            else if (Object.keys(output).some(k => k.endsWith('_result') || k.endsWith('_output'))) {
                summary = formatMultiAgentResult(output);
            }
            // é€šç”¨æ ¼å¼åŒ–
            else {
                summary = formatGenericOutput(output);
            }
            
            return summary;
        }
        
        function formatTravelPlan(output) {
            let html = '<div style="line-height: 1.8; color: #374151;">';
            
            // å¤©æ°”ä¿¡æ¯
            if (output.weather_info || output.weather_agent_result) {
                const weather = output.weather_info || output.weather_agent_result;
                const w = weather.result || weather.weather_info || weather;
                
                if (w && w.destination) {
                    const condition = w.weather_condition || w.condition || 'æ™´æœ—';
                    const temp = w.temperature || 'æœªçŸ¥';
                    const humidity = w.humidity || 'æœªçŸ¥';
                    const suit = w.suitability || 'é€‚å®œ';
                    
                    html += `
                        <div style="margin-bottom: 20px; padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; color: white;">
                            <h3 style="margin: 0 0 12px 0; font-size: 18px;">â˜€ï¸ å¤©æ°”æƒ…å†µ</h3>
                            <p style="margin: 0; font-size: 15px;">
                                <strong>${w.destination}</strong> å½“å‰å¤©æ°” <strong>${condition}</strong>ï¼Œæ¸©åº¦ <strong>${temp}</strong>ï¼Œ
                                æ¹¿åº¦ <strong>${humidity}</strong>ï¼Œ<strong>${suit}</strong>å‡ºæ¸¸ã€‚
                            </p>
                        </div>
                    `;
                }
            }
            
            // æ™¯ç‚¹æ¨è
            if (output.attraction_agent_result || output.attractions) {
                const attractions = output.attraction_agent_result || output.attractions;
                const attrList = attractions?.recommended_attractions || attractions?.attractions || [];
                
                if (attrList && attrList.length > 0) {
                    html += `
                        <div style="margin-bottom: 20px; padding: 16px; background: #f0fdf4; border-radius: 12px; border-left: 4px solid #10b981;">
                            <h3 style="margin: 0 0 12px 0; color: #047857; font-size: 18px;">ğŸ¯ æ¨èæ™¯ç‚¹</h3>
                            <ul style="margin: 0; padding-left: 20px; color: #065f46;">
                                ${attrList.map((attr, index) => `
                                    <li style="margin-bottom: 10px; line-height: 1.6;">
                                        <strong style="color: #047857; font-size: 15px;">${attr.name || 'æ™¯ç‚¹' + (index+1)}</strong>
                                        ${attr.rating ? `<span style="color: #fbbf24;"> â­${attr.rating}</span>` : ''}
                                        ${attr.description ? `<br><span style="color: #059669; font-size: 14px;">${attr.description}</span>` : ''}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                }
            }
            
            // é…’åº—æ¨è
            if (output.hotel_agent_result || output.hotels) {
                const hotels = output.hotel_agent_result || output.hotels;
                const hotelList = hotels?.recommended_hotels || hotels?.hotels || [];
                
                if (hotelList && hotelList.length > 0) {
                    html += `
                        <div style="margin-bottom: 20px; padding: 16px; background: #fef3c7; border-radius: 12px; border-left: 4px solid #f59e0b;">
                            <h3 style="margin: 0 0 12px 0; color: #92400e; font-size: 18px;">ğŸ¨ æ¨èé…’åº—</h3>
                            <ul style="margin: 0; padding-left: 20px; color: #78350f;">
                                ${hotelList.map((hotel, index) => `
                                    <li style="margin-bottom: 10px; line-height: 1.6;">
                                        <strong style="color: #92400e; font-size: 15px;">${hotel.name || 'é…’åº—' + (index+1)}</strong>
                                        ${hotel.rating ? `<span style="color: #fbbf24;"> â­${hotel.rating}</span>` : ''}
                                        ${hotel.price_range ? `<span style="color: #b45309;"> â€¢ ${hotel.price_range}</span>` : ''}
                                        ${hotel.amenities && hotel.amenities.length > 0 ? `<br><span style="color: #a16207; font-size: 14px;">è®¾æ–½ï¼š${hotel.amenities.join(' â€¢ ')}</span>` : ''}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                }
            }
            
            // è¡Œç¨‹è§„åˆ’ - å¢å¼ºç‰ˆ
            if (output.itinerary_agent_result || output.itinerary) {
                const itinerary = output.itinerary_agent_result || output.itinerary;
                const itineraryText = itinerary?.itinerary || itinerary?.result || itinerary;
                
                if (itineraryText && typeof itineraryText === 'string') {
                    // å°è¯•å°†æ–‡æœ¬åˆ†æ®µå¤„ç†ï¼Œä½¿å…¶æ›´æ˜“è¯»
                    const lines = itineraryText.split('\n').filter(line => line.trim());
                    let formattedItinerary = '';
                    
                    lines.forEach((line, index) => {
                        line = line.trim();
                        // æ£€æµ‹æ˜¯å¦æ˜¯æ—¥æœŸæ ‡é¢˜
                        if (line.match(/ç¬¬[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å\d]+å¤©/) || line.match(/Day\s*\d+/i) || line.match(/^\d+\./)) {
                            formattedItinerary += `
                                <div style="
                                    margin-top: ${index > 0 ? '20px' : '0'};
                                    padding: 12px 16px;
                                    background: white;
                                    border-radius: 8px;
                                    border-left: 4px solid #8b5cf6;
                                    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                                ">
                                    <div style="font-weight: 700; color: #6d28d9; font-size: 16px; margin-bottom: 8px;">
                                        ğŸ“† ${line}
                                    </div>
                            `;
                        } else if (line.match(/[ï¼š:]/)) {
                            // æœ‰å†’å·çš„è¡Œï¼Œå¯èƒ½æ˜¯æ—¶é—´ç‚¹æˆ–æ´»åŠ¨
                            const [label, content] = line.split(/[ï¼š:]/);
                            formattedItinerary += `
                                <div style="margin-left: 16px; margin-bottom: 6px; color: #4c1d95;">
                                    <span style="font-weight: 600; color: #7c3aed;">â° ${label}:</span>
                                    <span>${content || ''}</span>
                                </div>
                            `;
                        } else if (line.startsWith('-') || line.startsWith('â€¢') || line.startsWith('*')) {
                            // åˆ—è¡¨é¡¹
                            formattedItinerary += `
                                <div style="margin-left: 16px; margin-bottom: 4px; color: #5b21b6;">
                                    ${line.replace(/^[-â€¢*]\s*/, 'â€¢ ')}
                                </div>
                            `;
                        } else if (line.length > 0) {
                            // æ™®é€šæ–‡æœ¬
                            formattedItinerary += `
                                <div style="margin-left: 16px; margin-bottom: 6px; color: #4c1d95; line-height: 1.6;">
                                    ${line}
                                </div>
                            `;
                        }
                        
                        // å¦‚æœä¸‹ä¸€è¡Œæ˜¯æ–°çš„ä¸€å¤©æˆ–ç»“æŸï¼Œå…³é—­div
                        if (index === lines.length - 1 || 
                            (index < lines.length - 1 && (
                                lines[index + 1].match(/ç¬¬[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å\d]+å¤©/) || 
                                lines[index + 1].match(/Day\s*\d+/i) ||
                                lines[index + 1].match(/^\d+\./)
                            ))) {
                            formattedItinerary += `</div>`;
                        }
                    });
                    
                    html += `
                        <div style="margin-bottom: 20px; padding: 20px; background: #ede9fe; border-radius: 12px; border-left: 4px solid #8b5cf6;">
                            <h3 style="margin: 0 0 16px 0; color: #6d28d9; font-size: 18px; display: flex; align-items: center; gap: 8px;">
                                <span>ğŸ“…</span>
                                <span>è¯¦ç»†è¡Œç¨‹å®‰æ’</span>
                            </h3>
                            ${formattedItinerary}
                        </div>
                    `;
                } else if (typeof itineraryText === 'object') {
                    // å¦‚æœæ˜¯å¯¹è±¡ï¼Œæ ¼å¼åŒ–æ˜¾ç¤º
                    html += `
                        <div style="margin-bottom: 20px; padding: 16px; background: #ede9fe; border-radius: 12px; border-left: 4px solid #8b5cf6;">
                            <h3 style="margin: 0 0 12px 0; color: #6d28d9; font-size: 18px;">ğŸ“… è¡Œç¨‹å®‰æ’</h3>
                            <div style="font-size: 14px; line-height: 1.8; color: #4c1d95;">
                                ${formatValue(itineraryText)}
                            </div>
                        </div>
                    `;
                }
            }
            
            html += '</div>';
            return html;
        }
        
        function formatMultiAgentResult(output) {
            let html = '<div style="line-height: 1.8; color: #374151;">';
            
            Object.keys(output).forEach((key, index) => {
                const value = output[key];
                const agentName = key.replace(/_result$/, '').replace(/_output$/, '').replace(/_/g, ' ');
                
                html += `
                    <div style="margin-bottom: 16px; padding: 14px; background: ${index % 2 === 0 ? '#f9fafb' : '#f3f4f6'}; border-radius: 8px;">
                        <div style="font-weight: 600; color: #111827; margin-bottom: 8px; text-transform: capitalize;">
                            ğŸ¤– ${agentName}
                        </div>
                        <div style="color: #6b7280; font-size: 14px;">
                            ${formatValue(value)}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }
        
        function formatGenericOutput(output) {
            return `
                <div style="padding: 16px; background: #f9fafb; border-radius: 8px; line-height: 1.8; color: #374151;">
                    ${formatValue(output)}
                </div>
            `;
        }
        
        function formatValue(value) {
            if (typeof value === 'string') {
                return value;
            } else if (typeof value === 'object' && value !== null) {
                if (Array.isArray(value)) {
                    return '<ul style="margin: 4px 0; padding-left: 20px;">' +
                        value.map(item => `<li>${formatValue(item)}</li>`).join('') +
                        '</ul>';
                } else {
                    return Object.keys(value).map(k => 
                        `<div><strong>${k}:</strong> ${formatValue(value[k])}</div>`
                    ).join('');
                }
            }
            return String(value);
        }
        
        function showExecutionResult(result) {
            // ç§»é™¤æ—§çš„æ¨¡æ€æ¡†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const oldModal = document.getElementById('execution-result-modal');
            if (oldModal) oldModal.remove();
            
            const isSuccess = result.success;
            const statusIcon = isSuccess ? 'âœ…' : 'âŒ';
            const statusColor = isSuccess ? '#10b981' : '#ef4444';
            const statusText = isSuccess ? 'å·¥ä½œæµæ‰§è¡ŒæˆåŠŸï¼' : 'å·¥ä½œæµæ‰§è¡Œå¤±è´¥ï¼';
            
            // ğŸ†• ç”Ÿæˆè‡ªç„¶è¯­è¨€æ€»ç»“
            const naturalLanguageSummary = isSuccess ? generateNaturalLanguageSummary(result) : '';
            
            // ğŸ”¥ è§£ææ‰§è¡Œè¿‡ç¨‹ï¼ˆexecution_graphï¼‰
            let executionGraphHTML = '';
            if (result.execution_graph && Array.isArray(result.execution_graph) && result.execution_graph.length > 0) {
                executionGraphHTML = `
                    <div style="margin-bottom: 24px;">
                        <div style="font-weight: 600; color: #374151; margin-bottom: 16px; font-size: 16px;">ğŸ”„ æ‰§è¡Œæµç¨‹ï¼ˆDifyé£æ ¼ï¼‰</div>
                        ${result.execution_graph.map((step, index) => {
                            const stepStatus = step.status === 'completed' ? 'âœ…' : 'âŒ';
                            const stepColor = step.status === 'completed' ? '#10b981' : '#ef4444';
                            const stepBg = step.status === 'completed' ? '#f0fdf4' : '#fef2f2';
                            const stepBorder = step.status === 'completed' ? '#86efac' : '#fca5a5';
                            
                            return `
                                <div style="
                                    background: ${stepBg};
                                    border: 2px solid ${stepBorder};
                                    border-radius: 12px;
                                    padding: 16px;
                                    margin-bottom: 12px;
                                    position: relative;
                                    transition: all 0.3s;
                                ">
                                    <!-- æ­¥éª¤ç¼–å· -->
                                    <div style="
                                        position: absolute;
                                        top: -12px;
                                        left: 16px;
                                        background: white;
                                        border: 2px solid ${stepBorder};
                                        border-radius: 20px;
                                        padding: 4px 12px;
                                        font-weight: 700;
                                        font-size: 12px;
                                        color: ${stepColor};
                                    ">æ­¥éª¤ ${index + 1}</div>
                                    
                                    <!-- Agentåç§°å’ŒçŠ¶æ€ -->
                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; margin-top: 8px;">
                                        <div style="font-weight: 600; color: #111827; font-size: 15px;">
                                            ğŸ¤– ${step.agent}
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <span style="font-size: 20px;">${stepStatus}</span>
                                            <span style="color: ${stepColor}; font-weight: 600; font-size: 13px;">
                                                ${step.status === 'completed' ? 'å®Œæˆ' : 'å¤±è´¥'}
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <!-- æ‰§è¡Œæ—¶é—´ -->
                                    <div style="color: #6b7280; font-size: 13px; margin-bottom: 8px;">
                                        â±ï¸ è€—æ—¶: ${step.execution_time ? step.execution_time.toFixed(3) : '0.000'} ç§’
                                    </div>
                                    
                                    <!-- è¾“å‡ºç»“æœï¼ˆå¯æŠ˜å ï¼‰ -->
                                    ${step.output ? `
                                        <details style="margin-top: 8px;">
                                            <summary style="cursor: pointer; color: #6b7280; font-size: 13px; font-weight: 600; user-select: none;">
                                                ğŸ“„ æŸ¥çœ‹è¾“å‡ºç»“æœ
                                            </summary>
                                            <pre style="
                                                background: white;
                                                border: 1px solid #e5e7eb;
                                                border-radius: 6px;
                                                padding: 12px;
                                                margin-top: 8px;
                                                font-size: 12px;
                                                line-height: 1.5;
                                                max-height: 200px;
                                                overflow-y: auto;
                                                color: #374151;
                                            ">${JSON.stringify(step.output, null, 2)}</pre>
                                        </details>
                                    ` : ''}
                                    
                                    <!-- é”™è¯¯ä¿¡æ¯ -->
                                    ${step.error ? `
                                        <div style="
                                            background: white;
                                            border: 1px solid #fca5a5;
                                            border-radius: 6px;
                                            padding: 12px;
                                            margin-top: 8px;
                                            color: #dc2626;
                                            font-size: 13px;
                                        ">
                                            âš ï¸ ${step.error}
                                        </div>
                                    ` : ''}
                                    
                                    ${index < result.execution_graph.length - 1 ? `
                                        <!-- è¿æ¥çº¿ -->
                                        <div style="
                                            text-align: center;
                                            margin-top: 12px;
                                            color: #9ca3af;
                                            font-size: 20px;
                                        ">â†“</div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
            
            // åˆ›å»ºæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.id = 'execution-result-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 16px;
                    padding: 40px;
                    max-width: 1200px;
                    width: 95%;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                    animation: slideUp 0.3s ease;
                ">
                    <div style="text-align: center; margin-bottom: 24px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">${statusIcon}</div>
                        <h2 style="margin: 0; color: ${statusColor}; font-size: 24px;">${statusText}</h2>
                    </div>
                    
                    <div style="background: #f9fafb; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                        <div style="display: grid; grid-template-columns: auto 1fr; gap: 12px 16px; font-size: 14px;">
                            <div style="font-weight: 600; color: #6b7280;">å·¥ä½œæµï¼š</div>
                            <div style="color: #111827;">${result.workflow_name || 'N/A'}</div>
                            
                            <div style="font-weight: 600; color: #6b7280;">æ€»è€—æ—¶ï¼š</div>
                            <div style="color: #111827;">${result.execution_time ? result.execution_time.toFixed(3) : '0.000'} ç§’</div>
                            
                            <div style="font-weight: 600; color: #6b7280;">æ‰§è¡ŒIDï¼š</div>
                            <div style="color: #111827;">#${result.execution_id || 'N/A'}</div>
                        </div>
                    </div>
                    
                    ${naturalLanguageSummary ? `
                        <div style="margin-bottom: 32px;">
                            <div style="font-weight: 700; color: #111827; margin-bottom: 20px; font-size: 20px; display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 28px;">ğŸ“Š</span>
                                <span>æ‰§è¡Œç»“æœæ€»ç»“</span>
                            </div>
                            ${naturalLanguageSummary}
                        </div>
                    ` : ''}
                    
                    ${executionGraphHTML}
                    
                    ${result.error ? `
                        <div style="background: #fee2e2; border-left: 4px solid #ef4444; padding: 12px; border-radius: 4px; margin-bottom: 16px;">
                            <div style="font-weight: 600; color: #dc2626; margin-bottom: 8px;">âŒ æ€»ä½“é”™è¯¯ï¼š</div>
                            <div style="color: #991b1b; font-family: monospace; font-size: 13px; white-space: pre-wrap;">${result.error}</div>
                        </div>
                    ` : ''}
                    
                    <div style="background: #f9fafb; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                        <div style="font-weight: 600; color: #374151; margin-bottom: 12px;">ğŸ“‹ æœ€ç»ˆè¾“å‡ºï¼š</div>
                        <pre style="
                            background: #1f2937;
                            color: #10b981;
                            padding: 16px;
                            border-radius: 8px;
                            overflow-x: auto;
                            margin: 0;
                            font-size: 13px;
                            line-height: 1.5;
                            max-height: 300px;
                        ">${JSON.stringify(result.output, null, 2)}</pre>
                    </div>
                    
                    <button onclick="document.getElementById('execution-result-modal').remove(); if (typeof loadData === 'function') loadData();" style="
                        width: 100%;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border: none;
                        padding: 14px;
                        border-radius: 8px;
                        font-size: 16px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: transform 0.2s, box-shadow 0.2s;
                    " onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 8px 20px rgba(102, 126, 234, 0.4)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                        å…³é—­
                    </button>
                </div>
            `;
            
            // æ·»åŠ åŠ¨ç”»CSS
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                @keyframes slideUp {
                    from {
                        opacity: 0;
                        transform: translateY(30px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }
                @keyframes slideInRight {
                    from {
                        opacity: 0;
                        transform: translateX(100px);
                    }
                    to {
                        opacity: 1;
                        transform: translateX(0);
                    }
                }
                @keyframes slideOutRight {
                    from {
                        opacity: 1;
                        transform: translateX(0);
                    }
                    to {
                        opacity: 0;
                        transform: translateX(100px);
                    }
                }
            `;
            if (!document.getElementById('modal-animations')) {
                style.id = 'modal-animations';
                document.head.appendChild(style);
            }
            
            document.body.appendChild(modal);
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                    if (typeof loadData === 'function') loadData();
                }
            });
        }
        
        // æ‰§è¡Œå·¥ä½œæµï¼ˆå†…è”ç‰ˆæœ¬ - ä¼šè¦†ç›– main.js ä¸­çš„æ—§ç‰ˆæœ¬ï¼‰
        window.executeWorkflow = async function(workflowId, workflowName) {
            try {
                // ğŸ”¥ æ™ºèƒ½å‚æ•°æ¨¡æ¿ï¼šæ ¹æ®å·¥ä½œæµåç§°æä¾›ä¸åŒçš„é»˜è®¤å‚æ•°
                let paramTemplate = {};
                let paramExample = '';
                
                if (workflowName.includes('æ—…æ¸¸') || workflowName.includes('travel')) {
                    // æ—…æ¸¸è§„åˆ’å·¥ä½œæµ
                    paramTemplate = {
                        "destination": "åŒ—äº¬",
                        "days": 3,
                        "budget": 5000
                    };
                    paramExample = '{"destination": "åŒ—äº¬", "days": 3, "budget": 5000}';
                } else if (workflowName.includes('å†…å®¹åˆ›ä½œ') || workflowName.includes('å…¨æ ˆ') || workflowName.includes('æ–‡ç« ') || workflowName.includes('content')) {
                    // å†…å®¹åˆ›ä½œå·¥ä½œæµ
                    paramTemplate = {
                        "topic": "äººå·¥æ™ºèƒ½çš„æœªæ¥å‘å±•è¶‹åŠ¿",
                        "keywords": "AI, æœºå™¨å­¦ä¹ , æ·±åº¦å­¦ä¹ ",
                        "target_audience": "æŠ€æœ¯çˆ±å¥½è€…"
                    };
                    paramExample = '{"topic": "äººå·¥æ™ºèƒ½çš„æœªæ¥å‘å±•è¶‹åŠ¿", "keywords": "AI, æœºå™¨å­¦ä¹ , æ·±åº¦å­¦ä¹ ", "target_audience": "æŠ€æœ¯çˆ±å¥½è€…"}';
                } else if (workflowName.includes('å¤§å°å†™') || workflowName.includes('case')) {
                    // æ–‡æœ¬è½¬æ¢å·¥ä½œæµ
                    paramTemplate = {
                        "text": "Hello World",
                        "case_type": "upper"
                    };
                    paramExample = '{"text": "Hello World", "case_type": "upper"}';
                } else if (workflowName.includes('æ–‡æœ¬') || workflowName.includes('text')) {
                    // é€šç”¨æ–‡æœ¬å¤„ç†å·¥ä½œæµ
                    paramTemplate = {
                        "text": "Hello World",
                        "case_type": "upper"
                    };
                    paramExample = '{"text": "Hello World", "case_type": "upper"}';
                } else {
                    // é»˜è®¤é€šç”¨æ¨¡æ¿
                    paramTemplate = {
                        "input_data": "è¯·è¾“å…¥å†…å®¹"
                    };
                    paramExample = '{"input_data": "è¯·è¾“å…¥å†…å®¹"}';
                }
                
                // ğŸ¨ æ˜¾ç¤ºè‡ªå®šä¹‰å‚æ•°è¾“å…¥ç•Œé¢
                showWorkflowInputDialog(workflowId, workflowName, paramTemplate, paramExample);
                
            } catch (error) {
                alert(`âŒ æ‰§è¡Œå·¥ä½œæµæ—¶å‘ç”Ÿé”™è¯¯ï¼\n\n${error.message}`);
                console.error('æ‰§è¡Œå·¥ä½œæµå¤±è´¥:', error);
            }
        }
        
        // æ˜¾ç¤ºå·¥ä½œæµå‚æ•°è¾“å…¥å¯¹è¯æ¡†
        function showWorkflowInputDialog(workflowId, workflowName, paramTemplate, paramExample) {
            // ç§»é™¤æ—§çš„å¯¹è¯æ¡†
            const oldDialog = document.getElementById('workflow-input-dialog');
            if (oldDialog) oldDialog.remove();
            
            const modal = document.createElement('div');
            modal.id = 'workflow-input-dialog';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 16px;
                    width: 90%;
                    max-width: 600px;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
                    animation: slideUp 0.3s ease;
                ">
                    <!-- æ ‡é¢˜æ  -->
                    <div style="
                        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                        color: white;
                        padding: 24px 32px;
                        border-radius: 16px 16px 0 0;
                    ">
                        <h2 style="margin: 0; font-size: 22px;">â–¶ï¸ æ‰§è¡Œå·¥ä½œæµ</h2>
                        <div style="margin-top: 8px; opacity: 0.9; font-size: 14px;">${workflowName}</div>
                    </div>
                    
                    <!-- å†…å®¹åŒº -->
                    <div style="padding: 32px;">
                        <div style="margin-bottom: 16px;">
                            <div style="color: #374151; font-size: 15px; font-weight: 600; margin-bottom: 8px;">
                                ğŸ“ è¯·è¾“å…¥å‚æ•°ï¼ˆJSONæ ¼å¼ï¼‰
                            </div>
                            <div style="color: #6b7280; font-size: 13px; margin-bottom: 16px;">
                                ä¾‹å¦‚ï¼š${paramExample}
                            </div>
                        </div>
                        
                        <textarea id="workflow-input-params" style="
                            width: 100%;
                            height: 200px;
                            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
                            font-size: 14px;
                            padding: 16px;
                            border: 2px solid #e5e7eb;
                            border-radius: 8px;
                            resize: vertical;
                            background: #f9fafb;
                            color: #111827;
                            line-height: 1.6;
                            transition: border-color 0.2s;
                        " onfocus="this.style.borderColor='#10b981'" onblur="this.style.borderColor='#e5e7eb'">${JSON.stringify(paramTemplate, null, 2)}</textarea>
                        
                        <div id="input-error-message" style="
                            margin-top: 12px;
                            padding: 12px;
                            background: #fee2e2;
                            border-left: 4px solid #ef4444;
                            border-radius: 4px;
                            color: #dc2626;
                            font-size: 13px;
                            display: none;
                        "></div>
                    </div>
                    
                    <!-- æŒ‰é’®æ  -->
                    <div style="
                        padding: 24px 32px;
                        border-top: 1px solid #e5e7eb;
                        display: flex;
                        justify-content: flex-end;
                        gap: 12px;
                    ">
                        <button onclick="document.getElementById('workflow-input-dialog').remove()" style="
                            padding: 12px 24px;
                            background: #f3f4f6;
                            color: #374151;
                            border: none;
                            border-radius: 8px;
                            font-size: 15px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: background 0.2s;
                        " onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">
                            å–æ¶ˆ
                        </button>
                        <button onclick="executeWorkflowWithParams(${workflowId}, '${workflowName}')" style="
                            padding: 12px 24px;
                            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                            color: white;
                            border: none;
                            border-radius: 8px;
                            font-size: 15px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: transform 0.2s, box-shadow 0.2s;
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(16, 185, 129, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                            â–¶ï¸ å¼€å§‹æ‰§è¡Œ
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // è‡ªåŠ¨èšç„¦
            setTimeout(() => {
                const input = document.getElementById('workflow-input-params');
                if (input) input.focus();
            }, 100);
        }
        
        // æ‰§è¡Œå·¥ä½œæµï¼ˆå¸¦å‚æ•°ï¼‰
        async function executeWorkflowWithParams(workflowId, workflowName) {
            const inputTextarea = document.getElementById('workflow-input-params');
            const errorDiv = document.getElementById('input-error-message');
            const inputParamsStr = inputTextarea.value;
            
            // è§£æè¾“å…¥å‚æ•°
            let params = {};
            try {
                params = JSON.parse(inputParamsStr);
                errorDiv.style.display = 'none';
            } catch (e) {
                errorDiv.textContent = `âŒ JSONæ ¼å¼é”™è¯¯ï¼š${e.message}`;
                errorDiv.style.display = 'block';
                return;
            }
            
            // å…³é—­è¾“å…¥å¯¹è¯æ¡†
            document.getElementById('workflow-input-dialog').remove();
            
            try {
                
                console.log(`[å†…è”ç‰ˆæœ¬] æ‰§è¡Œå·¥ä½œæµ ID: ${workflowId}, åç§°: ${workflowName}, å‚æ•°:`, params);
                
                const response = await fetch(`/api/workflows/${workflowId}/execute`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(params)
                });
                
                const result = await response.json();
                console.log('[å†…è”ç‰ˆæœ¬] æ‰§è¡Œç»“æœ:', result);
                
                // ä½¿ç”¨ç¾è§‚çš„æ¨¡æ€æ¡†æ˜¾ç¤ºç»“æœ
                showExecutionResult({
                    success: result.success,
                    workflow_name: workflowName,
                    execution_time: result.execution_time,
                    execution_id: result.execution_id,
                    execution_graph: result.execution_graph,
                    output: result.output,
                    error: result.error
                });
                
            } catch (error) {
                showExecutionResult({
                    success: false,
                    workflow_name: workflowName,
                    error: error.message,
                    output: null
                });
                console.error('[å†…è”ç‰ˆæœ¬] æ‰§è¡Œå¤±è´¥:', error);
            }
        }
        
        // åˆ é™¤ Agent
        async function deleteAgent(agentName) {
            try {
                const confirmed = confirm(`ç¡®å®šè¦åˆ é™¤ Agentã€Œ${agentName}ã€å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`);
                if (!confirmed) return;
                
                const response = await fetch(`/api/agents/${encodeURIComponent(agentName)}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`âœ… Agent åˆ é™¤æˆåŠŸï¼`);
                    if (typeof loadData === 'function') {
                        loadData();
                    }
                } else {
                    alert(`âŒ åˆ é™¤å¤±è´¥ï¼\n\n${result.error || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                alert(`âŒ åˆ é™¤ Agent æ—¶å‘ç”Ÿé”™è¯¯ï¼\n\n${error.message}`);
                console.error('åˆ é™¤ Agent å¤±è´¥:', error);
            }
        }
        
        // ç¼–è¾‘å·¥ä½œæµï¼ˆä¼˜ç¾çš„è‡ªå®šä¹‰ç¼–è¾‘å™¨ï¼‰
        async function editWorkflow(workflowId) {
            try {
                // è·å–å·¥ä½œæµè¯¦æƒ…
                const response = await fetch(`/api/workflows/${workflowId}`);
                const workflow = await response.json();
                
                if (!response.ok) {
                    alert(`âŒ è·å–å·¥ä½œæµå¤±è´¥ï¼\n\n${workflow.error || 'æœªçŸ¥é”™è¯¯'}`);
                    return;
                }
                
                // è§£æworkflow_definition
                let definition = workflow.workflow_definition;
                if (typeof definition === 'string') {
                    definition = JSON.parse(definition);
                }
                
                // æ˜¾ç¤ºè‡ªå®šä¹‰ç¼–è¾‘å™¨æ¨¡æ€æ¡†
                showWorkflowEditor(workflowId, workflow.name, definition);
                
            } catch (error) {
                alert(`âŒ ç¼–è¾‘å·¥ä½œæµæ—¶å‘ç”Ÿé”™è¯¯ï¼\n\n${error.message}`);
                console.error('ç¼–è¾‘å·¥ä½œæµå¤±è´¥:', error);
            }
        }
        
        // æ˜¾ç¤ºå·¥ä½œæµç¼–è¾‘å™¨æ¨¡æ€æ¡†
        function showWorkflowEditor(workflowId, workflowName, definition) {
            // ç§»é™¤æ—§çš„ç¼–è¾‘å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const oldEditor = document.getElementById('workflow-editor-modal');
            if (oldEditor) oldEditor.remove();
            
            // åˆ›å»ºæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.id = 'workflow-editor-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease;
            `;
            
            const definitionStr = JSON.stringify(definition, null, 2);
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 16px;
                    width: 90%;
                    max-width: 1000px;
                    max-height: 90vh;
                    display: flex;
                    flex-direction: column;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
                    animation: slideUp 0.3s ease;
                ">
                    <!-- æ ‡é¢˜æ  -->
                    <div style="
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        padding: 24px 32px;
                        border-radius: 16px 16px 0 0;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    ">
                        <div>
                            <h2 style="margin: 0; font-size: 24px;">âœï¸ ç¼–è¾‘å·¥ä½œæµ</h2>
                            <div style="margin-top: 8px; opacity: 0.9; font-size: 14px;">${workflowName}</div>
                        </div>
                        <button onclick="document.getElementById('workflow-editor-modal').remove()" style="
                            background: rgba(255, 255, 255, 0.2);
                            border: none;
                            color: white;
                            width: 36px;
                            height: 36px;
                            border-radius: 50%;
                            cursor: pointer;
                            font-size: 20px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            transition: background 0.2s;
                        " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                            Ã—
                        </button>
                    </div>
                    
                    <!-- ç¼–è¾‘å™¨å†…å®¹ -->
                    <div style="
                        padding: 32px;
                        overflow-y: auto;
                        flex: 1;
                    ">
                        <div style="margin-bottom: 16px;">
                            <div style="color: #6b7280; font-size: 14px; margin-bottom: 8px;">
                                ğŸ“ JSONå®šä¹‰ï¼ˆé«˜çº§åŠŸèƒ½ï¼‰
                            </div>
                            <div style="color: #9ca3af; font-size: 13px; margin-bottom: 16px;">
                                æç¤ºï¼šä¿®æ”¹å·¥ä½œæµçš„æ‰§è¡Œé¡ºåºã€å‚æ•°æ˜ å°„ç­‰é…ç½®
                            </div>
                        </div>
                        
                        <textarea id="workflow-json-editor" style="
                            width: 100%;
                            height: 400px;
                            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
                            font-size: 14px;
                            padding: 16px;
                            border: 2px solid #e5e7eb;
                            border-radius: 8px;
                            resize: vertical;
                            background: #f9fafb;
                            color: #111827;
                            line-height: 1.6;
                            transition: border-color 0.2s;
                        " onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e5e7eb'">${definitionStr}</textarea>
                        
                        <div id="json-error-message" style="
                            margin-top: 12px;
                            padding: 12px;
                            background: #fee2e2;
                            border-left: 4px solid #ef4444;
                            border-radius: 4px;
                            color: #dc2626;
                            font-size: 13px;
                            display: none;
                        "></div>
                    </div>
                    
                    <!-- æŒ‰é’®æ  -->
                    <div style="
                        padding: 24px 32px;
                        border-top: 1px solid #e5e7eb;
                        display: flex;
                        justify-content: flex-end;
                        gap: 12px;
                    ">
                        <button onclick="document.getElementById('workflow-editor-modal').remove()" style="
                            padding: 12px 24px;
                            background: #f3f4f6;
                            color: #374151;
                            border: none;
                            border-radius: 8px;
                            font-size: 15px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: background 0.2s;
                        " onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">
                            å–æ¶ˆ
                        </button>
                        <button onclick="saveWorkflowDefinition(${workflowId})" style="
                            padding: 12px 24px;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            border: none;
                            border-radius: 8px;
                            font-size: 15px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: transform 0.2s, box-shadow 0.2s;
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(102, 126, 234, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                            ğŸ’¾ ä¿å­˜æ›´æ”¹
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // è‡ªåŠ¨èšç„¦åˆ°ç¼–è¾‘å™¨
            setTimeout(() => {
                const editor = document.getElementById('workflow-json-editor');
                if (editor) editor.focus();
            }, 100);
        }
        
        // ä¿å­˜å·¥ä½œæµå®šä¹‰
        async function saveWorkflowDefinition(workflowId) {
            const editorTextarea = document.getElementById('workflow-json-editor');
            const errorDiv = document.getElementById('json-error-message');
            const newDefinitionStr = editorTextarea.value;
            
            // éªŒè¯JSON
            let newDefinition;
            try {
                newDefinition = JSON.parse(newDefinitionStr);
                errorDiv.style.display = 'none';
            } catch (e) {
                errorDiv.textContent = `âŒ JSONæ ¼å¼é”™è¯¯ï¼š${e.message}`;
                errorDiv.style.display = 'block';
                return;
            }
            
            try {
                // æäº¤æ›´æ–°
                const updateResponse = await fetch(`/api/workflows/${workflowId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        workflow_definition: newDefinition
                    })
                });
                
                const updateResult = await updateResponse.json();
                
                if (updateResponse.ok) {
                    // æˆåŠŸï¼šå…³é—­ç¼–è¾‘å™¨ï¼Œæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    document.getElementById('workflow-editor-modal').remove();
                    
                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    const successToast = document.createElement('div');
                    successToast.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                        color: white;
                        padding: 16px 24px;
                        border-radius: 12px;
                        box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
                        z-index: 10001;
                        font-size: 15px;
                        font-weight: 600;
                        animation: slideInRight 0.3s ease;
                    `;
                    successToast.textContent = 'âœ… å·¥ä½œæµæ›´æ–°æˆåŠŸï¼';
                    document.body.appendChild(successToast);
                    
                    setTimeout(() => {
                        successToast.style.animation = 'slideOutRight 0.3s ease';
                        setTimeout(() => successToast.remove(), 300);
                    }, 2000);
                    
                    // åˆ·æ–°æ•°æ®
                    if (typeof loadData === 'function') {
                        loadData();
                    }
                } else {
                    errorDiv.textContent = `âŒ æ›´æ–°å¤±è´¥ï¼š${updateResult.error || 'æœªçŸ¥é”™è¯¯'}`;
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = `âŒ ç½‘ç»œé”™è¯¯ï¼š${error.message}`;
                errorDiv.style.display = 'block';
            }
        }
        
        // åˆ é™¤å·¥ä½œæµ
        async function deleteWorkflow(workflowId, workflowName) {
            try {
                const confirmed = confirm(`ç¡®å®šè¦åˆ é™¤å·¥ä½œæµã€Œ${workflowName}ã€å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`);
                if (!confirmed) return;
                
                const response = await fetch(`/api/workflows/${workflowId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`âœ… å·¥ä½œæµåˆ é™¤æˆåŠŸï¼`);
                    if (typeof loadData === 'function') {
                        loadData();
                    }
                } else {
                    alert(`âŒ åˆ é™¤å¤±è´¥ï¼\n\n${result.error || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                alert(`âŒ åˆ é™¤å·¥ä½œæµæ—¶å‘ç”Ÿé”™è¯¯ï¼\n\n${error.message}`);
                console.error('åˆ é™¤å·¥ä½œæµå¤±è´¥:', error);
            }
        }
        
        console.log('[å†…è”è„šæœ¬] executeWorkflow, deleteAgent, deleteWorkflow å‡½æ•°å·²åŠ è½½');
        
        // ============================================================================
        // æ¨¡æ€æ¡†å‡½æ•°
        // ============================================================================
        
        // æ‰“å¼€/å…³é—­ Agent åˆ›å»ºå¼¹çª—
        function openCreateAgentModal() {
            document.getElementById('createAgentModal').style.display = 'block';
        }
        
        function closeCreateAgentModal() {
            document.getElementById('createAgentModal').style.display = 'none';
            document.getElementById('createAgentForm').reset();
            document.getElementById('agent-msg-success').style.display = 'none';
            document.getElementById('agent-msg-error').style.display = 'none';
        }
        
        // æ‰“å¼€/å…³é—­å·¥ä½œæµåˆ›å»ºå¼¹çª—
        function openCreateWorkflowModal() {
            document.getElementById('createWorkflowModal').style.display = 'block';
        }
        
        function closeCreateWorkflowModal() {
            document.getElementById('createWorkflowModal').style.display = 'none';
            document.getElementById('createWorkflowForm').reset();
            document.getElementById('workflow-msg-success').style.display = 'none';
            document.getElementById('workflow-msg-error').style.display = 'none';
        }
        
        // åˆ›å»º Agent
        async function createAgent(event) {
            event.preventDefault();
            
            const name = document.getElementById('agent-name').value;
            const type = document.getElementById('agent-type').value;
            const description = document.getElementById('agent-description').value;
            const code = document.getElementById('agent-code').value;
            
            try {
                const response = await fetch('/api/agents', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        name: name,
                        agent_type: type,
                        description: description,
                        code: code
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('agent-msg-success').textContent = 'âœ… Agent åˆ›å»ºæˆåŠŸï¼';
                    document.getElementById('agent-msg-success').style.display = 'block';
                    document.getElementById('agent-msg-error').style.display = 'none';
                    
                    setTimeout(() => {
                        closeCreateAgentModal();
                        loadAgents(); // é‡æ–°åŠ è½½åˆ—è¡¨
                    }, 1500);
                } else {
                    document.getElementById('agent-msg-error').textContent = 'âŒ ' + (data.error || 'åˆ›å»ºå¤±è´¥');
                    document.getElementById('agent-msg-error').style.display = 'block';
                    document.getElementById('agent-msg-success').style.display = 'none';
                }
            } catch (error) {
                document.getElementById('agent-msg-error').textContent = 'âŒ ç½‘ç»œé”™è¯¯ï¼š' + error.message;
                document.getElementById('agent-msg-error').style.display = 'block';
            }
        }
        
        // åˆ›å»ºå·¥ä½œæµ
        async function createWorkflow(event) {
            event.preventDefault();
            
            const name = document.getElementById('workflow-name').value;
            const description = document.getElementById('workflow-description').value;
            const category = document.getElementById('workflow-category').value;
            const definitionStr = document.getElementById('workflow-definition').value;
            
            try {
                // éªŒè¯ JSON æ ¼å¼
                const definition = JSON.parse(definitionStr);
                
                const response = await fetch('/api/workflows', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        name: name,
                        description: description,
                        category: category,
                        workflow_definition: definition
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('workflow-msg-success').textContent = 'âœ… å·¥ä½œæµåˆ›å»ºæˆåŠŸï¼';
                    document.getElementById('workflow-msg-success').style.display = 'block';
                    document.getElementById('workflow-msg-error').style.display = 'none';
                    
                    setTimeout(() => {
                        closeCreateWorkflowModal();
                        loadWorkflows(); // é‡æ–°åŠ è½½åˆ—è¡¨
                    }, 1500);
                } else {
                    document.getElementById('workflow-msg-error').textContent = 'âŒ ' + (data.error || 'åˆ›å»ºå¤±è´¥');
                    document.getElementById('workflow-msg-error').style.display = 'block';
                    document.getElementById('workflow-msg-success').style.display = 'none';
                }
            } catch (error) {
                document.getElementById('workflow-msg-error').textContent = 'âŒ JSON æ ¼å¼é”™è¯¯ï¼š' + error.message;
                document.getElementById('workflow-msg-error').style.display = 'block';
            }
        }
        
        // æ‰§è¡Œå·¥ä½œæµ
        async function executeWorkflow(workflowId, workflowName) {
            if (!confirm(`ç¡®å®šè¦æ‰§è¡Œå·¥ä½œæµã€Œ${workflowName}ã€å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/workflows/${workflowId}/execute`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({})
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    alert('âœ… å·¥ä½œæµæ‰§è¡ŒæˆåŠŸï¼\n\nç»“æœï¼š' + JSON.stringify(data.result, null, 2));
                    loadStats();
                    loadLogs();
                } else {
                    alert('âŒ å·¥ä½œæµæ‰§è¡Œå¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('âŒ ç½‘ç»œé”™è¯¯ï¼š' + error.message);
            }
        }
        
        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const agentModal = document.getElementById('createAgentModal');
            const workflowModal = document.getElementById('createWorkflowModal');
            
            if (event.target == agentModal) {
                closeCreateAgentModal();
            }
            if (event.target == workflowModal) {
                closeCreateWorkflowModal();
            }
        }
    </script>
    
    <!-- æ‰¹é‡åˆ é™¤åŠŸèƒ½ -->
    <script src="{{ url_for('static', filename='js/batch-operations.js') }}"></script>
</body>
</html>
