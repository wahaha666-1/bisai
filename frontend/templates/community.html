<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¤¾åŒºå¹¿åœº - AgentFlow</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .navbar {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            padding: 16px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 20px rgba(0,0,0,0.08);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .nav-menu {
            display: flex;
            gap: 24px;
            align-items: center;
        }
        
        .nav-item {
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            color: #666;
        }
        
        .nav-item:hover {
            background: #f5f5f5;
            color: #667eea;
        }
        
        .nav-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        /* ä¸»å®¹å™¨ */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 32px;
        }
        
        /* å¤´éƒ¨ */
        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            padding: 48px;
            margin-bottom: 32px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 36px;
            margin-bottom: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header-subtitle {
            font-size: 18px;
            color: #666;
            margin-bottom: 24px;
        }
        
        .update-time {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #f5f5f5;
            border-radius: 20px;
            font-size: 14px;
            color: #999;
        }
        
        /* åˆ†ç±»æ ‡ç­¾ */
        .category-tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 32px;
            flex-wrap: wrap;
        }
        
        .category-tab {
            padding: 12px 24px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            color: #666;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .category-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.12);
        }
        
        .category-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: white;
        }
        
        /* åŒºåŸŸ */
        .section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .section-title {
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        /* ç½‘æ ¼ */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }
        
        /* Agentå¡ç‰‡ */
        .agent-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            border: 2px solid #f0f0f0;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }
        
        .agent-card:hover {
            border-color: #667eea;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.15);
            transform: translateY(-4px);
        }
        
        .hot-badge {
            position: absolute;
            top: 16px;
            right: 16px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .new-badge {
            position: absolute;
            top: 16px;
            right: 16px;
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .source-badge {
            position: absolute;
            bottom: 16px;
            right: 16px;
            background: #f5f5f5;
            color: #666;
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
            border: 1px solid #e0e0e0;
        }
        
        .source-badge.external {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            color: white;
            border: none;
        }
        
        .source-badge.local {
            background: #667eea;
            color: white;
            border: none;
        }
        
        .agent-header {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .agent-icon {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            flex-shrink: 0;
        }
        
        .agent-info {
            flex: 1;
        }
        
        .agent-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #333;
        }
        
        .agent-author {
            font-size: 13px;
            color: #999;
        }
        
        .agent-desc {
            font-size: 14px;
            color: #666;
            line-height: 1.6;
            margin-bottom: 16px;
        }
        
        .agent-stats {
            display: flex;
            gap: 16px;
            padding-top: 16px;
            border-top: 1px solid #f0f0f0;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #999;
        }
        
        .stat-value {
            font-weight: 600;
            color: #667eea;
        }
        
        /* å·¥ä½œæµå¡ç‰‡ */
        .workflow-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            border: 2px solid #f0f0f0;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }
        
        .workflow-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px 16px 0 0;
        }
        
        .workflow-card:hover {
            border-color: #667eea;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.15);
            transform: translateY(-4px);
        }
        
        .workflow-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        
        .workflow-desc {
            font-size: 14px;
            color: #666;
            margin-bottom: 12px;
            line-height: 1.6;
        }
        
        .workflow-agents {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }
        
        .agent-tag {
            padding: 4px 12px;
            background: #f5f5f5;
            border-radius: 12px;
            font-size: 12px;
            color: #666;
        }
        
        /* æŒ‰é’® */
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        /* è¯¦æƒ…æ¨¡æ€æ¡† */
        .detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s;
        }
        
        .detail-modal.active {
            display: flex;
        }
        
        .detail-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .detail-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .detail-icon {
            font-size: 48px;
        }
        
        .detail-title {
            flex: 1;
        }
        
        .detail-name {
            font-size: 24px;
            font-weight: 700;
            color: #333;
            margin-bottom: 4px;
        }
        
        .detail-author {
            font-size: 14px;
            color: #999;
        }
        
        .detail-section {
            margin-bottom: 20px;
        }
        
        .detail-section-title {
            font-size: 14px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .detail-section-content {
            font-size: 15px;
            line-height: 1.6;
            color: #666;
        }
        
        .detail-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .detail-stat-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        
        .detail-stat-label {
            font-size: 12px;
            color: #999;
            margin-bottom: 4px;
        }
        
        .detail-stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #333;
        }
        
        .detail-agents-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .detail-agent-tag {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
        }
        
        .detail-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }
        
        .btn-action {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary-action {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary-action {
            background: #f0f0f0;
            color: #666;
        }
        
        .btn-secondary-action:hover {
            background: #e0e0e0;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="logo">
            <span>ğŸ¤–</span>
            <span>AgentFlow</span>
        </div>
        <div class="nav-menu">
            <div class="nav-item" onclick="window.location.href='/'">å·¥ä½œå°</div>
            <div class="nav-item" onclick="window.location.href='/chat'">AIåŠ©æ‰‹</div>
            <div class="nav-item active">ç¤¾åŒºå¹¿åœº</div>
            <div class="nav-item" onclick="window.location.href='/workflow-editor'">å¯è§†åŒ–ç¼–è¾‘</div>
        </div>
    </nav>

    <!-- ä¸»å®¹å™¨ -->
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸŒŸ ç¤¾åŒºå¹¿åœº</h1>
            <p class="header-subtitle">å‘ç°ä¼˜è´¨Agentå’Œå·¥ä½œæµï¼Œæ¯å‘¨ç²¾é€‰æ›´æ–°</p>
            <div class="update-time">
                <span>ğŸ“…</span>
                <span>æœ¬å‘¨æ›´æ–°æ—¶é—´ï¼š2025å¹´11æœˆ3æ—¥</span>
            </div>
        </div>

        <!-- åˆ†ç±»æ ‡ç­¾ -->
        <div class="category-tabs">
            <div class="category-tab active" onclick="filterCategory('all')">ğŸ”¥ å…¨éƒ¨</div>
            <div class="category-tab" onclick="filterCategory('hot')">ğŸ† æœ¬å‘¨çƒ­é—¨</div>
            <div class="category-tab" onclick="filterCategory('new')">âœ¨ æœ€æ–°å‘å¸ƒ</div>
            <div class="category-tab" onclick="filterCategory('workflow')">ğŸ”„ å·¥ä½œæµ</div>
            <div class="category-tab" onclick="filterCategory('agent')">ğŸ¤– Agent</div>
        </div>

        <!-- æœ¬å‘¨çƒ­é—¨Agent -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">
                    <span>ğŸ”¥</span>
                    <span>æœ¬å‘¨çƒ­é—¨ Agent</span>
                </div>
            </div>
            
            <div class="grid" id="agents-grid">
                <!-- åŠ¨æ€åŠ è½½ä¸­ -->
                <div class="empty-state">
                    <div class="empty-state-icon">â³</div>
                    <div class="empty-state-text">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>

        <!-- ç²¾é€‰å·¥ä½œæµ -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">
                    <span>â­</span>
                    <span>ç²¾é€‰å·¥ä½œæµ</span>
                </div>
            </div>
            
            <div class="grid" id="workflows-grid">
                <!-- åŠ¨æ€åŠ è½½ä¸­ -->
                <div class="empty-state">
                    <div class="empty-state-icon">â³</div>
                    <div class="empty-state-text">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Agentè¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="detail-modal" id="agentDetailModal" onclick="closeDetailModal(event, 'agentDetailModal')">
        <div class="detail-content" onclick="event.stopPropagation()">
            <div class="detail-header">
                <div class="detail-icon" id="agentDetailIcon">ğŸ¤–</div>
                <div class="detail-title">
                    <div class="detail-name" id="agentDetailName">Agentåç§°</div>
                    <div class="detail-author" id="agentDetailAuthor">by @ç”¨æˆ·</div>
                </div>
            </div>
            
            <div class="detail-stats" id="agentDetailStats">
                <div class="detail-stat-item">
                    <div class="detail-stat-label">è¯„åˆ†</div>
                    <div class="detail-stat-value">â­ 4.8</div>
                </div>
                <div class="detail-stat-item">
                    <div class="detail-stat-label">ä½¿ç”¨æ¬¡æ•°</div>
                    <div class="detail-stat-value">1,234</div>
                </div>
                <div class="detail-stat-item">
                    <div class="detail-stat-label">æ”¶è—</div>
                    <div class="detail-stat-value">â¤ï¸ 567</div>
                </div>
            </div>
            
            <div class="detail-section">
                <div class="detail-section-title">ğŸ“ æè¿°</div>
                <div class="detail-section-content" id="agentDetailDesc">Agentæè¿°ä¿¡æ¯...</div>
            </div>
            
            <div class="detail-actions">
                <button class="btn-action btn-primary-action" id="agentCopyBtn" onclick="copyAgentToWorkspace()">
                    ğŸ“‹ å¤åˆ¶åˆ°å·¥ä½œå°
                </button>
                <button class="btn-action btn-secondary-action" onclick="closeDetailModal(null, 'agentDetailModal')">
                    âœ–ï¸ å…³é—­
                </button>
            </div>
        </div>
    </div>

    <!-- è‡ªå®šä¹‰ç¡®è®¤/æç¤ºæ¨¡æ€æ¡† -->
    <div class="detail-modal" id="customConfirmModal" style="z-index: 10001;">
        <div class="detail-content" style="max-width: 600px;" onclick="event.stopPropagation()">
            <div class="detail-header" style="border-bottom: 2px solid #667eea;">
                <div class="detail-icon" id="confirmIcon">ğŸ’¡</div>
                <div class="detail-title">
                    <div class="detail-name" id="confirmTitle">æç¤º</div>
                </div>
            </div>
            
            <div class="detail-section">
                <div class="detail-section-content" id="confirmMessage" style="font-size: 15px; line-height: 1.8; white-space: pre-wrap;">
                    æ¶ˆæ¯å†…å®¹...
                </div>
            </div>
            
            <div class="detail-actions" id="confirmActions">
                <button class="btn-action btn-primary-action" id="confirmOkBtn">
                    âœ“ ç¡®å®š
                </button>
                <button class="btn-action btn-secondary-action" id="confirmCancelBtn">
                    âœ– å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>

    <!-- å·¥ä½œæµè¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="detail-modal" id="workflowDetailModal" onclick="closeDetailModal(event, 'workflowDetailModal')">
        <div class="detail-content" onclick="event.stopPropagation()">
            <div class="detail-header">
                <div class="detail-icon">ğŸ”„</div>
                <div class="detail-title">
                    <div class="detail-name" id="workflowDetailName">å·¥ä½œæµåç§°</div>
                </div>
            </div>
            
            <div class="detail-stats" id="workflowDetailStats">
                <div class="detail-stat-item">
                    <div class="detail-stat-label">æ‰§è¡Œæ¬¡æ•°</div>
                    <div class="detail-stat-value">âš¡ 234</div>
                </div>
                <div class="detail-stat-item">
                    <div class="detail-stat-label">æˆåŠŸç‡</div>
                    <div class="detail-stat-value">âœ… 96%</div>
                </div>
                <div class="detail-stat-item">
                    <div class="detail-stat-label">æ”¶è—</div>
                    <div class="detail-stat-value">â¤ï¸ 123</div>
                </div>
            </div>
            
            <div class="detail-section">
                <div class="detail-section-title">ğŸ“ æè¿°</div>
                <div class="detail-section-content" id="workflowDetailDesc">å·¥ä½œæµæè¿°ä¿¡æ¯...</div>
            </div>
            
            <div class="detail-section">
                <div class="detail-section-title">ğŸ¤– åŒ…å«çš„Agent</div>
                <div class="detail-agents-list" id="workflowDetailAgents">
                    <div class="detail-agent-tag">Agent 1</div>
                    <div class="detail-agent-tag">Agent 2</div>
                </div>
            </div>
            
            <!-- å·¥ä½œæµå¯è§†åŒ– -->
            <div class="detail-section" id="workflowVisualizationSection">
                <div class="detail-section-title">ğŸ“Š å·¥ä½œæµå¯è§†åŒ–</div>
                <div id="workflowVisualization" style="background: #f8f9fa; padding: 20px; border-radius: 8px; min-height: 200px;">
                    <!-- æµç¨‹å›¾å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
            
            <div class="detail-actions">
                <button class="btn-action btn-primary-action" id="workflowExecuteBtn" onclick="executeWorkflowFromModal()">
                    âš¡ ç«‹å³æ‰§è¡Œ
                </button>
                <button class="btn-action btn-secondary-action" id="workflowCopyBtn" onclick="copyWorkflowAsTemplate()" style="display: none;">
                    ğŸ“‹ å¤åˆ¶ä¸ºæ¨¡æ¿
                </button>
                <button class="btn-action btn-secondary-action" onclick="closeDetailModal(null, 'workflowDetailModal')">
                    âœ–ï¸ å…³é—­
                </button>
            </div>
        </div>
    </div>

    <script>
        let allAgents = [];
        let allWorkflows = [];
        let currentCategory = 'all';
        let currentAgentId = null;
        let currentWorkflowId = null;
        let currentWorkflowName = null;
        
        // è‡ªå®šä¹‰ç¡®è®¤æ¡†
        function showCustomConfirm(options) {
            return new Promise((resolve) => {
                const modal = document.getElementById('customConfirmModal');
                const icon = document.getElementById('confirmIcon');
                const title = document.getElementById('confirmTitle');
                const message = document.getElementById('confirmMessage');
                const okBtn = document.getElementById('confirmOkBtn');
                const cancelBtn = document.getElementById('confirmCancelBtn');
                
                // è®¾ç½®å†…å®¹
                icon.textContent = options.icon || 'ğŸ’¡';
                title.textContent = options.title || 'æç¤º';
                message.textContent = options.message || '';
                okBtn.textContent = options.okText || 'âœ“ ç¡®å®š';
                cancelBtn.textContent = options.cancelText || 'âœ– å–æ¶ˆ';
                
                // å¦‚æœåªæ˜¯æç¤ºï¼ˆæ²¡æœ‰å–æ¶ˆæŒ‰é’®ï¼‰
                if (options.type === 'alert') {
                    cancelBtn.style.display = 'none';
                } else {
                    cancelBtn.style.display = 'block';
                }
                
                // äº‹ä»¶å¤„ç†
                const handleOk = () => {
                    modal.classList.remove('active');
                    okBtn.removeEventListener('click', handleOk);
                    cancelBtn.removeEventListener('click', handleCancel);
                    resolve(true);
                };
                
                const handleCancel = () => {
                    modal.classList.remove('active');
                    okBtn.removeEventListener('click', handleOk);
                    cancelBtn.removeEventListener('click', handleCancel);
                    resolve(false);
                };
                
                okBtn.addEventListener('click', handleOk);
                cancelBtn.addEventListener('click', handleCancel);
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                modal.classList.add('active');
            });
        }
        
        // ç®€åŒ–çš„æç¤ºå‡½æ•°
        async function customAlert(message, title = 'æç¤º', icon = 'ğŸ’¡') {
            return await showCustomConfirm({
                type: 'alert',
                icon: icon,
                title: title,
                message: message,
                okText: 'âœ“ çŸ¥é“äº†'
            });
        }
        
        // ç®€åŒ–çš„ç¡®è®¤å‡½æ•°
        async function customConfirm(message, title = 'ç¡®è®¤', icon = 'â“') {
            return await showCustomConfirm({
                type: 'confirm',
                icon: icon,
                title: title,
                message: message,
                okText: 'âœ“ ç¡®å®š',
                cancelText: 'âœ– å–æ¶ˆ'
            });
        }

        // é¡µé¢åŠ è½½æ—¶ä»æ•°æ®åº“è·å–çœŸå®æ•°æ®
        async function loadCommunityData() {
            console.log('[ç¤¾åŒºå¹¿åœº] å¼€å§‹åŠ è½½æ•°æ®...');
            
            try {
                // ä½¿ç”¨æ–°çš„ç»„åˆAPIï¼ˆæœ¬åœ°+å¤–éƒ¨ï¼‰
                console.log('[ç¤¾åŒºå¹¿åœº] æ­£åœ¨è·å–æ•°æ®ï¼ˆæœ¬åœ°+å¤–éƒ¨ï¼‰...');
                const response = await fetch('/api/community/data?include_external=true&use_mock=true');
                const combinedData = await response.json();
                
                console.log('[ç¤¾åŒºå¹¿åœº] è·å–åˆ°æ•°æ®:', combinedData);
                
                // æå–æœ¬åœ°å’Œå¤–éƒ¨æ•°æ®
                const localAgents = combinedData.local?.agents || [];
                const localWorkflows = combinedData.local?.workflows || [];
                const externalAgents = combinedData.external?.agents || [];
                const externalWorkflows = combinedData.external?.workflows || [];
                
                console.log('[ç¤¾åŒºå¹¿åœº] æœ¬åœ°Agents:', localAgents.length, 'ä¸ª');
                console.log('[ç¤¾åŒºå¹¿åœº] å¤–éƒ¨Agents:', externalAgents.length, 'ä¸ª');
                console.log('[ç¤¾åŒºå¹¿åœº] æœ¬åœ°å·¥ä½œæµ:', localWorkflows.length, 'ä¸ª');
                console.log('[ç¤¾åŒºå¹¿åœº] å¤–éƒ¨å·¥ä½œæµ:', externalWorkflows.length, 'ä¸ª');
                
                // è½¬æ¢ä¸ºç¤¾åŒºå±•ç¤ºæ ¼å¼
                console.log('[ç¤¾åŒºå¹¿åœº] å¼€å§‹è½¬æ¢æ•°æ®æ ¼å¼...');
                
                // å¤„ç†æœ¬åœ°Agents
                const localAgentsMapped = localAgents.map(agent => ({
                    id: agent.id,
                    name: agent.name,
                    icon: agent.icon || 'ğŸ¤–',
                    author: 'AgentFlowç”¨æˆ·',
                    description: agent.description || 'æš‚æ— æè¿°',
                    rating: 4.5 + Math.random() * 0.4,
                    usageCount: agent.total_executions || 0,
                    likeCount: Math.floor((agent.total_executions || 0) * 0.3),
                    isHot: (agent.total_executions || 0) > 10,
                    isNew: isNewAgent(agent.created_date),
                    source: 'æœ¬åœ°',
                    isExternal: false,
                    type: 'agent'
                }));
                
                // å¤„ç†å¤–éƒ¨Agentsï¼ˆå·²ç»æ˜¯æ­£ç¡®æ ¼å¼ï¼‰
                const externalAgentsMapped = externalAgents.map(agent => ({
                    ...agent,
                    isExternal: true,
                    source: agent.source || 'å¤–éƒ¨'
                }));
                
                // åˆå¹¶Agents
                allAgents = [...localAgentsMapped, ...externalAgentsMapped];
                
                // å¤„ç†æœ¬åœ°å·¥ä½œæµ
                const localWorkflowsMapped = localWorkflows.map(workflow => ({
                    id: workflow.id,
                    name: workflow.name,
                    description: workflow.description || 'æš‚æ— æè¿°',
                    agents: extractAgentNames(workflow.workflow_definition),
                    executionCount: workflow.total_executions || 0,
                    successRate: workflow.success_rate || 0,
                    likeCount: Math.floor((workflow.total_executions || 0) * 0.4),
                    isHot: (workflow.total_executions || 0) > 5,
                    isNew: isNewWorkflow(workflow.created_at),
                    source: 'æœ¬åœ°',
                    isExternal: false,
                    type: 'workflow'
                }));
                
                // å¤„ç†å¤–éƒ¨å·¥ä½œæµ
                const externalWorkflowsMapped = externalWorkflows.map(workflow => ({
                    ...workflow,
                    isExternal: true,
                    source: workflow.source || 'å¤–éƒ¨'
                }));
                
                // åˆå¹¶å·¥ä½œæµ
                allWorkflows = [...localWorkflowsMapped, ...externalWorkflowsMapped];
                
                console.log('[ç¤¾åŒºå¹¿åœº] è½¬æ¢å®Œæˆï¼ŒAgents:', allAgents.length, 'ä¸ªï¼Œå·¥ä½œæµ:', allWorkflows.length, 'ä¸ª');
                
                // åˆæ¬¡æ¸²æŸ“
                console.log('[ç¤¾åŒºå¹¿åœº] å¼€å§‹æ¸²æŸ“ç•Œé¢...');
                renderCommunity();
                console.log('[ç¤¾åŒºå¹¿åœº] âœ… åŠ è½½å®Œæˆï¼');
            } catch (error) {
                console.error('[ç¤¾åŒºå¹¿åœº] âŒ åŠ è½½å¤±è´¥:', error);
            }
        }

        // åˆ¤æ–­æ˜¯å¦æ˜¯æ–°Agentï¼ˆ7å¤©å†…åˆ›å»ºï¼‰
        function isNewAgent(dateStr) {
            if (!dateStr) return false;
            const created = new Date(dateStr);
            const now = new Date();
            const diffDays = (now - created) / (1000 * 60 * 60 * 24);
            return diffDays <= 7;
        }

        // åˆ¤æ–­æ˜¯å¦æ˜¯æ–°å·¥ä½œæµ
        function isNewWorkflow(dateStr) {
            if (!dateStr) return false;
            const created = new Date(dateStr);
            const now = new Date();
            const diffDays = (now - created) / (1000 * 60 * 60 * 24);
            return diffDays <= 7;
        }

        // ä»å·¥ä½œæµå®šä¹‰ä¸­æå–Agentåç§°
        function extractAgentNames(definition) {
            if (!definition) return [];
            try {
                const def = typeof definition === 'string' ? JSON.parse(definition) : definition;
                return def.agents || [];
            } catch {
                return [];
            }
        }

        // æ¸²æŸ“ç¤¾åŒºå†…å®¹
        function renderCommunity() {
            let displayAgents = [...allAgents];
            let displayWorkflows = [...allWorkflows];
            
            // æ ¹æ®åˆ†ç±»ç­›é€‰
            if (currentCategory === 'hot') {
                displayAgents = allAgents.filter(a => a.isHot);
                displayWorkflows = allWorkflows.filter(w => w.isHot);
            } else if (currentCategory === 'new') {
                displayAgents = allAgents.filter(a => a.isNew);
                displayWorkflows = allWorkflows.filter(w => w.isNew);
            } else if (currentCategory === 'agent') {
                displayWorkflows = [];
            } else if (currentCategory === 'workflow') {
                displayAgents = [];
            }
            
            // æ¸²æŸ“Agents
            renderAgents(displayAgents);
            
            // æ¸²æŸ“å·¥ä½œæµ
            renderWorkflows(displayWorkflows);
        }

        // æ¸²æŸ“Agentå¡ç‰‡
        function renderAgents(agents) {
            console.log('[æ¸²æŸ“] æ¸²æŸ“Agents:', agents.length, 'ä¸ª');
            const agentSection = document.getElementById('agents-grid');
            
            if (!agentSection) {
                console.error('[æ¸²æŸ“] âŒ æ‰¾ä¸åˆ°agents-gridå…ƒç´ ï¼');
                return;
            }
            
            if (agents.length === 0) {
                console.log('[æ¸²æŸ“] æ— Agentï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€');
                agentSection.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“¦</div><div class="empty-state-text">æš‚æ— Agent</div></div>';
                return;
            }
            
            agentSection.innerHTML = agents.map(agent => `
                <div class="agent-card" onclick="showAgentDetail('${agent.id}')">
                    ${agent.isHot ? '<div class="hot-badge">ğŸ”¥ çƒ­é—¨</div>' : ''}
                    ${agent.isNew ? '<div class="new-badge">âœ¨ æ–°</div>' : ''}
                    <div class="source-badge ${agent.isExternal ? 'external' : 'local'}">${agent.source || 'æœ¬åœ°'}</div>
                    <div class="agent-header">
                        <div class="agent-icon">${agent.icon}</div>
                        <div class="agent-info">
                            <div class="agent-name">${agent.name}</div>
                            <div class="agent-author">by @${agent.author}</div>
                        </div>
                    </div>
                    <div class="agent-desc">${agent.description}</div>
                    <div class="agent-stats">
                        <div class="stat-item">
                            <span>â­</span>
                            <span class="stat-value">${agent.rating.toFixed(1)}</span>
                        </div>
                        <div class="stat-item">
                            <span>ğŸ’¬</span>
                            <span class="stat-value">${agent.usageCount.toLocaleString()}</span>
                            <span>ä½¿ç”¨</span>
                        </div>
                        <div class="stat-item">
                            <span>â¤ï¸</span>
                            <span class="stat-value">${agent.likeCount.toLocaleString()}</span>
                        </div>
                    </div>
                </div>
            `).join('');
            console.log('[æ¸²æŸ“] âœ… Agentsæ¸²æŸ“å®Œæˆ');
        }

        // æ¸²æŸ“å·¥ä½œæµå¡ç‰‡
        function renderWorkflows(workflows) {
            console.log('[æ¸²æŸ“] æ¸²æŸ“å·¥ä½œæµ:', workflows.length, 'ä¸ª');
            const workflowSection = document.getElementById('workflows-grid');
            
            if (!workflowSection) {
                console.error('[æ¸²æŸ“] âŒ æ‰¾ä¸åˆ°workflows-gridå…ƒç´ ï¼');
                return;
            }
            
            if (workflows.length === 0) {
                console.log('[æ¸²æŸ“] æ— å·¥ä½œæµï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€');
                workflowSection.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ”„</div><div class="empty-state-text">æš‚æ— å·¥ä½œæµ</div></div>';
                return;
            }
            
            workflowSection.innerHTML = workflows.map(workflow => `
                <div class="workflow-card" onclick="showWorkflowDetail('${workflow.id}')">
                    ${workflow.isHot ? '<div class="hot-badge">ğŸ”¥ çƒ­é—¨</div>' : ''}
                    ${workflow.isNew ? '<div class="new-badge">âœ¨ æ–°</div>' : ''}
                    <div class="source-badge ${workflow.isExternal ? 'external' : 'local'}">${workflow.source || 'æœ¬åœ°'}</div>
                    <div class="workflow-name">${workflow.name}</div>
                    <div class="workflow-desc">${workflow.description}</div>
                    <div class="workflow-agents">
                        ${workflow.agents.slice(0, 4).map(agent => 
                            `<div class="agent-tag">${agent}</div>`
                        ).join('')}
                        ${workflow.agents.length > 4 ? `<div class="agent-tag">+${workflow.agents.length - 4}</div>` : ''}
                    </div>
                    <div class="agent-stats">
                        <div class="stat-item">
                            <span>âš¡</span>
                            <span class="stat-value">${workflow.executionCount.toLocaleString()}</span>
                            <span>æ¬¡æ‰§è¡Œ</span>
                        </div>
                        <div class="stat-item">
                            <span>âœ…</span>
                            <span class="stat-value">${workflow.successRate.toFixed(1)}%</span>
                            <span>æˆåŠŸç‡</span>
                        </div>
                        <div class="stat-item">
                            <span>â¤ï¸</span>
                            <span class="stat-value">${workflow.likeCount.toLocaleString()}</span>
                        </div>
                    </div>
                </div>
            `).join('');
            console.log('[æ¸²æŸ“] âœ… å·¥ä½œæµæ¸²æŸ“å®Œæˆ');
        }

        // åˆ†ç±»ç­›é€‰
        function filterCategory(category) {
            console.log('[ç­›é€‰] åˆ‡æ¢åˆ†ç±»:', category);
            currentCategory = category;
            
            // æ›´æ–°æ ‡ç­¾çŠ¶æ€
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // é‡æ–°æ¸²æŸ“
            console.log('[ç­›é€‰] é‡æ–°æ¸²æŸ“...');
            renderCommunity();
        }

        // æ˜¾ç¤ºAgentè¯¦æƒ…
        function showAgentDetail(agentId) {
            console.log('[ç‚¹å‡»] Agent ID:', agentId, 'Type:', typeof agentId);
            // æ”¯æŒæ•°å­—å’Œå­—ç¬¦ä¸²ID
            const agent = allAgents.find(a => String(a.id) === String(agentId));
            if (!agent) {
                console.error('[ç‚¹å‡»] æ‰¾ä¸åˆ°Agent:', agentId);
                console.log('[ç‚¹å‡»] å¯ç”¨çš„Agents:', allAgents.map(a => ({id: a.id, name: a.name})));
                return;
            }
            console.log('[ç‚¹å‡»] æ˜¾ç¤ºAgentè¯¦æƒ…:', agent.name);
            
            // ä¿å­˜å½“å‰Agent ID
            currentAgentId = agentId;
            
            // å¡«å……æ¨¡æ€æ¡†æ•°æ®
            document.getElementById('agentDetailIcon').textContent = agent.icon;
            document.getElementById('agentDetailName').textContent = agent.name;
            document.getElementById('agentDetailAuthor').textContent = `by @${agent.author}`;
            document.getElementById('agentDetailDesc').textContent = agent.description;
            
            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            const statsHtml = `
                <div class="detail-stat-item">
                    <div class="detail-stat-label">è¯„åˆ†</div>
                    <div class="detail-stat-value">â­ ${agent.rating.toFixed(1)}</div>
                </div>
                <div class="detail-stat-item">
                    <div class="detail-stat-label">ä½¿ç”¨æ¬¡æ•°</div>
                    <div class="detail-stat-value">${agent.usageCount.toLocaleString()}</div>
                </div>
                <div class="detail-stat-item">
                    <div class="detail-stat-label">æ”¶è—</div>
                    <div class="detail-stat-value">â¤ï¸ ${agent.likeCount.toLocaleString()}</div>
                </div>
            `;
            document.getElementById('agentDetailStats').innerHTML = statsHtml;
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('agentDetailModal').classList.add('active');
        }

        // æ˜¾ç¤ºå·¥ä½œæµè¯¦æƒ…
        function showWorkflowDetail(workflowId) {
            console.log('[ç‚¹å‡»] å·¥ä½œæµ ID:', workflowId, 'Type:', typeof workflowId);
            // æ”¯æŒæ•°å­—å’Œå­—ç¬¦ä¸²ID
            const workflow = allWorkflows.find(w => String(w.id) === String(workflowId));
            if (!workflow) {
                console.error('[ç‚¹å‡»] æ‰¾ä¸åˆ°å·¥ä½œæµ:', workflowId);
                console.log('[ç‚¹å‡»] å¯ç”¨çš„å·¥ä½œæµ:', allWorkflows.map(w => ({id: w.id, name: w.name})));
                return;
            }
            console.log('[ç‚¹å‡»] æ˜¾ç¤ºå·¥ä½œæµè¯¦æƒ…:', workflow.name, 'æ˜¯å¦å¤–éƒ¨:', workflow.isExternal);
            
            // ä¿å­˜å½“å‰å·¥ä½œæµä¿¡æ¯
            currentWorkflowId = workflowId;
            currentWorkflowName = workflow.name;
            
            // å¡«å……æ¨¡æ€æ¡†æ•°æ®
            document.getElementById('workflowDetailName').textContent = workflow.name;
            document.getElementById('workflowDetailDesc').textContent = workflow.description;
            
            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            const statsHtml = `
                <div class="detail-stat-item">
                    <div class="detail-stat-label">æ‰§è¡Œæ¬¡æ•°</div>
                    <div class="detail-stat-value">âš¡ ${workflow.executionCount.toLocaleString()}</div>
                </div>
                <div class="detail-stat-item">
                    <div class="detail-stat-label">æˆåŠŸç‡</div>
                    <div class="detail-stat-value">âœ… ${workflow.successRate.toFixed(1)}%</div>
                </div>
                <div class="detail-stat-item">
                    <div class="detail-stat-label">æ”¶è—</div>
                    <div class="detail-stat-value">â¤ï¸ ${workflow.likeCount.toLocaleString()}</div>
                </div>
            `;
            document.getElementById('workflowDetailStats').innerHTML = statsHtml;
            
            // æ›´æ–°Agentåˆ—è¡¨
            const agentsHtml = workflow.agents.map(agent => 
                `<div class="detail-agent-tag">${agent}</div>`
            ).join('');
            document.getElementById('workflowDetailAgents').innerHTML = agentsHtml || '<div class="detail-section-content">æš‚æ— Agentä¿¡æ¯</div>';
            
            // ç”Ÿæˆå·¥ä½œæµå¯è§†åŒ–
            renderWorkflowVisualization(workflow);
            
            // å¦‚æœæ˜¯å¤–éƒ¨å·¥ä½œæµï¼Œæ˜¾ç¤º"å¤åˆ¶ä¸ºæ¨¡æ¿"æŒ‰é’®
            const copyBtn = document.getElementById('workflowCopyBtn');
            const executeBtn = document.getElementById('workflowExecuteBtn');
            if (workflow.isExternal) {
                copyBtn.style.display = 'block';
                executeBtn.textContent = 'ğŸ’¡ æŸ¥çœ‹è¯¦æƒ…';
            } else {
                copyBtn.style.display = 'none';
                executeBtn.textContent = 'âš¡ ç«‹å³æ‰§è¡Œ';
            }
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('workflowDetailModal').classList.add('active');
        }
        
        // æ¸²æŸ“å·¥ä½œæµå¯è§†åŒ–
        function renderWorkflowVisualization(workflow) {
            const container = document.getElementById('workflowVisualization');
            
            // åˆ›å»ºç®€å•çš„æµç¨‹å›¾
            let html = '<div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px;">';
            
            // è¾“å…¥èŠ‚ç‚¹
            html += `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 20px; border-radius: 8px; font-weight: 600; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    ğŸ“¥ è¾“å…¥
                </div>
                <div style="font-size: 24px; color: #667eea;">â†’</div>
            `;
            
            // AgentèŠ‚ç‚¹
            workflow.agents.forEach((agent, index) => {
                html += `
                    <div style="background: white; border: 2px solid #667eea; color: #667eea; padding: 12px 20px; border-radius: 8px; font-weight: 600; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        ${agent}
                    </div>
                `;
                
                if (index < workflow.agents.length - 1) {
                    html += '<div style="font-size: 24px; color: #667eea;">â†’</div>';
                }
            });
            
            // è¾“å‡ºèŠ‚ç‚¹
            html += `
                <div style="font-size: 24px; color: #667eea;">â†’</div>
                <div style="background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%); color: white; padding: 12px 20px; border-radius: 8px; font-weight: 600; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    ğŸ“¤ è¾“å‡º
                </div>
            `;
            
            html += '</div>';
            
            // æ·»åŠ è¯´æ˜
            html += `
                <div style="margin-top: 16px; padding: 12px; background: white; border-radius: 6px; border-left: 4px solid #667eea;">
                    <div style="font-size: 13px; color: #666; line-height: 1.6;">
                        <strong style="color: #667eea;">æµç¨‹è¯´æ˜ï¼š</strong><br>
                        ${workflow.description || 'æ­¤å·¥ä½œæµæŒ‰é¡ºåºæ‰§è¡Œä¸Šè¿°Agentï¼Œæ¯ä¸ªAgentçš„è¾“å‡ºå°†ä½œä¸ºä¸‹ä¸€ä¸ªAgentçš„è¾“å…¥ã€‚'}
                    </div>
                </div>
            `;
            
            // å¦‚æœæ˜¯å¤–éƒ¨å·¥ä½œæµï¼Œæ·»åŠ æç¤º
            if (workflow.isExternal) {
                html += `
                    <div style="margin-top: 12px; padding: 12px; background: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107;">
                        <div style="font-size: 13px; color: #856404; line-height: 1.6;">
                            <strong>ğŸ’¡ æç¤ºï¼š</strong> è¿™æ˜¯æ¥è‡ª <strong>${workflow.source}</strong> çš„å¤–éƒ¨å·¥ä½œæµã€‚<br>
                            æ‚¨å¯ä»¥ç‚¹å‡»"ğŸ“‹ å¤åˆ¶ä¸ºæ¨¡æ¿"åˆ›å»ºç±»ä¼¼çš„å·¥ä½œæµï¼Œæˆ–ä½¿ç”¨AIå¯¹è¯æè¿°æ‚¨çš„éœ€æ±‚ã€‚
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeDetailModal(event, modalId) {
            if (event) event.stopPropagation();
            document.getElementById(modalId).classList.remove('active');
        }

        // å¤åˆ¶Agentåˆ°å·¥ä½œå°ï¼ˆä»æ¨¡æ€æ¡†è°ƒç”¨ï¼‰
        async function copyAgentToWorkspace() {
            console.log('[å¤åˆ¶] å¤åˆ¶Agent ID:', currentAgentId);
            
            // ä¿®å¤ï¼šä½¿ç”¨å­—ç¬¦ä¸²æ¯”è¾ƒ
            const agent = allAgents.find(a => String(a.id) === String(currentAgentId));
            if (!agent) {
                console.error('[å¤åˆ¶] æ‰¾ä¸åˆ°Agent:', currentAgentId);
                alert('âŒ æ‰¾ä¸åˆ°Agentä¿¡æ¯');
                closeDetailModal(null, 'agentDetailModal');
                return;
            }
            
            console.log('[å¤åˆ¶] æ‰¾åˆ°Agent:', agent.name, 'æ˜¯å¦å¤–éƒ¨:', agent.isExternal);
            
            // å¦‚æœæ˜¯å¤–éƒ¨Agentï¼Œæ˜¾ç¤ºæç¤ºå¹¶ç»™å‡ºé€‰é¡¹
            if (agent.isExternal) {
                closeDetailModal(null, 'agentDetailModal');
                
                // æ„å»ºè¯¦ç»†çš„æ¨¡æ¿æè¿°ï¼ˆåŒ…å«ä»£ç æ¨¡æ¿ï¼‰
                const templateDesc = `è¯·å¸®æˆ‘åˆ›å»ºä¸€ä¸ªAgentï¼Œç±»ä¼¼äº"${agent.name}"

ã€Agentä¿¡æ¯ã€‘
åç§°ï¼š${agent.name}
æ¥æºï¼š${agent.source}
å›¾æ ‡ï¼š${agent.icon}

ã€åŠŸèƒ½æè¿°ã€‘
${agent.description}

ã€å‚è€ƒæ•°æ®ã€‘
â€¢ ä½¿ç”¨æ¬¡æ•°ï¼š${agent.usageCount.toLocaleString()}æ¬¡
â€¢ ç”¨æˆ·è¯„åˆ†ï¼š${agent.rating.toFixed(1)}/5.0

ã€è¦æ±‚ã€‘
è¯·ç”Ÿæˆå®Œæ•´çš„Pythonä»£ç ï¼ŒåŒ…æ‹¬ï¼š
1. å‡½æ•°å®šä¹‰ï¼ˆå¸¦ç±»å‹æ³¨è§£ï¼‰
2. å®Œæ•´çš„åŠŸèƒ½å®ç°
3. é”™è¯¯å¤„ç†
4. è¿”å›JSONæ ¼å¼çš„ç»“æœ

ä»£ç æ ¼å¼ç¤ºä¾‹ï¼š
\`\`\`python
def ${agent.name.toLowerCase().replace(/\s+/g, '_')}_agent(å‚æ•°1: str, å‚æ•°2: int) -> dict:
    """
    ${agent.description}
    
    Args:
        å‚æ•°1: å‚æ•°è¯´æ˜
        å‚æ•°2: å‚æ•°è¯´æ˜
    
    Returns:
        dict: åŒ…å«ç»“æœçš„å­—å…¸
    """
    try:
        # å®ç°åŠŸèƒ½é€»è¾‘
        result = {}
        
        return {
            "status": "success",
            "data": result
        }
    except Exception as e:
        return {
            "status": "error",
            "message": str(e)
        }
\`\`\`

è¯·æ ¹æ®ä¸Šè¿°æè¿°ç”Ÿæˆå®Œæ•´ä»£ç ã€‚`;

                const message = `ğŸ“‹ å¤åˆ¶Agentæ¨¡æ¿

Agentï¼š${agent.icon} ${agent.name}
æ¥æºï¼š${agent.source}

æè¿°ï¼š${agent.description}

æˆ‘å·²ä¸ºæ‚¨å‡†å¤‡å¥½è¯¦ç»†çš„AIåˆ›å»ºæç¤ºè¯ï¼Œç‚¹å‡»ã€ç¡®å®šã€‘å°†è·³è½¬åˆ°AIå¯¹è¯é¡µé¢å¹¶è‡ªåŠ¨å¡«å…¥ã€‚`;
                
                const choice = await customConfirm(message, 'å¤–éƒ¨Agentæ¨¡æ¿å¤åˆ¶', agent.icon);
                if (choice) {
                    // è·³è½¬åˆ°å¯¹è¯åˆ›å»ºé¡µé¢ï¼Œå¸¦ä¸Šè¯¦ç»†çš„æ¨¡æ¿æè¿°
                    const encodedDesc = encodeURIComponent(templateDesc);
                    window.location.href = `/chat?message=${encodedDesc}`;
                }
                return;
            }
            
            // å¦‚æœæ˜¯æœ¬åœ°Agentï¼Œå°è¯•çœŸæ­£å¤åˆ¶
            try {
                console.log('[å¤åˆ¶] æ­£åœ¨å¤åˆ¶æœ¬åœ°Agent...');
                
                // è·å–Agentå®Œæ•´ä¿¡æ¯
                const response = await fetch(`/api/agents/${agent.id}`);
                if (!response.ok) {
                    throw new Error('è·å–Agentä¿¡æ¯å¤±è´¥');
                }
                const agentData = await response.json();
                console.log('[å¤åˆ¶] è·å–åˆ°å®Œæ•´Agentæ•°æ®:', agentData);
                
                closeDetailModal(null, 'agentDetailModal');
                
                // åˆ›å»ºæ–°çš„Agentï¼ˆæ·»åŠ "_å‰¯æœ¬"åç¼€ï¼‰
                const newAgentData = {
                    name: agentData.name + '_å‰¯æœ¬',
                    agent_type: agentData.agent_type || 'other',
                    description: agentData.description + 'ï¼ˆä»ç¤¾åŒºå¤åˆ¶ï¼‰',
                    code: agentData.code,
                    icon: agentData.icon
                };
                
                console.log('[å¤åˆ¶] å‡†å¤‡åˆ›å»ºæ–°Agent:', newAgentData.name);
                
                const createResponse = await fetch('/api/agents', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(newAgentData)
                });
                
                if (!createResponse.ok) {
                    const error = await createResponse.json();
                    throw new Error(error.error || 'åˆ›å»ºå¤±è´¥');
                }
                
                const result = await createResponse.json();
                console.log('[å¤åˆ¶] âœ… å¤åˆ¶æˆåŠŸ:', result);
                
                closeDetailModal(null, 'agentDetailModal');
                
                const message = `âœ… å¤åˆ¶æˆåŠŸï¼

å·²åˆ›å»ºæ–°Agentï¼š${newAgentData.name}

æ‚¨å¯ä»¥ï¼š
â€¢ åœ¨å·¥ä½œå°æŸ¥çœ‹å’Œç¼–è¾‘
â€¢ ç”¨äºå·¥ä½œæµä¸­
â€¢ ç»§ç»­ä¼˜åŒ–ä»£ç 

æ˜¯å¦å‰å¾€å·¥ä½œå°æŸ¥çœ‹ï¼Ÿ`;
                
                const goToWorkspace = await customConfirm(message, 'å¤åˆ¶æˆåŠŸ', 'âœ…');
                
                if (goToWorkspace) {
                    window.location.href = '/workspace-old';
                }
                
            } catch (error) {
                console.error('[å¤åˆ¶] âŒ å¤åˆ¶å¤±è´¥:', error);
                await customAlert(`âŒ å¤åˆ¶å¤±è´¥ï¼š${error.message}\n\nè¯·ç¨åé‡è¯•æˆ–æ‰‹åŠ¨åˆ›å»º`, 'å¤åˆ¶å¤±è´¥', 'âŒ');
                closeDetailModal(null, 'agentDetailModal');
            }
        }

        // ä»æ¨¡æ€æ¡†æ‰§è¡Œå·¥ä½œæµ
        async function executeWorkflowFromModal() {
            console.log('[æ‰§è¡Œ] å·¥ä½œæµ ID:', currentWorkflowId, 'Name:', currentWorkflowName);
            
            // æŸ¥æ‰¾å·¥ä½œæµ
            const workflow = allWorkflows.find(w => String(w.id) === String(currentWorkflowId));
            
            if (workflow && workflow.isExternal) {
                // å¤–éƒ¨å·¥ä½œæµï¼Œæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
                const message = `ğŸ’¡ å·¥ä½œæµè¯¦æƒ…

åç§°ï¼š${workflow.name}
æ¥æºï¼š${workflow.source}

åŒ…å«çš„Agentï¼š
${workflow.agents.map((a, i) => `${i + 1}. ${a}`).join('\n')}

æµç¨‹ï¼šè¾“å…¥ â†’ ${workflow.agents.join(' â†’ ')} â†’ è¾“å‡º

åŠŸèƒ½ï¼š${workflow.description}

ç»Ÿè®¡ï¼š
â€¢ æ‰§è¡Œ ${workflow.executionCount.toLocaleString()}æ¬¡
â€¢ æˆåŠŸç‡ ${workflow.successRate.toFixed(1)}%
â€¢ æ”¶è— ${workflow.likeCount.toLocaleString()}

å¯ç‚¹å‡»"å¤åˆ¶ä¸ºæ¨¡æ¿"åˆ›å»ºç±»ä¼¼å·¥ä½œæµã€‚`;
                
                await customAlert(message, 'å¤–éƒ¨å·¥ä½œæµè¯¦æƒ…', 'ğŸ’¡');
                return;
            }
            
            closeDetailModal(null, 'workflowDetailModal');
            
            // æœ¬åœ°å·¥ä½œæµï¼Œç›´æ¥è°ƒç”¨ç°æœ‰çš„æ‰§è¡Œå‡½æ•°
            executeWorkflow(currentWorkflowId, currentWorkflowName);
        }
        
        // å¤åˆ¶å·¥ä½œæµä¸ºæ¨¡æ¿
        async function copyWorkflowAsTemplate() {
            console.log('[å¤åˆ¶æ¨¡æ¿] å·¥ä½œæµ ID:', currentWorkflowId);
            
            const workflow = allWorkflows.find(w => String(w.id) === String(currentWorkflowId));
            if (!workflow) {
                await customAlert('âŒ æ‰¾ä¸åˆ°å·¥ä½œæµä¿¡æ¯', 'é”™è¯¯', 'âŒ');
                return;
            }
            
            console.log('[å¤åˆ¶æ¨¡æ¿] å·¥ä½œæµ:', workflow.name, 'æ¥æº:', workflow.source);
            
            closeDetailModal(null, 'workflowDetailModal');
            
            // ç”Ÿæˆå®Œæ•´çš„å·¥ä½œæµJSONæ¨¡æ¿
            const workflowTemplate = {
                name: workflow.name + "_æ¨¡æ¿",
                description: workflow.description,
                workflow_definition: {
                    agents: workflow.agents.map((agentName, index) => ({
                        name: agentName.toLowerCase().replace(/\s+/g, '_'),
                        description: `${agentName}åŠŸèƒ½å®ç°`,
                        code: `def ${agentName.toLowerCase().replace(/\s+/g, '_')}(input_data: dict) -> dict:
    """${agentName}"""
    # TODO: å®ç°å…·ä½“é€»è¾‘
    return {"result": "å¾…å®ç°", "agent": "${agentName}"}`
                    })),
                    sequence: workflow.agents.map((agentName, index) => ({
                        agent: agentName.toLowerCase().replace(/\s+/g, '_'),
                        input_mapping: index === 0 ? {"input_data": "$.input"} : {"input_data": `$.${workflow.agents[index-1].toLowerCase().replace(/\s+/g, '_')}`},
                        output_key: agentName.toLowerCase().replace(/\s+/g, '_')
                    }))
                }
            };
            
            // æ„å»ºè¯¦ç»†çš„AIåˆ›å»ºæç¤ºè¯
            const templateDesc = `è¯·å¸®æˆ‘åˆ›å»ºä¸€ä¸ªå·¥ä½œæµï¼Œç±»ä¼¼äº"${workflow.name}"

ã€å·¥ä½œæµä¿¡æ¯ã€‘
åç§°ï¼š${workflow.name}
æ¥æºï¼š${workflow.source}

ã€åŠŸèƒ½æè¿°ã€‘
${workflow.description}

ã€æµç¨‹ç»“æ„ã€‘
è¾“å…¥ â†’ ${workflow.agents.join(' â†’ ')} â†’ è¾“å‡º

ã€åŒ…å«çš„Agentã€‘
${workflow.agents.map((agent, i) => `${i + 1}. ${agent}`).join('\n')}

ã€å®Œæ•´çš„JSONæ¨¡æ¿ã€‘
\`\`\`json
${JSON.stringify(workflowTemplate, null, 2)}
\`\`\`

ã€è¦æ±‚ã€‘
è¯·ä¸ºæ¯ä¸ªAgentç”Ÿæˆå®Œæ•´çš„Pythonä»£ç ï¼š
${workflow.agents.map((agent, i) => `
${i + 1}. ${agent}
   - å‡½æ•°åï¼š${agent.toLowerCase().replace(/\s+/g, '_')}
   - å‚æ•°ï¼šinput_data (dictç±»å‹)
   - è¿”å›ï¼šdictç±»å‹çš„ç»“æœ
   - åŠŸèƒ½ï¼š${agent}çš„å…·ä½“å®ç°`).join('\n')}

è¯·ç”Ÿæˆï¼š
1. æ¯ä¸ªAgentçš„å®Œæ•´ä»£ç ï¼ˆå¸¦æ³¨é‡Šï¼‰
2. å®Œæ•´çš„workflow_definition JSON
3. å¯ä»¥ç›´æ¥ä½¿ç”¨çš„å·¥ä½œæµé…ç½®`;

            const message = `ğŸ“‹ å¤åˆ¶å·¥ä½œæµæ¨¡æ¿

å·¥ä½œæµï¼š${workflow.name}
æ¥æºï¼š${workflow.source}

æµç¨‹ï¼šè¾“å…¥ â†’ ${workflow.agents.join(' â†’ ')} â†’ è¾“å‡º

æˆ‘å·²ä¸ºæ‚¨å‡†å¤‡å¥½å®Œæ•´çš„æ¨¡æ¿ï¼ˆåŒ…å«${workflow.agents.length}ä¸ªAgentçš„ç»“æ„å’Œä»£ç æ¡†æ¶ï¼‰ã€‚

é€‰æ‹©åˆ›å»ºæ–¹å¼ï¼š
ã€ç¡®å®šã€‘AIå¯¹è¯åˆ›å»ºï¼ˆæ¨èï¼‰
ã€å–æ¶ˆã€‘å¯è§†åŒ–ç¼–è¾‘å™¨`;
            
            const choice = await customConfirm(message, 'å·¥ä½œæµæ¨¡æ¿å¤åˆ¶', 'ğŸ“‹');
            
            if (choice) {
                // è·³è½¬åˆ°AIå¯¹è¯åˆ›å»ºï¼Œå¹¶å¸¦ä¸Šæ¨¡æ¿æè¿°
                const encodedDesc = encodeURIComponent(templateDesc);
                window.location.href = `/chat?message=${encodedDesc}`;
            } else {
                // å…ˆæ˜¾ç¤ºæç¤ºï¼Œç„¶åè·³è½¬
                await customAlert(`å³å°†å‰å¾€å¯è§†åŒ–ç¼–è¾‘å™¨

å‚è€ƒæµç¨‹ï¼š${workflow.agents.join(' â†’ ')}

æç¤ºï¼šéœ€è¦å…ˆåˆ›å»º${workflow.agents.length}ä¸ªAgentï¼Œç„¶åæ‹–æ‹½è¿æ¥ã€‚`, 'å¯è§†åŒ–ç¼–è¾‘å™¨', 'ğŸ’¡');
                
                window.location.href = '/workflow-editor';
            }
        }

        // æ‰§è¡Œå·¥ä½œæµ
        async function executeWorkflow(id, name) {
            // æ™ºèƒ½å‚æ•°æ¨¡æ¿
            let paramTemplate = {};
            if (name.includes('æ—…æ¸¸') || name.includes('travel')) {
                paramTemplate = {"destination": "åŒ—äº¬", "days": 3, "budget": 5000};
            } else if (name.includes('å†…å®¹åˆ›ä½œ') || name.includes('å…¨æ ˆ') || name.includes('æ–‡ç« ') || name.includes('content')) {
                paramTemplate = {"topic": "äººå·¥æ™ºèƒ½çš„æœªæ¥å‘å±•è¶‹åŠ¿", "keywords": "AI, æœºå™¨å­¦ä¹ ", "target_audience": "æŠ€æœ¯çˆ±å¥½è€…"};
            } else {
                paramTemplate = {"input_data": "è¯·è¾“å…¥å†…å®¹"};
            }
            
            // æ˜¾ç¤ºè‡ªå®šä¹‰è¾“å…¥å¯¹è¯æ¡†
            showCommunityWorkflowInputDialog(id, name, paramTemplate);
        }
        
        // æ˜¾ç¤ºå·¥ä½œæµå‚æ•°è¾“å…¥å¯¹è¯æ¡†
        function showCommunityWorkflowInputDialog(workflowId, workflowName, paramTemplate) {
            const oldDialog = document.getElementById('community-workflow-input-dialog');
            if (oldDialog) oldDialog.remove();
            
            const modal = document.createElement('div');
            modal.id = 'community-workflow-input-dialog';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
                display: flex; align-items: center; justify-content: center; z-index: 10000;
            `;
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                    <h3 style="margin: 0 0 16px 0; color: #1f2937; font-size: 18px;">æ‰§è¡Œå·¥ä½œæµï¼š${workflowName}</h3>
                    <p style="margin: 0 0 12px 0; color: #6b7280; font-size: 14px;">è¯·è¾“å…¥JSONæ ¼å¼çš„å‚æ•°ï¼š</p>
                    <textarea id="community-workflow-input-params" style="
                        width: 100%; height: 120px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px;
                        font-family: 'Consolas', monospace; font-size: 13px; resize: vertical;
                    ">${JSON.stringify(paramTemplate, null, 2)}</textarea>
                    <div id="community-input-error-message" style="margin-top: 12px; padding: 12px; background: #fee2e2; border-left: 4px solid #ef4444; border-radius: 4px; color: #dc2626; font-size: 13px; display: none;"></div>
                    <div style="margin-top: 20px; display: flex; gap: 12px; justify-content: flex-end;">
                        <button onclick="document.getElementById('community-workflow-input-dialog').remove()" style="
                            padding: 10px 20px; background: #f3f4f6; color: #374151; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;
                        ">å–æ¶ˆ</button>
                        <button onclick="executeCommunityWorkflowWithParams(${workflowId}, '${workflowName}')" style="
                            padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;
                        ">ç¡®å®š</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('community-workflow-input-params').focus();
        }
        
        // æ‰§è¡Œå·¥ä½œæµï¼ˆå¸¦å‚æ•°ï¼‰
        async function executeCommunityWorkflowWithParams(workflowId, workflowName) {
            const inputTextarea = document.getElementById('community-workflow-input-params');
            const errorDiv = document.getElementById('community-input-error-message');
            const inputParamsStr = inputTextarea.value;
            
            let params = {};
            try {
                params = JSON.parse(inputParamsStr);
                errorDiv.style.display = 'none';
            } catch (e) {
                errorDiv.textContent = 'âŒ JSON æ ¼å¼é”™è¯¯ï¼š' + e.message;
                errorDiv.style.display = 'block';
                return;
            }
            
            // å…³é—­å¯¹è¯æ¡†
            document.getElementById('community-workflow-input-dialog').remove();
            showCommunityToast('â³ æ‰§è¡Œä¸­...', 'info');
            
            try {
                const response = await fetch(`/api/workflows/${workflowId}/execute`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(params)
                });
                
                const result = await response.json();
                if (result.success) {
                    showCommunityToast('âœ… æ‰§è¡ŒæˆåŠŸï¼å‰å¾€å·¥ä½œå°æŸ¥çœ‹è¯¦æƒ…', 'success');
                    setTimeout(() => {
                        window.open('/workspace', '_blank');
                    }, 1500);
                } else {
                    showCommunityToast('âŒ æ‰§è¡Œå¤±è´¥ï¼š' + result.error, 'error');
                }
            } catch (error) {
                showCommunityToast('âŒ é”™è¯¯ï¼š' + error.message, 'error');
            }
        }
        
        // Toasté€šçŸ¥
        function showCommunityToast(message, type = 'info') {
            const colors = {
                success: '#10b981',
                error: '#ef4444',
                info: '#3b82f6'
            };
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed; top: 20px; right: 20px; padding: 16px 24px;
                background: ${colors[type]}; color: white; border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000; max-width: 400px;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', loadCommunityData);
    </script>
</body>
</html>

