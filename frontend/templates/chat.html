<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºèƒ½åŠ©æ‰‹ - AgentForge</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            height: 100vh;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            border-right: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .sidebar-header h1 {
            font-size: 20px;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .new-chat-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .new-chat-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .chat-sessions {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .chat-session-item {
            padding: 12px;
            margin-bottom: 5px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-session-item:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        
        .chat-session-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .delete-session {
            opacity: 0;
            color: #dc3545;
            cursor: pointer;
        }
        
        .chat-session-item:hover .delete-session {
            opacity: 1;
        }
        
        /* èŠå¤©ä¸»åŒºåŸŸ */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }
        
        .chat-header {
            padding: 20px 30px;
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-header h2 {
            font-size: 18px;
            color: #333;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            background: #f8f9fa;
        }
        
        .message {
            max-width: 800px;
            margin: 0 auto 20px;
            display: flex;
            gap: 15px;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .user-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .assistant-avatar {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .message-content {
            flex: 1;
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            line-height: 1.6;
        }
        
        .message-content pre {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 10px 0;
        }
        
        .message-content code {
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        
        .input-container {
            padding: 20px 30px;
            background: white;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .input-wrapper {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            gap: 10px;
        }
        
        .input-box {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 24px;
            font-size: 14px;
            outline: none;
            transition: all 0.3s;
        }
        
        .input-box:focus {
            border-color: #667eea;
        }
        
        .send-btn {
            width: 48px;
            height: 48px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .welcome-screen {
            max-width: 600px;
            margin: 100px auto;
            text-align: center;
        }
        
        .welcome-screen h1 {
            font-size: 36px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
        }
        
        .welcome-screen p {
            color: #666;
            font-size: 16px;
            line-height: 1.8;
        }
        
        .suggestions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 40px;
        }
        
        .suggestion-card {
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .suggestion-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
        }
        
        .suggestion-icon {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .suggestion-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .suggestion-text {
            font-size: 13px;
            color: #666;
        }
        
        .loading {
            display: flex;
            gap: 5px;
            padding: 10px;
        }
        
        .loading-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #667eea;
            animation: bounce 1.4s infinite ease-in-out;
        }
        
        .loading-dot:nth-child(1) {
            animation-delay: -0.32s;
        }
        
        .loading-dot:nth-child(2) {
            animation-delay: -0.16s;
        }
        
        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }
        
        .config-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
        }
        
        .modal-title {
            font-size: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>ğŸ¤– AI æ™ºèƒ½åŠ©æ‰‹</h1>
                <button class="new-chat-btn" onclick="createNewSession()">
                    <i class="fas fa-plus"></i> æ–°å»ºå¯¹è¯
                </button>
            </div>
            <div class="chat-sessions" id="chatSessions">
                <!-- å¯¹è¯åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
            </div>
        </div>
        
        <!-- ä¸»èŠå¤©åŒºåŸŸ -->
        <div class="chat-main">
            <div class="chat-header">
                <h2 id="chatTitle">DeepSeek AI åŠ©æ‰‹</h2>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="showConfigModal()">
                        <i class="fas fa-cog"></i> é…ç½®
                    </button>
                    <button class="btn btn-secondary" onclick="window.location.href='/workspace'">
                        <i class="fas fa-arrow-left"></i> è¿”å›å·¥ä½œå°
                    </button>
                </div>
            </div>
            
            <div class="messages-container" id="messagesContainer">
                <div class="welcome-screen" id="welcomeScreen">
                    <h1>ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯ AgentFlow AI åŠ©æ‰‹</h1>
                    <p>æˆ‘å¯ä»¥å¸®æ‚¨ï¼š</p>
                    <div class="suggestions">
                               <div class="suggestion-card" onclick="sendSuggestion('å¸®æˆ‘ç”Ÿæˆä¸€ä¸ªJSONæ•°æ®å¤„ç†çš„Agentä»£ç ')">
                                   <div class="suggestion-icon">ğŸ¤–</div>
                                   <div class="suggestion-title">ç”Ÿæˆ Agent ä»£ç </div>
                                   <div class="suggestion-text">æ™ºèƒ½ç”ŸæˆPython Agentå‡½æ•°</div>
                               </div>
                               <div class="suggestion-card" onclick="sendSuggestion('å¦‚ä½•è®¾è®¡ä¸€ä¸ªæ•°æ®å¤„ç†å·¥ä½œæµï¼Ÿéœ€è¦è¯»å–ã€å¤„ç†ã€è¾“å‡ºä¸‰ä¸ªæ­¥éª¤')">
                                   <div class="suggestion-icon">ğŸ”„</div>
                                   <div class="suggestion-title">å·¥ä½œæµè®¾è®¡</div>
                                   <div class="suggestion-text">å¤šAgentä¸²è”æ‰§è¡Œ</div>
                               </div>
                               <div class="suggestion-card" onclick="sendSuggestion('ä»‹ç»ä¸€ä¸‹AgentFlowå¹³å°çš„æ ¸å¿ƒåŠŸèƒ½')">
                                   <div class="suggestion-icon">ğŸ’¡</div>
                                   <div class="suggestion-title">å¹³å°åŠŸèƒ½</div>
                                   <div class="suggestion-text">äº†è§£Agentç¼–æ’ç³»ç»Ÿ</div>
                               </div>
                               <div class="suggestion-card" onclick="sendSuggestion('æ¨èä¸€äº›å¸¸ç”¨çš„Agentç±»å‹å’Œä½¿ç”¨åœºæ™¯')">
                                   <div class="suggestion-icon">ğŸ“š</div>
                                   <div class="suggestion-title">Agentç±»å‹</div>
                                   <div class="suggestion-text">processor/analyzer/converter</div>
                               </div>
                    </div>
                </div>
            </div>
            
            <div class="input-container">
                <div class="input-wrapper">
                    <input 
                        type="text" 
                        class="input-box" 
                        id="messageInput" 
                        placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜...ï¼ˆæŒ‰ Enter å‘é€ï¼‰"
                        onkeypress="handleKeyPress(event)"
                    >
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- é…ç½®æ¨¡æ€æ¡† -->
    <div class="config-modal" id="configModal">
        <div class="modal-content" style="max-width: 600px;">
            <h3 class="modal-title">é…ç½® DeepSeek API Key</h3>
            <div class="form-group">
                <label>API Key:</label>
                <input type="password" id="apiKeyInput" placeholder="sk-...">
                <small style="color: #666; display: block; margin-top: 5px;">
                    è·å– API Key: <a href="https://platform.deepseek.com" target="_blank" style="color: #667eea;">https://platform.deepseek.com</a>
                </small>
                <div id="currentKeyDisplay" style="margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 5px; display: none;">
                    <strong>å½“å‰é…ç½®:</strong> <span id="currentKeyText"></span>
                </div>
            </div>
            
            <!-- ç½‘ç»œè¯Šæ–­æç¤º -->
            <div style="margin-top: 15px; padding: 12px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px; font-size: 13px;">
                <strong>âš ï¸ ç½‘ç»œé—®é¢˜æ’æŸ¥</strong>
                <div style="margin-top: 8px; line-height: 1.6;">
                    <div style="margin-bottom: 5px;">
                        <strong>å¦‚é‡åˆ°è¶…æ—¶é”™è¯¯ï¼š</strong>
                    </div>
                    <ul style="margin: 5px 0; padding-left: 20px;">
                        <li>æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸</li>
                        <li>ç¡®è®¤èƒ½å¦è®¿é—® api.deepseek.com</li>
                        <li>å…³é—­VPNæˆ–ä»£ç†è½¯ä»¶è¯•è¯•</li>
                        <li>ç­‰å¾…å‡ åˆ†é’Ÿåé‡è¯•</li>
                    </ul>
                    <div style="margin-top: 8px; padding: 8px; background: white; border-radius: 4px;">
                        <strong>ğŸ’¡ å¿«é€Ÿè¯Šæ–­ï¼š</strong><br>
                        <a href="/network-test" target="_blank" style="color: #667eea; font-weight: bold;">
                            ğŸ” æ‰“å¼€ç½‘ç»œè¯Šæ–­å·¥å…· â†’
                        </a>
                        <div style="margin-top: 5px; font-size: 12px; color: #666;">
                            è‡ªåŠ¨æ£€æµ‹ç½‘ç»œè¿æ¥ã€APIé…ç½®çŠ¶æ€ç­‰
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeConfigModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveApiKey()">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <script>
        let currentSessionId = null;
        let isLoading = false;
        
        // Toast æç¤ºå‡½æ•°
        function showToast(message, type = 'info') {
            // åˆ›å»º toast å…ƒç´ 
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 24px;
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                max-width: 400px;
                font-size: 14px;
                line-height: 1.5;
                animation: slideIn 0.3s ease-out;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }
        
        // æ·»åŠ åŠ¨ç”»æ ·å¼
        if (!document.getElementById('toast-styles')) {
            const style = document.createElement('style');
            style.id = 'toast-styles';
            style.textContent = `
                @keyframes slideIn {
                    from {
                        transform: translateX(400px);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
                @keyframes slideOut {
                    from {
                        transform: translateX(0);
                        opacity: 1;
                    }
                    to {
                        transform: translateX(400px);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(style);
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            checkConfig();
            loadChatSessions();
            checkAndFillURLMessage();
        });
        
        // æ£€æŸ¥URLå‚æ•°å¹¶è‡ªåŠ¨å¡«å…¥æ¶ˆæ¯
        function checkAndFillURLMessage() {
            const urlParams = new URLSearchParams(window.location.search);
            const message = urlParams.get('message');
            const template = urlParams.get('template');
            
            if (message) {
                console.log('[URLå‚æ•°] æ£€æµ‹åˆ°messageå‚æ•°:', message.substring(0, 100) + '...');
                
                // å»¶è¿Ÿå¡«å…¥ï¼Œç¡®ä¿è¾“å…¥æ¡†å·²åŠ è½½
                setTimeout(() => {
                    const input = document.getElementById('messageInput');
                    if (input) {
                        input.value = message;  // URLå‚æ•°å·²ç»æ˜¯ç¼–ç çš„ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨è§£ç 
                        console.log('[URLå‚æ•°] âœ… å·²è‡ªåŠ¨å¡«å…¥æ¶ˆæ¯åˆ°è¾“å…¥æ¡†');
                        console.log('[URLå‚æ•°] æ¶ˆæ¯é•¿åº¦:', input.value.length, 'å­—ç¬¦');
                        
                        // è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
                        input.focus();
                        
                        // æ»šåŠ¨åˆ°è¾“å…¥æ¡†åº•éƒ¨ï¼ˆå¦‚æœæ˜¯textareaï¼‰
                        if (input.scrollTop !== undefined) {
                            input.scrollTop = input.scrollHeight;
                        }
                        
                        // å¯é€‰ï¼šæ˜¾ç¤ºæç¤º
                        const messagesContainer = document.getElementById('messagesContainer');
                        if (messagesContainer && messagesContainer.children.length === 0) {
                            messagesContainer.innerHTML = `
                                <div style="text-align: center; padding: 40px; color: #666;">
                                    <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“‹</div>
                                    <h3 style="margin-bottom: 10px;">å·²è‡ªåŠ¨å¡«å…¥æ¨¡æ¿å†…å®¹</h3>
                                    <p style="color: #999;">æ‚¨å¯ä»¥æŸ¥çœ‹ã€ä¿®æ”¹å†…å®¹ï¼Œç„¶åç‚¹å‡»å‘é€æŒ‰é’®</p>
                                </div>
                            `;
                        }
                    } else {
                        console.error('[URLå‚æ•°] âŒ æ‰¾ä¸åˆ°è¾“å…¥æ¡†å…ƒç´ ');
                    }
                }, 500);
                
                // æ¸…é™¤URLå‚æ•°ï¼ˆå¯é€‰ï¼Œé¿å…åˆ·æ–°æ—¶é‡å¤å¡«å…¥ï¼‰
                // window.history.replaceState({}, document.title, window.location.pathname);
            } else if (template) {
                console.log('[URLå‚æ•°] æ£€æµ‹åˆ°templateå‚æ•°:', template);
                // å¦‚æœåªæœ‰templateå‚æ•°ï¼Œå¯ä»¥æ˜¾ç¤ºä¸€ä¸ªæç¤º
                setTimeout(() => {
                    const input = document.getElementById('messageInput');
                    if (input) {
                        input.value = `è¯·å¸®æˆ‘åˆ›å»ºä¸€ä¸ªç±»ä¼¼"${template}"çš„Agent`;
                        input.focus();
                    }
                }, 500);
            }
        }
        
        // æ£€æŸ¥é…ç½®
        async function checkConfig() {
            const response = await fetch('/api/chat/config');
            const data = await response.json();
            
            if (!data.configured) {
                showConfigModal();
            }
        }
        
        // åŠ è½½å¯¹è¯åˆ—è¡¨
        async function loadChatSessions() {
            const response = await fetch('/api/chat/sessions');
            const sessions = await response.json();
            
            const container = document.getElementById('chatSessions');
            container.innerHTML = sessions.map(s => `
                <div class="chat-session-item ${s.id === currentSessionId ? 'active' : ''}" 
                     onclick="loadSession(${s.id}, '${s.title}')">
                    <span>${s.title}</span>
                    <i class="fas fa-trash delete-session" onclick="event.stopPropagation(); deleteSession(${s.id})"></i>
                </div>
            `).join('');
        }
        
        // åˆ›å»ºæ–°å¯¹è¯
        async function createNewSession() {
            try {
                const response = await fetch('/api/chat/sessions', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({title: 'æ–°å¯¹è¯'})
                });
                
                const data = await response.json();
                currentSessionId = data.session_id;
                
                console.log('[åˆ›å»ºä¼šè¯] ä¼šè¯ID:', currentSessionId);
                
                // æ¸…ç©ºæ¶ˆæ¯åŒºåŸŸ
                const container = document.getElementById('messagesContainer');
                container.innerHTML = `
                    <div class="welcome-screen">
                        <h1>ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯ AgentFlow AI åŠ©æ‰‹</h1>
                        <p>æˆ‘å¯ä»¥å¸®æ‚¨ï¼š</p>
                        <div class="suggestions">
                               <div class="suggestion-card" onclick="sendSuggestion('å¸®æˆ‘ç”Ÿæˆä¸€ä¸ªJSONæ•°æ®å¤„ç†çš„Agentä»£ç ')">
                                   <div class="suggestion-icon">ğŸ¤–</div>
                                   <div class="suggestion-title">ç”Ÿæˆ Agent ä»£ç </div>
                                   <div class="suggestion-text">æ™ºèƒ½ç”ŸæˆPython Agentå‡½æ•°</div>
                               </div>
                               <div class="suggestion-card" onclick="sendSuggestion('å¦‚ä½•è®¾è®¡ä¸€ä¸ªæ•°æ®å¤„ç†å·¥ä½œæµï¼Ÿéœ€è¦è¯»å–ã€å¤„ç†ã€è¾“å‡ºä¸‰ä¸ªæ­¥éª¤')">
                                   <div class="suggestion-icon">ğŸ”„</div>
                                   <div class="suggestion-title">å·¥ä½œæµè®¾è®¡</div>
                                   <div class="suggestion-text">å¤šAgentä¸²è”æ‰§è¡Œ</div>
                               </div>
                               <div class="suggestion-card" onclick="sendSuggestion('ä»‹ç»ä¸€ä¸‹AgentFlowå¹³å°çš„æ ¸å¿ƒåŠŸèƒ½')">
                                   <div class="suggestion-icon">ğŸ’¡</div>
                                   <div class="suggestion-title">å¹³å°åŠŸèƒ½</div>
                                   <div class="suggestion-text">äº†è§£Agentç¼–æ’ç³»ç»Ÿ</div>
                               </div>
                               <div class="suggestion-card" onclick="sendSuggestion('æ¨èä¸€äº›å¸¸ç”¨çš„Agentç±»å‹å’Œä½¿ç”¨åœºæ™¯')">
                                   <div class="suggestion-icon">ğŸ“š</div>
                                   <div class="suggestion-title">Agentç±»å‹</div>
                                   <div class="suggestion-text">processor/analyzer/converter</div>
                               </div>
                        </div>
                    </div>
                `;
                
                loadChatSessions();
            } catch (error) {
                console.error('[åˆ›å»ºä¼šè¯å¤±è´¥]', error);
                alert('åˆ›å»ºä¼šè¯å¤±è´¥: ' + error.message);
            }
        }
        
        // åŠ è½½å¯¹è¯
        async function loadSession(sessionId, title) {
            try {
                currentSessionId = sessionId;
                document.getElementById('chatTitle').textContent = title;
                
                console.log('[åŠ è½½ä¼šè¯] ä¼šè¯ID:', sessionId);
                
                const response = await fetch(`/api/chat/sessions/${sessionId}/messages`);
                const messages = await response.json();
                
                const container = document.getElementById('messagesContainer');
                
                if (messages.length === 0) {
                    // å¦‚æœæ²¡æœ‰æ¶ˆæ¯ï¼Œæ˜¾ç¤ºæ¬¢è¿å±å¹•
                    container.innerHTML = `
                        <div class="welcome-screen">
                            <h1>ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯ AgentFlow AI åŠ©æ‰‹</h1>
                            <p>æˆ‘å¯ä»¥å¸®æ‚¨ï¼š</p>
                            <div class="suggestions">
                               <div class="suggestion-card" onclick="sendSuggestion('å¸®æˆ‘ç”Ÿæˆä¸€ä¸ªJSONæ•°æ®å¤„ç†çš„Agentä»£ç ')">
                                   <div class="suggestion-icon">ğŸ¤–</div>
                                   <div class="suggestion-title">ç”Ÿæˆ Agent ä»£ç </div>
                                   <div class="suggestion-text">æ™ºèƒ½ç”ŸæˆPython Agentå‡½æ•°</div>
                               </div>
                               <div class="suggestion-card" onclick="sendSuggestion('å¦‚ä½•è®¾è®¡ä¸€ä¸ªæ•°æ®å¤„ç†å·¥ä½œæµï¼Ÿéœ€è¦è¯»å–ã€å¤„ç†ã€è¾“å‡ºä¸‰ä¸ªæ­¥éª¤')">
                                   <div class="suggestion-icon">ğŸ”„</div>
                                   <div class="suggestion-title">å·¥ä½œæµè®¾è®¡</div>
                                   <div class="suggestion-text">å¤šAgentä¸²è”æ‰§è¡Œ</div>
                               </div>
                               <div class="suggestion-card" onclick="sendSuggestion('ä»‹ç»ä¸€ä¸‹AgentFlowå¹³å°çš„æ ¸å¿ƒåŠŸèƒ½')">
                                   <div class="suggestion-icon">ğŸ’¡</div>
                                   <div class="suggestion-title">å¹³å°åŠŸèƒ½</div>
                                   <div class="suggestion-text">äº†è§£Agentç¼–æ’ç³»ç»Ÿ</div>
                               </div>
                               <div class="suggestion-card" onclick="sendSuggestion('æ¨èä¸€äº›å¸¸ç”¨çš„Agentç±»å‹å’Œä½¿ç”¨åœºæ™¯')">
                                   <div class="suggestion-icon">ğŸ“š</div>
                                   <div class="suggestion-title">Agentç±»å‹</div>
                                   <div class="suggestion-text">processor/analyzer/converter</div>
                               </div>
                            </div>
                        </div>
                    `;
                } else {
                    // æ˜¾ç¤ºæ¶ˆæ¯å†å²
                    container.innerHTML = messages.map(msg => `
                        <div class="message">
                            <div class="message-avatar ${msg.role}-avatar">
                                ${msg.role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–'}
                            </div>
                            <div class="message-content">
                                ${formatMessage(msg.content)}
                            </div>
                        </div>
                    `).join('');
                }
                
                container.scrollTop = container.scrollHeight;
                loadChatSessions();
            } catch (error) {
                console.error('[åŠ è½½ä¼šè¯å¤±è´¥]', error);
                alert('åŠ è½½ä¼šè¯å¤±è´¥: ' + error.message);
            }
        }
        
        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            console.log('[å‘é€æ¶ˆæ¯] æ¶ˆæ¯å†…å®¹:', message);
            console.log('[å‘é€æ¶ˆæ¯] å½“å‰ä¼šè¯ID:', currentSessionId);
            console.log('[å‘é€æ¶ˆæ¯] isLoading:', isLoading);
            
            if (!message || isLoading) {
                console.log('[å‘é€æ¶ˆæ¯] æ¶ˆæ¯ä¸ºç©ºæˆ–æ­£åœ¨åŠ è½½ï¼Œå–æ¶ˆå‘é€');
                return;
            }
            
            // å¦‚æœæ²¡æœ‰ä¼šè¯IDï¼Œå…ˆåˆ›å»ºä¼šè¯
            if (!currentSessionId) {
                console.log('[å‘é€æ¶ˆæ¯] æ²¡æœ‰ä¼šè¯IDï¼Œåˆ›å»ºæ–°ä¼šè¯');
                await createNewSession();
            }
            
            console.log('[å‘é€æ¶ˆæ¯] å¼€å§‹å‘é€åˆ°ä¼šè¯:', currentSessionId);
            
            input.value = '';
            isLoading = true;
            document.getElementById('sendBtn').disabled = true;
            
            // æ¸…é™¤æ¬¢è¿å±å¹•
            const welcomeScreen = document.querySelector('.welcome-screen');
            if (welcomeScreen) {
                welcomeScreen.remove();
            }
            
            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            addMessage('user', message);
            
            // åˆ›å»ºä¸€ä¸ªç©ºçš„assistantæ¶ˆæ¯å®¹å™¨ï¼Œç”¨äºæµå¼æ›´æ–°
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.innerHTML = `
                <div class="message-avatar assistant-avatar">ğŸ¤–</div>
                <div class="message-content">
                    <div class="loading"><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div></div>
                </div>
            `;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
            
            const contentDiv = messageDiv.querySelector('.message-content');
            let fullContent = '';
            
            try {
                console.log('[å‘é€æ¶ˆæ¯] å»ºç«‹æµå¼è¿æ¥...');
                const apiUrl = `/api/chat/sessions/${currentSessionId}/messages`;
                console.log('[å‘é€æ¶ˆæ¯] è¯·æ±‚URL:', apiUrl);
                console.log('[å‘é€æ¶ˆæ¯] è¯·æ±‚Body:', {message: message});
                
                // ä½¿ç”¨ fetch è¯»å–æµå¼å“åº”
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({message: message})
                });
                
                console.log('[å‘é€æ¶ˆæ¯] å“åº”çŠ¶æ€:', response.status, response.statusText);
                console.log('[å‘é€æ¶ˆæ¯] å“åº”Headers:', Object.fromEntries(response.headers.entries()));
                
                if (!response.ok) {
                    throw new Error('è¯·æ±‚å¤±è´¥: ' + response.status);
                }
                
                // ç§»é™¤åŠ è½½åŠ¨ç”»
                contentDiv.innerHTML = '';
                
                // è¯»å–æµå¼æ•°æ®
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const {done, value} = await reader.read();
                    
                    if (done) {
                        console.log('[æµå¼è¾“å‡º] æµç»“æŸ');
                        break;
                    }
                    
                    // è§£ç æ•°æ®
                    const chunk = decoder.decode(value, {stream: true});
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.substring(6));
                                
                                if (data.done) {
                                    console.log('[æµå¼è¾“å‡º] æ¥æ”¶å®Œæˆ');
                                    break;
                                }
                                
                                // å¤„ç†å·¥å…·è°ƒç”¨é€šçŸ¥
                                if (data.success && data.tool_call) {
                                    const toolName = data.tool_call.name;
                                    const toolArgs = JSON.stringify(data.tool_call.arguments);
                                    console.log('[å·¥å…·è°ƒç”¨] æ”¶åˆ°å·¥å…·è°ƒç”¨é€šçŸ¥:', toolName);
                                    
                                    const toolNotice = `ğŸ”§ æ­£åœ¨è°ƒç”¨å·¥å…·: **${toolName}**\nå‚æ•°: \`${toolArgs}\`\n\n`;
                                    fullContent += toolNotice;
                                    contentDiv.innerHTML = formatMessage(fullContent);
                                    container.scrollTop = container.scrollHeight;
                                }
                                // å¤„ç†æ­£å¸¸å†…å®¹
                                else if (data.success && data.content) {
                                    fullContent += data.content;
                                    contentDiv.innerHTML = formatMessage(fullContent);
                                    container.scrollTop = container.scrollHeight;
                                }
                                // å¤„ç†é”™è¯¯
                                else if (!data.success && data.error) {
                                    let errorMsg = 'âŒ ' + data.error;
                                    if (data.error_type === 'timeout') {
                                        errorMsg += '\n\nğŸ’¡ æç¤ºï¼šæ‚¨å¯ä»¥é‡æ–°å‘é€æ¶ˆæ¯è¿›è¡Œé‡è¯•';
                                    }
                                    if (data.error_type === 'auth_error') {
                                        errorMsg += '\n\nè¯·ç‚¹å‡»å³ä¸Šè§’ã€Œâš™ï¸ é…ç½®ã€é‡æ–°è®¾ç½® API Key';
                                    }
                                    contentDiv.innerHTML = formatMessage(errorMsg);
                                }
                                // è°ƒè¯•ï¼šè®°å½•æœªå¤„ç†çš„æ•°æ®
                                else {
                                    console.warn('[æµå¼è¾“å‡º] æœªå¤„ç†çš„æ•°æ®:', data);
                                }
                            } catch (e) {
                                console.error('[æµå¼è¾“å‡º] JSONè§£æé”™è¯¯:', e);
                            }
                        }
                    }
                }
                
                console.log('[å‘é€æ¶ˆæ¯] âœ… æµå¼æ¥æ”¶å®Œæˆ');
                console.log('[å‘é€æ¶ˆæ¯] å®Œæ•´å†…å®¹é•¿åº¦:', fullContent.length);
                
                // æµå¼æ¥æ”¶å®Œæˆåï¼Œæ£€æµ‹æ˜¯å¦åŒ…å«åˆ›å»ºæ ‡è®°
                if (fullContent.includes('```CREATE_AGENTS_AND_WORKFLOW')) {
                    console.log('[åˆ›å»ºæ£€æµ‹] å‘ç°åˆ›å»ºæ ‡è®°ï¼Œå¼€å§‹è§£æ...');
                    
                    // æå–JSONé…ç½®
                    let createData = null;
                    let displayContent = fullContent;
                    
                    try {
                        const match = fullContent.match(/```CREATE_AGENTS_AND_WORKFLOW\s*\n([\s\S]*?)```/);
                        if (match && match[1]) {
                            const jsonStr = match[1].trim();
                            console.log('[åˆ›å»ºæ£€æµ‹] JSONå­—ç¬¦ä¸²:', jsonStr.substring(0, 200) + '...');
                            createData = JSON.parse(jsonStr);
                            console.log('[åˆ›å»ºæ£€æµ‹] âœ… JSONè§£ææˆåŠŸ');
                            
                            // éšè—åŸå§‹JSONï¼Œæ˜¾ç¤ºåˆ›å»ºæŒ‰é’®
                            displayContent = fullContent.replace(/```CREATE_AGENTS_AND_WORKFLOW[\s\S]*?```/, '');
                        }
                    } catch (e) {
                        console.error('[åˆ›å»ºæ£€æµ‹] JSONè§£æå¤±è´¥:', e);
                    }
                    
                    // æ›´æ–°æ˜¾ç¤ºå†…å®¹
                    contentDiv.innerHTML = formatMessage(displayContent);
                    
                    // æ·»åŠ åˆ›å»ºæŒ‰é’®
                    if (createData) {
                        const createActionDiv = document.createElement('div');
                        createActionDiv.className = 'create-action';
                        createActionDiv.style.cssText = 'margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; color: white;';
                        createActionDiv.innerHTML = `
                            <div style="font-weight: bold; margin-bottom: 10px;">âœ¨ ä¸€é”®åˆ›å»ºåˆ°å¹³å°</div>
                            <div style="font-size: 13px; margin-bottom: 10px; opacity: 0.9;">
                                å°†åˆ›å»º <strong>${createData.agents.length}</strong> ä¸ªAgent${createData.workflow ? ' å’Œ 1 ä¸ªå·¥ä½œæµ' : ''}
                            </div>
                            <button onclick='createToPlatform(${JSON.stringify(createData).replace(/'/g, "&apos;")})' 
                                    style="background: white; color: #667eea; border: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; transition: transform 0.2s;">
                                ğŸš€ ç«‹å³åˆ›å»º
                            </button>
                        `;
                        contentDiv.appendChild(createActionDiv);
                        console.log('[åˆ›å»ºæ£€æµ‹] âœ… åˆ›å»ºæŒ‰é’®å·²æ·»åŠ ');
                    }
                }
                
            } catch (error) {
                console.error('[å‘é€æ¶ˆæ¯] âŒ å¼‚å¸¸:', error);
                contentDiv.innerHTML = formatMessage('âŒ ç½‘ç»œé”™è¯¯: ' + error.message);
            }
            
            isLoading = false;
            document.getElementById('sendBtn').disabled = false;
            console.log('[å‘é€æ¶ˆæ¯] æµç¨‹ç»“æŸ');
        }
        
        // æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
        function addMessage(role, content) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            
            // æ£€æµ‹æ˜¯å¦åŒ…å«åˆ›å»ºæ ‡è®°
            let createData = null;
            let displayContent = content;
            
            if (role === 'assistant' && content.includes('```CREATE_AGENTS_AND_WORKFLOW')) {
                try {
                    // æå–JSONé…ç½®
                    const match = content.match(/```CREATE_AGENTS_AND_WORKFLOW\s*\n([\s\S]*?)```/);
                    if (match && match[1]) {
                        createData = JSON.parse(match[1].trim());
                        // ç§»é™¤ç‰¹æ®Šæ ‡è®°ï¼Œåªæ˜¾ç¤ºè¯´æ˜æ–‡å­—
                        displayContent = content.replace(/```CREATE_AGENTS_AND_WORKFLOW[\s\S]*?```/, '');
                    }
                } catch (e) {
                    console.error('è§£æåˆ›å»ºé…ç½®å¤±è´¥:', e);
                }
            }
            
            messageDiv.innerHTML = `
                <div class="message-avatar ${role}-avatar">
                    ${role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–'}
                </div>
                <div class="message-content">
                    ${formatMessage(displayContent)}
                    ${createData ? `
                        <div class="create-action" style="margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; color: white;">
                            <div style="font-weight: bold; margin-bottom: 10px;">âœ¨ ä¸€é”®åˆ›å»ºåˆ°å¹³å°</div>
                            <div style="font-size: 13px; margin-bottom: 10px; opacity: 0.9;">
                                å°†åˆ›å»º <strong>${createData.agents.length}</strong> ä¸ªAgent${createData.workflow ? ' å’Œ 1 ä¸ªå·¥ä½œæµ' : ''}
                            </div>
                            <button onclick='createToPlatform(${JSON.stringify(createData).replace(/'/g, "&apos;")})' 
                                    style="background: white; color: #667eea; border: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; transition: transform 0.2s;">
                                ğŸš€ ç«‹å³åˆ›å»º
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        // æ ¼å¼åŒ–æ¶ˆæ¯
        function formatMessage(content) {
            // å¤„ç†ä»£ç å—
            content = content.replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
            // å¤„ç†æ¢è¡Œ
            content = content.replace(/\n/g, '<br>');
            return content;
        }
        
        // å‘é€å»ºè®®é—®é¢˜
        function sendSuggestion(text) {
            document.getElementById('messageInput').value = text;
            sendMessage();
        }
        
        // å¤„ç†å›è½¦é”®
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        // åˆ é™¤å¯¹è¯
        async function deleteSession(sessionId) {
            try {
                if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯¹è¯å—ï¼Ÿ')) return;
                
                console.log('[åˆ é™¤ä¼šè¯] ä¼šè¯ID:', sessionId);
                
                const response = await fetch(`/api/chat/sessions/${sessionId}`, {method: 'DELETE'});
                
                if (response.ok) {
                    console.log('[åˆ é™¤ä¼šè¯] âœ… åˆ é™¤æˆåŠŸ');
                    
                    // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ä¼šè¯ï¼Œæ¸…ç©ºç•Œé¢
                    if (sessionId === currentSessionId) {
                        currentSessionId = null;
                        const container = document.getElementById('messagesContainer');
                        container.innerHTML = `
                            <div class="welcome-screen">
                                <h1>ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯ AgentFlow AI åŠ©æ‰‹</h1>
                                <p>æˆ‘å¯ä»¥å¸®æ‚¨ï¼š</p>
                                <div class="suggestions">
                               <div class="suggestion-card" onclick="sendSuggestion('å¸®æˆ‘ç”Ÿæˆä¸€ä¸ªJSONæ•°æ®å¤„ç†çš„Agentä»£ç ')">
                                   <div class="suggestion-icon">ğŸ¤–</div>
                                   <div class="suggestion-title">ç”Ÿæˆ Agent ä»£ç </div>
                                   <div class="suggestion-text">æ™ºèƒ½ç”ŸæˆPython Agentå‡½æ•°</div>
                               </div>
                               <div class="suggestion-card" onclick="sendSuggestion('å¦‚ä½•è®¾è®¡ä¸€ä¸ªæ•°æ®å¤„ç†å·¥ä½œæµï¼Ÿéœ€è¦è¯»å–ã€å¤„ç†ã€è¾“å‡ºä¸‰ä¸ªæ­¥éª¤')">
                                   <div class="suggestion-icon">ğŸ”„</div>
                                   <div class="suggestion-title">å·¥ä½œæµè®¾è®¡</div>
                                   <div class="suggestion-text">å¤šAgentä¸²è”æ‰§è¡Œ</div>
                               </div>
                               <div class="suggestion-card" onclick="sendSuggestion('ä»‹ç»ä¸€ä¸‹AgentFlowå¹³å°çš„æ ¸å¿ƒåŠŸèƒ½')">
                                   <div class="suggestion-icon">ğŸ’¡</div>
                                   <div class="suggestion-title">å¹³å°åŠŸèƒ½</div>
                                   <div class="suggestion-text">äº†è§£Agentç¼–æ’ç³»ç»Ÿ</div>
                               </div>
                               <div class="suggestion-card" onclick="sendSuggestion('æ¨èä¸€äº›å¸¸ç”¨çš„Agentç±»å‹å’Œä½¿ç”¨åœºæ™¯')">
                                   <div class="suggestion-icon">ğŸ“š</div>
                                   <div class="suggestion-title">Agentç±»å‹</div>
                                   <div class="suggestion-text">processor/analyzer/converter</div>
                               </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    loadChatSessions();
                } else {
                    console.error('[åˆ é™¤ä¼šè¯] âŒ å¤±è´¥');
                    alert('åˆ é™¤ä¼šè¯å¤±è´¥');
                }
            } catch (error) {
                console.error('[åˆ é™¤ä¼šè¯] âŒ å¼‚å¸¸:', error);
                alert('åˆ é™¤ä¼šè¯å¤±è´¥: ' + error.message);
            }
        }
        
        // æ˜¾ç¤ºé…ç½®æ¨¡æ€æ¡†
        async function showConfigModal() {
            document.getElementById('configModal').style.display = 'flex';
            
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰é…ç½®
            try {
                const response = await fetch('/api/chat/config');
                const data = await response.json();
                
                if (data.configured && data.key_prefix) {
                    document.getElementById('currentKeyDisplay').style.display = 'block';
                    document.getElementById('currentKeyText').textContent = data.key_prefix;
                } else {
                    document.getElementById('currentKeyDisplay').style.display = 'none';
                }
            } catch (error) {
                console.error('è·å–é…ç½®å¤±è´¥:', error);
            }
        }
        
        // å…³é—­é…ç½®æ¨¡æ€æ¡†
        function closeConfigModal() {
            document.getElementById('configModal').style.display = 'none';
            document.getElementById('apiKeyInput').value = '';
        }
        
        // ä¿å­˜ API Key
        async function saveApiKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            
            if (!apiKey) {
                showToast('âš ï¸ è¯·è¾“å…¥ API Key', 'error');
                return;
            }
            
            if (!apiKey.startsWith('sk-')) {
                showToast('âŒ API Key æ ¼å¼é”™è¯¯ï¼Œåº”è¯¥ä»¥ sk- å¼€å¤´', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/chat/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({api_key: apiKey})
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showToast('âœ… API Key é…ç½®æˆåŠŸï¼å·²ä¿å­˜: ' + (data.key_prefix || 'é…ç½®æˆåŠŸ'), 'success');
                    closeConfigModal();
                } else {
                    showToast('âŒ é…ç½®å¤±è´¥: ' + data.error, 'error');
                }
            } catch (error) {
                showToast('âŒ ä¿å­˜å¤±è´¥: ' + error.message, 'error');
                console.error('ä¿å­˜API Keyå¤±è´¥:', error);
            }
        }
        
        // ä»å¯¹è¯åˆ›å»ºAgentå’Œå·¥ä½œæµ
        async function createToPlatform(data) {
            try {
                console.log('[åˆ›å»ºåˆ°å¹³å°] æ•°æ®:', data);
                
                // ç›´æ¥å¼€å§‹åˆ›å»ºï¼Œç§»é™¤ç¡®è®¤å¼¹çª—
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'â³ åˆ›å»ºä¸­...';
                btn.disabled = true;
                
                const response = await fetch('/api/ai/create-from-chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                console.log('[åˆ›å»ºåˆ°å¹³å°] ç»“æœ:', result);
                
                if (result.success) {
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    const successMsg = 'âœ… åˆ›å»ºæˆåŠŸï¼å·²åˆ›å»º ' + result.agents.length + ' ä¸ªAgent' + 
                                      (result.workflow ? ' å’Œ 1 ä¸ªå·¥ä½œæµ' : '');
                    showToast(successMsg, 'success');
                    
                    btn.textContent = 'âœ… å·²åˆ›å»º';
                    btn.style.background = '#4CAF50';
                    
                    // 1.5ç§’åè‡ªåŠ¨æ‰“å¼€å·¥ä½œå°
                    setTimeout(() => {
                        window.open('/workspace', '_blank');
                    }, 1500);
                } else {
                    // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
                    showToast('âŒ åˆ›å»ºå¤±è´¥ï¼š' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                    console.error('[åˆ›å»ºå¤±è´¥è¯¦æƒ…]', result);
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            } catch (error) {
                console.error('[åˆ›å»ºåˆ°å¹³å°] é”™è¯¯:', error);
                showToast('âŒ åˆ›å»ºå¤±è´¥ï¼š' + error.message, 'error');
                if (event && event.target) {
                    event.target.textContent = 'ğŸš€ ç«‹å³åˆ›å»º';
                    event.target.disabled = false;
                }
            }
        }
    </script>
</body>
</html>

