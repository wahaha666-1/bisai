<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgentFlow - AIæ™ºèƒ½ä½“ç¼–æ’å¹³å°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .navbar {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            padding: 16px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 20px rgba(0,0,0,0.08);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .nav-menu {
            display: flex;
            gap: 24px;
            align-items: center;
        }
        
        .nav-item {
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            color: #666;
        }
        
        .nav-item:hover {
            background: #f5f5f5;
            color: #667eea;
        }
        
        .nav-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        /* ä¸»å®¹å™¨ */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 32px;
        }
        
        /* æ¬¢è¿åŒºåŸŸ */
        .welcome-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            padding: 48px;
            margin-bottom: 32px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .welcome-section h1 {
            font-size: 36px;
            margin-bottom: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .welcome-section p {
            font-size: 18px;
            color: #666;
            line-height: 1.6;
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 32px;
        }
        
        .action-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 32px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
        }
        
        .action-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
        }
        
        .action-card-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .action-card-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .action-card-desc {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* å¡ç‰‡åŒºåŸŸ */
        .cards-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .section-title {
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }
        
        /* ç½‘æ ¼å¸ƒå±€ */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }
        
        /* Agentå¡ç‰‡ */
        .agent-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            border: 2px solid #f0f0f0;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .agent-card:hover {
            border-color: #667eea;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.15);
            transform: translateY(-4px);
        }
        
        .agent-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        
        .agent-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .agent-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        
        .agent-desc {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
            margin-bottom: 16px;
        }
        
        .agent-stats {
            display: flex;
            gap: 16px;
            font-size: 12px;
            color: #999;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* å·¥ä½œæµå¡ç‰‡ */
        .workflow-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            border: 2px solid #f0f0f0;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .workflow-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }
        
        .workflow-card:hover {
            border-color: #667eea;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.15);
            transform: translateY(-4px);
        }
        
        .workflow-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        
        .workflow-desc {
            font-size: 14px;
            color: #666;
            margin-bottom: 16px;
        }
        
        .workflow-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }
        
        .btn-secondary {
            background: white;
            color: #667eea;
            border: 1px solid #667eea;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }
        
        .btn-icon {
            background: #f5f5f5;
            color: #666;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-icon:hover {
            background: #e0e0e0;
        }
        
        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }
        
        .empty-state-text {
            font-size: 16px;
            margin-bottom: 24px;
        }
        
        /* æ ‡ç­¾ */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .badge-success {
            background: #e8f5e9;
            color: #4caf50;
        }
        
        .badge-info {
            background: #e3f2fd;
            color: #2196f3;
        }
        
        .badge-warning {
            background: #fff3e0;
            color: #ff9800;
        }
        
        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="logo">
            <span>ğŸ¤–</span>
            <span>AgentFlow</span>
        </div>
        <div class="nav-menu">
            <div class="nav-item active" onclick="window.location.href='/'">å·¥ä½œå°</div>
            <div class="nav-item" onclick="window.location.href='/chat'">AIåŠ©æ‰‹</div>
            <div class="nav-item" onclick="window.location.href='/dashboard'">ç¤¾åŒºå¹¿åœº</div>
            <div class="nav-item" onclick="window.location.href='/workflow-editor'">å¯è§†åŒ–ç¼–è¾‘</div>
        </div>
    </nav>

    <!-- ä¸»å®¹å™¨ -->
    <div class="container">
        <!-- æ¬¢è¿åŒºåŸŸ -->
        <div class="welcome-section">
            <h1>ğŸ‘‹ æ¬¢è¿æ¥åˆ° AgentFlow</h1>
            <p>AIé©±åŠ¨çš„æ™ºèƒ½ä½“ç¼–æ’å¹³å° Â· ä½ä»£ç  Â· é›¶é—¨æ§› Â· å¿«é€Ÿæ„å»º</p>
            
            <div class="quick-actions">
                <div class="action-card" onclick="window.location.href='/chat'">
                    <div class="action-card-icon">ğŸ’¬</div>
                    <div class="action-card-title">å¯¹è¯åˆ›å»º</div>
                    <div class="action-card-desc">ç”¨è‡ªç„¶è¯­è¨€æè¿°éœ€æ±‚ï¼ŒAIè‡ªåŠ¨ç”ŸæˆAgentå’Œå·¥ä½œæµ</div>
                </div>
                
                <div class="action-card" onclick="openProfessionalCreateModal()">
                    <div class="action-card-icon">ğŸ› ï¸</div>
                    <div class="action-card-title">æ‰‹åŠ¨åˆ›å»º</div>
                    <div class="action-card-desc">ç¼–å†™Pythonä»£ç ï¼Œåˆ›å»ºè‡ªå®šä¹‰çš„ä¸“ä¸šAgent</div>
                </div>
                
                <div class="action-card" onclick="window.location.href='/workflow-editor'">
                    <div class="action-card-icon">ğŸ¨</div>
                    <div class="action-card-title">å¯è§†åŒ–ç¼–æ’</div>
                    <div class="action-card-desc">æ‹–æ‹½å¼è¿æ¥AgentèŠ‚ç‚¹ï¼Œè½»æ¾æ„å»ºå¤æ‚å·¥ä½œæµ</div>
                </div>
            </div>
        </div>

        <!-- Agentåº“ -->
        <div class="cards-section">
            <div class="section-header">
                <div class="section-title">
                    <span>ğŸ“¦</span>
                    <span>Agent åº“</span>
                    <span class="badge badge-info" id="agent-count">0 ä¸ª</span>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn-secondary" id="batch-manage-btn" onclick="toggleBatchMode()" style="display: none;">ğŸ“‹ æ‰¹é‡ç®¡ç†</button>
                    <button class="btn-primary" onclick="openProfessionalCreateModal()">â• åˆ›å»º Agent</button>
                </div>
            </div>
            
            <!-- æ‰¹é‡æ“ä½œå·¥å…·æ  -->
            <div id="batch-toolbar" style="display: none; margin: 16px 0; padding: 12px 16px; background: #f8f9fa; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <button class="btn-secondary" onclick="selectAllAgents()">å…¨é€‰</button>
                    <button class="btn-secondary" onclick="deselectAllAgents()">å–æ¶ˆ</button>
                    <span style="margin-left: 16px; color: #666;">å·²é€‰æ‹© <span id="selected-count">0</span> ä¸ªAgent</span>
                </div>
                <button class="btn-danger" onclick="batchDeleteAgents()">ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤ (<span id="delete-count">0</span>)</button>
            </div>
            
            <div class="grid" id="agent-grid">
                <div class="empty-state">
                    <div class="empty-state-icon">â³</div>
                    <div class="empty-state-text">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>

        <!-- å·¥ä½œæµ -->
        <div class="cards-section">
            <div class="section-header">
                <div class="section-title">
                    <span>ğŸ”„</span>
                    <span>å·¥ä½œæµ</span>
                    <span class="badge badge-success" id="workflow-count">0 ä¸ª</span>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button class="btn-primary" onclick="window.location.href='/workflow-editor'">ğŸ¨ å¯è§†åŒ–åˆ›å»º</button>
                    <button class="btn-secondary" onclick="openProfessionalCreateModal()">â• JSONåˆ›å»º</button>
                    <button class="btn-secondary" onclick="window.location.href='/upgrade-agents'" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">ğŸš€ å‡çº§ä¸­å¿ƒ</button>
                </div>
            </div>
            
            <div class="grid" id="workflow-grid">
                <div class="empty-state">
                    <div class="empty-state-icon">â³</div>
                    <div class="empty-state-text">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // åŠ è½½Agents
        async function loadAgents() {
            try {
                const response = await fetch('/api/agents');
                const data = await response.json();
                
                const grid = document.getElementById('agent-grid');
                document.getElementById('agent-count').textContent = `${data.length} ä¸ª`;
                
                if (data.length === 0) {
                    grid.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“¦</div>
                            <div class="empty-state-text">è¿˜æ²¡æœ‰Agentï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åˆ›å»ºç¬¬ä¸€ä¸ªå§ï¼</div>
                        </div>
                    `;
                    return;
                }
                
                grid.innerHTML = data.map(agent => `
                    <div class="agent-card" id="agent-${agent.id}" onclick="selectAgent(${agent.id}, event)">
                        <input type="checkbox" class="agent-checkbox" id="checkbox-${agent.id}" style="display: none; position: absolute; top: 12px; right: 12px; width: 20px; height: 20px; cursor: pointer;" onclick="event.stopPropagation(); toggleAgentSelect(${agent.id})">
                        <div class="agent-header">
                            <div class="agent-icon">${agent.icon || 'ğŸ¤–'}</div>
                        </div>
                        <div class="agent-name">${agent.name}</div>
                        <div class="agent-desc">${agent.description || 'æš‚æ— æè¿°'}</div>
                        <div class="agent-stats">
                            <div class="stat-item">
                                <span>âš¡</span>
                                <span>${agent.total_executions || 0} æ¬¡æ‰§è¡Œ</span>
                            </div>
                            <div class="stat-item">
                                <span>âœ…</span>
                                <span>${(agent.success_rate || 0).toFixed(1)}% æˆåŠŸç‡</span>
                            </div>
                        </div>
                        <div class="agent-actions" style="margin-top: 12px; display: flex; gap: 8px; justify-content: flex-end;">
                            <button class="btn-secondary" style="font-size: 12px; padding: 4px 12px;" onclick="event.stopPropagation(); alert('ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­')">âœï¸ ç¼–è¾‘</button>
                            <button class="btn-danger" style="font-size: 12px; padding: 4px 12px;" onclick="event.stopPropagation(); deleteAgent(${agent.id}, '${agent.name}')">ğŸ—‘ï¸ åˆ é™¤</button>
                        </div>
                    </div>
                `).join('');
                
                // æ˜¾ç¤ºæ‰¹é‡ç®¡ç†æŒ‰é’®
                if (data.length > 0) {
                    document.getElementById('batch-manage-btn').style.display = 'block';
                }
            } catch (error) {
                console.error('åŠ è½½Agentså¤±è´¥:', error);
            }
        }

        // åŠ è½½å·¥ä½œæµ
        async function loadWorkflows() {
            try {
                const response = await fetch('/api/workflows');
                const data = await response.json();
                
                const grid = document.getElementById('workflow-grid');
                document.getElementById('workflow-count').textContent = `${data.length} ä¸ª`;
                
                if (data.length === 0) {
                    grid.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ”„</div>
                            <div class="empty-state-text">è¿˜æ²¡æœ‰å·¥ä½œæµï¼Œå»åˆ›å»ºä¸€ä¸ªå§ï¼</div>
                        </div>
                    `;
                    return;
                }
                
                grid.innerHTML = data.map(workflow => `
                    <div class="workflow-card">
                        <div class="workflow-name">${workflow.name}</div>
                        <div class="workflow-desc">${workflow.description || 'æš‚æ— æè¿°'}</div>
                        <div class="agent-stats">
                            <div class="stat-item">
                                <span>âš¡</span>
                                <span>${workflow.total_executions || 0} æ¬¡æ‰§è¡Œ</span>
                            </div>
                            <div class="stat-item">
                                <span>âœ…</span>
                                <span>${(workflow.success_rate || 0).toFixed(1)}% æˆåŠŸç‡</span>
                            </div>
                        </div>
                        <div class="workflow-actions">
                            <button class="btn-secondary" onclick="executeWorkflow(${workflow.id}, '${workflow.name}')">â–¶ï¸ æ‰§è¡Œ</button>
                            <button class="btn-secondary" onclick="publishWorkflowAPI(${workflow.id}, '${workflow.name}')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">ğŸ”Œ å‘å¸ƒAPI</button>
                            <button class="btn-secondary" onclick="viewAPIKeys(${workflow.id}, '${workflow.name}')" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">ğŸ”‘ æŸ¥çœ‹å¯†é’¥</button>
                            <button class="btn-icon" onclick="window.open('/workflow-editor?id=${workflow.id}', '_blank')">âœï¸ ç¼–è¾‘</button>
                            <button class="btn-icon" onclick="deleteWorkflow(${workflow.id})">ğŸ—‘ï¸ åˆ é™¤</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½å·¥ä½œæµå¤±è´¥:', error);
            }
        }

        // æ‰§è¡Œå·¥ä½œæµ
        async function executeWorkflow(id, name) {
            // æ™ºèƒ½å‚æ•°æ¨¡æ¿
            let paramTemplate = {};
            if (name.includes('æ—…æ¸¸') || name.includes('travel')) {
                paramTemplate = {"destination": "åŒ—äº¬", "days": 3, "budget": 5000};
            } else if (name.includes('å†…å®¹åˆ›ä½œ') || name.includes('å…¨æ ˆ') || name.includes('æ–‡ç« ') || name.includes('content')) {
                paramTemplate = {"topic": "äººå·¥æ™ºèƒ½çš„æœªæ¥å‘å±•è¶‹åŠ¿", "keywords": "AI, æœºå™¨å­¦ä¹ ", "target_audience": "æŠ€æœ¯çˆ±å¥½è€…"};
            } else {
                paramTemplate = {"input_data": "è¯·è¾“å…¥å†…å®¹"};
            }
            
            // æ˜¾ç¤ºè‡ªå®šä¹‰è¾“å…¥å¯¹è¯æ¡†
            showWorkflowInputDialog(id, name, paramTemplate);
        }
        
        // æ˜¾ç¤ºå·¥ä½œæµå‚æ•°è¾“å…¥å¯¹è¯æ¡†
        function showWorkflowInputDialog(workflowId, workflowName, paramTemplate) {
            const oldDialog = document.getElementById('workflow-input-dialog');
            if (oldDialog) oldDialog.remove();
            
            const modal = document.createElement('div');
            modal.id = 'workflow-input-dialog';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
                display: flex; align-items: center; justify-content: center; z-index: 10000;
            `;
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                    <h3 style="margin: 0 0 16px 0; color: #1f2937; font-size: 18px;">æ‰§è¡Œå·¥ä½œæµï¼š${workflowName}</h3>
                    <p style="margin: 0 0 12px 0; color: #6b7280; font-size: 14px;">è¯·è¾“å…¥JSONæ ¼å¼çš„å‚æ•°ï¼š</p>
                    <textarea id="workflow-input-params" style="
                        width: 100%; height: 120px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px;
                        font-family: 'Consolas', monospace; font-size: 13px; resize: vertical;
                    ">${JSON.stringify(paramTemplate, null, 2)}</textarea>
                    <div id="input-error-message" style="margin-top: 12px; padding: 12px; background: #fee2e2; border-left: 4px solid #ef4444; border-radius: 4px; color: #dc2626; font-size: 13px; display: none;"></div>
                    <div style="margin-top: 20px; display: flex; gap: 12px; justify-content: flex-end;">
                        <button onclick="document.getElementById('workflow-input-dialog').remove()" style="
                            padding: 10px 20px; background: #f3f4f6; color: #374151; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;
                        ">å–æ¶ˆ</button>
                        <button onclick="executeWorkflowWithParams(${workflowId}, '${workflowName}')" style="
                            padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;
                        ">ç¡®å®š</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('workflow-input-params').focus();
        }
        
        // æ‰§è¡Œå·¥ä½œæµï¼ˆå¸¦å‚æ•°ï¼‰
        async function executeWorkflowWithParams(workflowId, workflowName) {
            const inputTextarea = document.getElementById('workflow-input-params');
            const errorDiv = document.getElementById('input-error-message');
            const inputParamsStr = inputTextarea.value;
            
            let params = {};
            try {
                params = JSON.parse(inputParamsStr);
                errorDiv.style.display = 'none';
            } catch (e) {
                errorDiv.textContent = 'âŒ JSON æ ¼å¼é”™è¯¯ï¼š' + e.message;
                errorDiv.style.display = 'block';
                return;
            }
            
            // å…³é—­è¾“å…¥å¯¹è¯æ¡†
            document.getElementById('workflow-input-dialog').remove();
            
            // ç«‹å³æ˜¾ç¤ºæ‰§è¡Œè¿›åº¦æ¨¡æ€æ¡†
            showExecutionModal(workflowName);
            
            // æµå¼è¾“å‡ºï¼šå¼€å§‹æ‰§è¡Œ
            await typeExecutionMessage(`ğŸš€ å¼€å§‹æ‰§è¡Œå·¥ä½œæµï¼š${workflowName}\n\n`);
            await typeExecutionMessage('ğŸ“ è¾“å…¥å‚æ•°ï¼š\n');
            await typeExecutionMessage(JSON.stringify(params, null, 2) + '\n\n');
            await typeExecutionMessage('â³ æ­£åœ¨è°ƒç”¨Agent...\n');
            
            updateExecutionProgress(30);
            
            try {
                const response = await fetch(`/api/workflows/${workflowId}/execute`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(params)
                });
                
                updateExecutionProgress(70);
                await typeExecutionMessage('âœ… Agentæ‰§è¡Œå®Œæˆ\n');
                await typeExecutionMessage('ğŸ“Š æ­£åœ¨è§£æç»“æœ...\n\n');
                
                const result = await response.json();
                updateExecutionProgress(100);
                
                if (result.success) {
                    await typeExecutionMessage('ğŸ‰ æ‰§è¡ŒæˆåŠŸï¼\n\n');
                    // æ˜¾ç¤ºè¯¦ç»†ç»“æœ
                    await displayWorkflowResult(result);
                } else {
                    await typeExecutionMessage(`âŒ æ‰§è¡Œå¤±è´¥ï¼š${result.error}\n`);
                }
            } catch (error) {
                await typeExecutionMessage(`âŒ é”™è¯¯ï¼š${error.message}\n`);
            }
        }
        
        // æ˜¾ç¤ºæ‰§è¡Œè¿›åº¦æ¨¡æ€æ¡†
        function showExecutionModal(workflowName) {
            // ç§»é™¤æ—§çš„æ¨¡æ€æ¡†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const oldModal = document.getElementById('execution-modal');
            if (oldModal) oldModal.remove();
            
            const modal = document.createElement('div');
            modal.id = 'execution-modal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
                display: flex; align-items: center; justify-content: center; 
                z-index: 10000; animation: fadeIn 0.3s;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white; border-radius: 20px; width: 90%; max-width: 800px;
                    max-height: 85vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                    animation: slideUp 0.3s; display: flex; flex-direction: column;
                ">
                    <div style="
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white; padding: 24px; display: flex; justify-content: space-between; align-items: center;
                    ">
                        <h2 style="margin: 0; font-size: 22px;">âš¡ å·¥ä½œæµæ‰§è¡Œä¸­</h2>
                        <button onclick="closeExecutionModal()" style="
                            background: rgba(255,255,255,0.2); border: none; color: white;
                            width: 32px; height: 32px; border-radius: 50%; cursor: pointer;
                            font-size: 20px; display: flex; align-items: center; justify-content: center;
                            transition: all 0.3s;
                        ">Ã—</button>
                    </div>
                    
                    <div style="padding: 24px; flex: 1; overflow-y: auto;">
                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="color: #6b7280; font-size: 14px;">æ‰§è¡Œè¿›åº¦</span>
                                <span id="execution-progress-text" style="color: #667eea; font-weight: 600;">0%</span>
                            </div>
                            <div style="width: 100%; height: 12px; background: rgba(102, 126, 234, 0.2); border-radius: 6px; overflow: hidden;">
                                <div id="execution-progress-bar" style="
                                    height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    width: 0%; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
                                "></div>
                            </div>
                        </div>
                        
                        <div id="execution-log" style="
                            background: #1f2937; color: #f9fafb; padding: 20px; border-radius: 12px;
                            font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.8;
                            min-height: 300px; max-height: 500px; overflow-y: auto;
                        "></div>
                        
                        <div id="execution-result-container" style="margin-top: 20px; display: none;"></div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // å…³é—­æ‰§è¡Œæ¨¡æ€æ¡†
        function closeExecutionModal() {
            const modal = document.getElementById('execution-modal');
            if (modal) modal.remove();
        }
        
        // æµå¼è¾“å‡ºæ‰§è¡Œæ¶ˆæ¯
        async function typeExecutionMessage(message, speed = 20) {
            const logDiv = document.getElementById('execution-log');
            if (!logDiv) return;
            
            for (let char of message) {
                logDiv.innerHTML += char === '\n' ? '<br>' : char;
                logDiv.scrollTop = logDiv.scrollHeight;
                
                if (char !== '\n' && Math.random() > 0.6) {
                    await sleep(speed);
                }
            }
        }
        
        // æ›´æ–°æ‰§è¡Œè¿›åº¦
        function updateExecutionProgress(percent) {
            const bar = document.getElementById('execution-progress-bar');
            const text = document.getElementById('execution-progress-text');
            if (bar) bar.style.width = percent + '%';
            if (text) text.textContent = Math.round(percent) + '%';
        }
        
        // æ˜¾ç¤ºå·¥ä½œæµç»“æœ
        async function displayWorkflowResult(result) {
            const container = document.getElementById('execution-result-container');
            if (!container) return;
            
            // æå–å…³é”®ç»“æœ
            let outputHTML = '';
            if (result.output) {
                let finalContent = null;
                
                if (result.output.seoä¼˜åŒ–_result?.result?.final_content) {
                    finalContent = result.output.seoä¼˜åŒ–_result.result.final_content;
                } else if (result.output.å†…å®¹åˆ›ä½œ_result?.result?.content) {
                    finalContent = result.output.å†…å®¹åˆ›ä½œ_result.result.content;
                }
                
                if (finalContent) {
                    outputHTML = `
                        <div style="
                            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
                            padding: 20px; border-radius: 12px; border-left: 4px solid #10b981;
                        ">
                            <h3 style="margin: 0 0 16px 0; color: #065f46; display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 24px;">ğŸ“„</span>
                                <span>ç”Ÿæˆçš„æ–‡ç« </span>
                            </h3>
                            <div style="
                                background: white; padding: 24px; border-radius: 8px;
                                max-height: 400px; overflow-y: auto; white-space: pre-wrap;
                                font-family: 'Microsoft YaHei', sans-serif; line-height: 1.8;
                                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                            ">${finalContent}</div>
                        </div>
                        
                        <details style="margin-top: 16px;">
                            <summary style="
                                cursor: pointer; font-weight: 600; color: #667eea; 
                                padding: 12px; background: #f3f4f6; border-radius: 8px;
                                transition: all 0.3s;
                            ">ğŸ“Š æŸ¥çœ‹å®Œæ•´è¾“å‡ºæ•°æ®</summary>
                            <pre style="
                                background: #1f2937; color: #f9fafb; padding: 16px; 
                                border-radius: 8px; overflow-x: auto; margin-top: 12px; 
                                font-size: 12px; line-height: 1.6;
                            ">${JSON.stringify(result.output, null, 2)}</pre>
                        </details>
                    `;
                } else {
                    outputHTML = `
                        <div style="
                            background: #f3f4f6; padding: 16px; border-radius: 8px;
                            border-left: 4px solid #667eea;
                        ">
                            <h3 style="margin: 0 0 12px 0; color: #4b5563;">ğŸ“Š æ‰§è¡Œè¾“å‡º</h3>
                            <pre style="
                                background: #1f2937; color: #f9fafb; padding: 16px; 
                                border-radius: 8px; overflow-x: auto; font-size: 13px; 
                                line-height: 1.6; margin: 0;
                            ">${JSON.stringify(result.output, null, 2)}</pre>
                        </div>
                    `;
                }
            } else {
                outputHTML = `
                    <div style="
                        background: #fef3c7; padding: 16px; border-radius: 8px;
                        border-left: 4px solid #f59e0b;
                    ">
                        <p style="margin: 0; color: #92400e;">âš ï¸ æœªè·å–åˆ°è¾“å‡ºæ•°æ®</p>
                    </div>
                `;
            }
            
            // é€å­—æ˜¾ç¤ºç»“æœ
            await typeExecutionMessage('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n');
            container.style.display = 'block';
            container.innerHTML = outputHTML;
        }
        
        // ç¡çœ å‡½æ•°
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // æ˜¾ç¤ºæ‰§è¡Œç»“æœè¯¦æƒ…ï¼ˆæ—§å‡½æ•°ï¼Œä¿ç•™å…¼å®¹æ€§ï¼‰
        function showExecutionResult(workflowName, result) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
                display: flex; align-items: center; justify-content: center; z-index: 10000;
            `;
            
            // æå–å…³é”®ç»“æœ
            let outputDisplay = '';
            if (result.output) {
                // æŸ¥æ‰¾æœ€ç»ˆå†…å®¹ï¼ˆé€šå¸¸åœ¨seoä¼˜åŒ–æˆ–å†…å®¹åˆ›ä½œçš„ç»“æœä¸­ï¼‰
                let finalContent = null;
                
                if (result.output.seoä¼˜åŒ–_result?.result?.final_content) {
                    finalContent = result.output.seoä¼˜åŒ–_result.result.final_content;
                } else if (result.output.å†…å®¹åˆ›ä½œ_result?.result?.content) {
                    finalContent = result.output.å†…å®¹åˆ›ä½œ_result.result.content;
                }
                
                if (finalContent) {
                    outputDisplay = `
                        <div style="margin-bottom: 20px;">
                            <h3 style="margin: 0 0 12px 0; color: #4b5563;">ğŸ“„ ç”Ÿæˆçš„æ–‡ç« ï¼š</h3>
                            <div style="
                                background: #f9fafb; padding: 20px; border-radius: 8px; 
                                max-height: 400px; overflow-y: auto; 
                                border: 2px solid #e5e7eb; white-space: pre-wrap;
                                font-family: 'Microsoft YaHei', sans-serif; line-height: 1.8;
                            ">${finalContent}</div>
                        </div>
                        
                        <details style="margin-top: 16px;">
                            <summary style="cursor: pointer; font-weight: 600; color: #667eea; padding: 8px; background: #f3f4f6; border-radius: 4px;">
                                ğŸ“Š æŸ¥çœ‹å®Œæ•´è¾“å‡ºæ•°æ®
                            </summary>
                            <pre style="background: #1f2937; color: #f9fafb; padding: 16px; border-radius: 8px; overflow-x: auto; margin-top: 12px; font-size: 12px;">${JSON.stringify(result.output, null, 2)}</pre>
                        </details>
                    `;
                } else {
                    outputDisplay = `
                        <pre style="background: #1f2937; color: #f9fafb; padding: 16px; border-radius: 8px; overflow-x: auto; max-height: 400px; font-size: 13px;">${JSON.stringify(result.output, null, 2)}</pre>
                    `;
                }
            } else {
                outputDisplay = '<div style="color: #9ca3af;">æ— è¾“å‡ºæ•°æ®</div>';
            }
            
            modal.innerHTML = `
                <div style="
                    background: white; border-radius: 16px; padding: 32px;
                    max-width: 900px; width: 90%; max-height: 85vh; overflow-y: auto;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="margin: 0; color: #1a1a1a; font-size: 24px;">
                            âœ… æ‰§è¡ŒæˆåŠŸï¼š${workflowName}
                        </h2>
                        <div style="font-size: 14px; color: #6b7280;">
                            æ‰§è¡ŒID: #${result.execution_id || 'N/A'}
                        </div>
                    </div>
                    
                    ${outputDisplay}
                    
                    <button onclick="this.closest('[style*=\\'position: fixed\\']').remove()" style="
                        width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;
                        border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; margin-top: 20px;
                    ">å…³é—­</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
        }
        
        // Toasté€šçŸ¥
        function showToast(message, type = 'info') {
            const colors = {
                success: '#10b981',
                error: '#ef4444',
                info: '#3b82f6'
            };
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed; top: 20px; right: 20px; padding: 16px 24px;
                background: ${colors[type]}; color: white; border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000;
                animation: slideIn 0.3s ease-out;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        // ============================================
        // æ‰¹é‡ç®¡ç†åŠŸèƒ½
        // ============================================
        let batchMode = false;
        let selectedAgents = new Set();
        
        function toggleBatchMode() {
            batchMode = !batchMode;
            const checkboxes = document.querySelectorAll('.agent-checkbox');
            const toolbar = document.getElementById('batch-toolbar');
            const btn = document.getElementById('batch-manage-btn');
            
            if (batchMode) {
                checkboxes.forEach(cb => cb.style.display = 'block');
                toolbar.style.display = 'flex';
                btn.textContent = 'âœ–ï¸ é€€å‡ºæ‰¹é‡';
                btn.classList.add('btn-danger');
                btn.classList.remove('btn-secondary');
            } else {
                checkboxes.forEach(cb => {
                    cb.style.display = 'none';
                    cb.checked = false;
                });
                toolbar.style.display = 'none';
                btn.textContent = 'ğŸ“‹ æ‰¹é‡ç®¡ç†';
                btn.classList.add('btn-secondary');
                btn.classList.remove('btn-danger');
                selectedAgents.clear();
                updateSelectedCount();
            }
        }
        
        function toggleAgentSelect(id) {
            const checkbox = document.getElementById(`checkbox-${id}`);
            if (checkbox.checked) {
                selectedAgents.add(id);
            } else {
                selectedAgents.delete(id);
            }
            updateSelectedCount();
        }
        
        function selectAgent(id, event) {
            if (batchMode && event.target.classList.contains('agent-card')) {
                const checkbox = document.getElementById(`checkbox-${id}`);
                checkbox.checked = !checkbox.checked;
                toggleAgentSelect(id);
            }
        }
        
        function selectAllAgents() {
            document.querySelectorAll('.agent-checkbox').forEach(cb => {
                cb.checked = true;
                const id = parseInt(cb.id.replace('checkbox-', ''));
                selectedAgents.add(id);
            });
            updateSelectedCount();
        }
        
        function deselectAllAgents() {
            document.querySelectorAll('.agent-checkbox').forEach(cb => {
                cb.checked = false;
            });
            selectedAgents.clear();
            updateSelectedCount();
        }
        
        function updateSelectedCount() {
            document.getElementById('selected-count').textContent = selectedAgents.size;
            document.getElementById('delete-count').textContent = selectedAgents.size;
        }
        
        async function batchDeleteAgents() {
            if (selectedAgents.size === 0) {
                showToast('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„Agent', 'error');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedAgents.size} ä¸ªAgentå—ï¼Ÿ`)) {
                return;
            }
            
            showToast('æ‰¹é‡åˆ é™¤ä¸­...', 'info');
            let successCount = 0;
            let failCount = 0;
            
            for (const id of selectedAgents) {
                try {
                    const response = await fetch(`/api/agents/${id}`, { method: 'DELETE' });
                    if (response.ok) {
                        successCount++;
                        document.getElementById(`agent-${id}`).remove();
                    } else {
                        failCount++;
                    }
                } catch (error) {
                    failCount++;
                }
            }
            
            selectedAgents.clear();
            toggleBatchMode();
            
            if (failCount === 0) {
                showToast(`âœ… æˆåŠŸåˆ é™¤ ${successCount} ä¸ªAgent`, 'success');
            } else {
                showToast(`åˆ é™¤å®Œæˆï¼šæˆåŠŸ ${successCount}ï¼Œå¤±è´¥ ${failCount}`, 'error');
            }
            
            loadAgents();
        }
        
        async function deleteAgent(id, name) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ "${name}" å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/agents/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    showToast('âœ… åˆ é™¤æˆåŠŸ', 'success');
                    loadAgents();
                } else {
                    showToast('âŒ åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('âŒ åˆ é™¤å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // åˆ é™¤å·¥ä½œæµ
        async function deleteWorkflow(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå·¥ä½œæµå—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`/api/workflows/${id}`, {method: 'DELETE'});
                if (response.ok) {
                    alert('âœ… åˆ é™¤æˆåŠŸ');
                    loadWorkflows();
                }
            } catch (error) {
                alert('âŒ åˆ é™¤å¤±è´¥ï¼š' + error.message);
            }
        }

        // æ‰“å¼€ä¸“ä¸šåˆ›å»ºæ¨¡æ€æ¡†
        function openProfessionalCreateModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); z-index: 10001;
                display: flex; align-items: center; justify-content: center;
                animation: fadeIn 0.3s ease-out;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white; border-radius: 16px; padding: 32px;
                    max-width: 800px; width: 90%; max-height: 85vh; overflow-y: auto;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                ">
                    <h2 style="margin: 0 0 24px 0; color: #1a1a1a; font-size: 24px;">
                        ğŸ› ï¸ ä¸“ä¸šåˆ›å»ºæ¨¡å¼
                    </h2>
                    
                    <div style="background: #f0f9ff; border: 2px solid #3b82f6; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                        <strong>ğŸ’¡ æç¤ºï¼š</strong>
                        <div style="color: #1e40af; margin-top: 8px;">
                            ä¸“ä¸šåˆ›å»ºæ¨¡å¼é€‚åˆæœ‰Pythonç¼–ç¨‹ç»éªŒçš„ç”¨æˆ·ï¼Œå¯ä»¥ç¼–å†™è‡ªå®šä¹‰Agentä»£ç å’Œå·¥ä½œæµé…ç½®ã€‚
                        </div>
                    </div>
                    
                    <!-- Agentåˆ›å»ºè¡¨å• -->
                    <div style="margin-bottom: 20px;">
                        <h3 style="margin: 0 0 16px 0; color: #374151; font-size: 18px;">åˆ›å»ºAgent</h3>
                        
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; margin-bottom: 4px; font-weight: 600; color: #374151;">Agentåç§°</label>
                            <input type="text" id="pro-agent-name" placeholder="ä¾‹å¦‚ï¼šdata_processor" style="
                                width: 100%; padding: 10px; border: 2px solid #e5e7eb;
                                border-radius: 8px; font-size: 14px; box-sizing: border-box;
                            ">
                        </div>
                        
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; margin-bottom: 4px; font-weight: 600; color: #374151;">æè¿°</label>
                            <input type="text" id="pro-agent-desc" placeholder="ç®€è¦æè¿°AgentåŠŸèƒ½" style="
                                width: 100%; padding: 10px; border: 2px solid #e5e7eb;
                                border-radius: 8px; font-size: 14px; box-sizing: border-box;
                            ">
                        </div>
                        
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; margin-bottom: 4px; font-weight: 600; color: #374151;">Pythonä»£ç </label>
                            <textarea id="pro-agent-code" placeholder="def my_agent(input_data: dict) -> dict:
    '''AgentåŠŸèƒ½è¯´æ˜'''
    try:
        # å¤„ç†é€»è¾‘
        result = input_data
        return {'success': True, 'result': result}
    except Exception as e:
        return {'success': False, 'error': str(e)}" style="
                                width: 100%; padding: 12px; border: 2px solid #e5e7eb;
                                border-radius: 8px; font-size: 13px; font-family: monospace;
                                min-height: 200px; box-sizing: border-box;
                            "></textarea>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                                âš ï¸ è¯·ç¡®ä¿å‡½æ•°ç­¾åä¸ºï¼š<code>def agent_name(input_data: dict) -> dict</code>
                            </div>
                        </div>
                        
                        <button onclick="createProfessionalAgent()" style="
                            width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600;
                        ">âœ… åˆ›å»ºAgent</button>
                    </div>
                    
                    <div style="border-top: 2px solid #e5e7eb; padding-top: 20px;">
                        <h3 style="margin: 0 0 16px 0; color: #374151; font-size: 18px;">åˆ›å»ºå·¥ä½œæµï¼ˆJSONï¼‰</h3>
                        
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; margin-bottom: 4px; font-weight: 600; color: #374151;">å·¥ä½œæµé…ç½®ï¼ˆJSONï¼‰</label>
                            <textarea id="pro-workflow-json" placeholder='{
  "name": "æˆ‘çš„å·¥ä½œæµ",
  "description": "å·¥ä½œæµæè¿°",
  "workflow_definition": {
    "agents": ["agent1", "agent2"],
    "sequence": [
      {
        "agent": "agent1",
        "input_mapping": {"input_data": "$.input"},
        "output_key": "agent1"
      },
      {
        "agent": "agent2",
        "input_mapping": {"input_data": "$.agent1.result"},
        "output_key": "agent2"
      }
    ]
  }
}' style="
                                width: 100%; padding: 12px; border: 2px solid #e5e7eb;
                                border-radius: 8px; font-size: 13px; font-family: monospace;
                                min-height: 200px; box-sizing: border-box;
                            "></textarea>
                        </div>
                        
                        <button onclick="createProfessionalWorkflow()" style="
                            width: 100%; padding: 12px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                            color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600;
                        ">âœ… åˆ›å»ºå·¥ä½œæµ</button>
                    </div>
                    
                    <button onclick="this.closest('[style*=\\'position: fixed\\']').remove()" style="
                        width: 100%; padding: 12px; background: #f3f4f6; color: #374151; margin-top: 20px;
                        border: none; border-radius: 8px; cursor: pointer; font-size: 16px;
                    ">å…³é—­</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
        }
        
        async function createProfessionalAgent() {
            const name = document.getElementById('pro-agent-name').value.trim();
            const desc = document.getElementById('pro-agent-desc').value.trim();
            const code = document.getElementById('pro-agent-code').value.trim();
            
            if (!name || !code) {
                showToast('âŒ è¯·å¡«å†™Agentåç§°å’Œä»£ç ', 'error');
                return;
            }
            
            showToast('åˆ›å»ºä¸­...', 'info');
            
            try {
                const response = await fetch('/api/agents', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        name: name,
                        description: desc,
                        code: code,
                        agent_type: 'processor'
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showToast('âœ… Agentåˆ›å»ºæˆåŠŸï¼', 'success');
                    document.querySelectorAll('[style*="position: fixed"]').forEach(m => m.remove());
                    loadAgents();
                } else {
                    showToast('âŒ åˆ›å»ºå¤±è´¥ï¼š' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                showToast('âŒ åˆ›å»ºå¤±è´¥ï¼š' + error.message, 'error');
            }
        }
        
        async function createProfessionalWorkflow() {
            const jsonStr = document.getElementById('pro-workflow-json').value.trim();
            
            if (!jsonStr) {
                showToast('âŒ è¯·å¡«å†™å·¥ä½œæµé…ç½®', 'error');
                return;
            }
            
            try {
                const config = JSON.parse(jsonStr);
                
                showToast('åˆ›å»ºä¸­...', 'info');
                
                const response = await fetch('/api/workflows', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showToast('âœ… å·¥ä½œæµåˆ›å»ºæˆåŠŸï¼', 'success');
                    document.querySelectorAll('[style*="position: fixed"]').forEach(m => m.remove());
                    loadWorkflows();
                } else {
                    showToast('âŒ åˆ›å»ºå¤±è´¥ï¼š' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (e) {
                if (e instanceof SyntaxError) {
                    showToast('âŒ JSONæ ¼å¼é”™è¯¯ï¼š' + e.message, 'error');
                } else {
                    showToast('âŒ åˆ›å»ºå¤±è´¥ï¼š' + e.message, 'error');
                }
            }
        }

        // ============================================
        // APIå‘å¸ƒåŠŸèƒ½
        // ============================================
        
        async function publishWorkflowAPI(workflowId, workflowName) {
            // ğŸ¨ ä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ€æ¡†æ›¿ä»£åŸç”Ÿprompt
            showCustomPrompt(
                `ä¸º"${workflowName}"çš„APIå¯†é’¥èµ·ä¸ªåå­—ï¼š`,
                'Default API Key',
                async (keyName) => {
                    if (!keyName) return;
                    
                    showToast('ç”ŸæˆAPIå¯†é’¥ä¸­...', 'info');
            
                    try {
                        const response = await fetch(`/api/workflows/${workflowId}/publish`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({name: keyName})
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            showToast('âœ… APIå‘å¸ƒæˆåŠŸï¼', 'success');
                            showAPIKeyModal(data);
                        } else {
                            showToast('âŒ å‘å¸ƒå¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                        }
                    } catch (error) {
                        showToast('âŒ å‘å¸ƒå¤±è´¥ï¼š' + error.message, 'error');
                    }
                }
            );
        }
        
        // ğŸ¨ è‡ªå®šä¹‰Promptæ¨¡æ€æ¡†
        function showCustomPrompt(message, defaultValue, callback) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); z-index: 10001;
                display: flex; align-items: center; justify-content: center;
                animation: fadeIn 0.3s ease-out;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white; border-radius: 16px; padding: 32px;
                    max-width: 500px; width: 90%;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                ">
                    <h3 style="margin: 0 0 20px 0; color: #1a1a1a; font-size: 20px;">
                        ${message}
                    </h3>
                    
                    <input type="text" id="custom-prompt-input" value="${defaultValue}" style="
                        width: 100%; padding: 12px; border: 2px solid #e5e7eb;
                        border-radius: 8px; font-size: 16px; box-sizing: border-box;
                        transition: border-color 0.3s;
                    " />
                    
                    <div style="display: flex; gap: 12px; margin-top: 24px;">
                        <button id="custom-prompt-cancel" style="
                            flex: 1; padding: 12px; background: #f3f4f6; color: #374151;
                            border: none; border-radius: 8px; cursor: pointer; font-size: 16px;
                            transition: background 0.3s;
                        ">å–æ¶ˆ</button>
                        <button id="custom-prompt-confirm" style="
                            flex: 1; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;
                            transition: transform 0.2s;
                        ">ç¡®å®š</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            const input = document.getElementById('custom-prompt-input');
            const confirmBtn = document.getElementById('custom-prompt-confirm');
            const cancelBtn = document.getElementById('custom-prompt-cancel');
            
            input.focus();
            input.select();
            
            // Enteré”®ç¡®è®¤
            input.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    callback(input.value);
                    modal.remove();
                } else if (e.key === 'Escape') {
                    modal.remove();
                }
            };
            
            confirmBtn.onclick = () => {
                callback(input.value);
                modal.remove();
            };
            
            cancelBtn.onclick = () => modal.remove();
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            
            // æ‚¬åœæ•ˆæœ
            confirmBtn.onmouseenter = () => confirmBtn.style.transform = 'scale(1.02)';
            confirmBtn.onmouseleave = () => confirmBtn.style.transform = 'scale(1)';
            cancelBtn.onmouseenter = () => cancelBtn.style.background = '#e5e7eb';
            cancelBtn.onmouseleave = () => cancelBtn.style.background = '#f3f4f6';
            input.onfocus = () => input.style.borderColor = '#667eea';
            input.onblur = () => input.style.borderColor = '#e5e7eb';
        }
        
        function showAPIKeyModal(data) {
            // åˆ›å»ºæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); z-index: 10000;
                display: flex; align-items: center; justify-content: center;
                animation: fadeIn 0.3s ease-out;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white; border-radius: 16px; padding: 32px;
                    max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                ">
                    <h2 style="margin: 0 0 24px 0; color: #1a1a1a; font-size: 24px; display: flex; align-items: center; gap: 12px;">
                        ğŸ”Œ APIå‘å¸ƒæˆåŠŸï¼
                    </h2>
                    
                    <div style="background: #f0f9ff; border: 2px solid #3b82f6; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                        <div style="font-weight: 600; margin-bottom: 8px;">ğŸ”‘ APIå¯†é’¥ï¼š</div>
                        <div style="background: white; padding: 12px; border-radius: 4px; font-family: monospace; word-break: break-all; font-size: 14px;">
                            ${data.api_key}
                        </div>
                        <button onclick="copyToClipboard('${data.api_key}', 'API Key')" style="
                            margin-top: 8px; padding: 8px 16px; background: #3b82f6; color: white;
                            border: none; border-radius: 4px; cursor: pointer; font-size: 14px;
                        ">ğŸ“‹ å¤åˆ¶å¯†é’¥</button>
                    </div>
                    
                    <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                        <strong>âš ï¸ é‡è¦æç¤ºï¼š</strong>
                        <ul style="margin: 8px 0 0 0; padding-left: 20px; color: #92400e;">
                            <li>è¯·ç«‹å³å¤åˆ¶å¹¶å¦¥å–„ä¿ç®¡æ­¤å¯†é’¥</li>
                            <li>å¯†é’¥æ³„éœ²å¯èƒ½å¯¼è‡´å·¥ä½œæµè¢«æ»¥ç”¨</li>
                            <li>å¦‚éœ€æ’¤é”€ï¼Œè¯·åœ¨å·¥ä½œå°åˆ é™¤è¯¥å¯†é’¥</li>
                        </ul>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <h3 style="margin: 0 0 12px 0; color: #4b5563;">ğŸ“¡ APIæ¥å£åœ°å€ï¼š</h3>
                        <div style="background: #f9fafb; padding: 12px; border-radius: 4px; font-family: monospace; font-size: 14px;">
                            POST ${window.location.origin}/api/public/execute
                        </div>
                    </div>
                    
                    <h3 style="margin: 24px 0 12px 0; color: #4b5563;">ğŸ“š è°ƒç”¨ç¤ºä¾‹ï¼š</h3>
                    
                    <!-- cURLç¤ºä¾‹ -->
                    <div style="margin-bottom: 16px;">
                        <div style="font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                            <span>ğŸš cURL</span>
                            <button onclick="copyToClipboard(\`${data.examples.curl.replace(/`/g, '\\`')}\`, 'cURLç¤ºä¾‹')" style="
                                padding: 4px 12px; background: #10b981; color: white;
                                border: none; border-radius: 4px; cursor: pointer; font-size: 12px;
                            ">å¤åˆ¶</button>
                        </div>
                        <pre style="background: #1f2937; color: #f9fafb; padding: 16px; border-radius: 8px; overflow-x: auto; margin: 0; font-size: 13px;"><code>${data.examples.curl}</code></pre>
                    </div>
                    
                    <!-- Pythonç¤ºä¾‹ -->
                    <div style="margin-bottom: 16px;">
                        <div style="font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                            <span>ğŸ Python</span>
                            <button onclick="copyToClipboard(\`${data.examples.python.replace(/`/g, '\\`')}\`, 'Pythonç¤ºä¾‹')" style="
                                padding: 4px 12px; background: #10b981; color: white;
                                border: none; border-radius: 4px; cursor: pointer; font-size: 12px;
                            ">å¤åˆ¶</button>
                        </div>
                        <pre style="background: #1f2937; color: #f9fafb; padding: 16px; border-radius: 8px; overflow-x: auto; margin: 0; font-size: 13px;"><code>${data.examples.python}</code></pre>
                    </div>
                    
                    <!-- JavaScriptç¤ºä¾‹ -->
                    <div style="margin-bottom: 24px;">
                        <div style="font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                            <span>âš¡ JavaScript</span>
                            <button onclick="copyToClipboard(\`${data.examples.javascript.replace(/`/g, '\\`')}\`, 'JavaScriptç¤ºä¾‹')" style="
                                padding: 4px 12px; background: #10b981; color: white;
                                border: none; border-radius: 4px; cursor: pointer; font-size: 12px;
                            ">å¤åˆ¶</button>
                        </div>
                        <pre style="background: #1f2937; color: #f9fafb; padding: 16px; border-radius: 8px; overflow-x: auto; margin: 0; font-size: 13px;"><code>${data.examples.javascript}</code></pre>
                    </div>
                    
                    <button onclick="this.closest('[style*=\\'position: fixed\\']').remove()" style="
                        width: 100%; padding: 12px; background: #6366f1; color: white;
                        border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600;
                    ">âœ… å®Œæˆ</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
        }
        
        function copyToClipboard(text, label = 'å†…å®¹') {
            navigator.clipboard.writeText(text).then(() => {
                showToast(`âœ… ${label}å·²å¤åˆ¶`, 'success');
            }).catch(err => {
                showToast(`âŒ å¤åˆ¶å¤±è´¥`, 'error');
            });
        }
        
        // ============================================
        // æŸ¥çœ‹å’Œç®¡ç†APIå¯†é’¥
        // ============================================
        
        async function viewAPIKeys(workflowId, workflowName) {
            showToast('åŠ è½½å¯†é’¥åˆ—è¡¨...', 'info');
            
            try {
                const response = await fetch(`/api/workflows/${workflowId}/api-keys`);
                const data = await response.json();
                
                if (data.success) {
                    showAPIKeysModal(workflowId, workflowName, data.keys);
                } else {
                    showToast('âŒ åŠ è½½å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('âŒ åŠ è½½å¤±è´¥ï¼š' + error.message, 'error');
            }
        }
        
        function showAPIKeysModal(workflowId, workflowName, keys) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); z-index: 10000;
                display: flex; align-items: center; justify-content: center;
                animation: fadeIn 0.3s ease-out;
            `;
            
            const keysHTML = keys.length === 0 ? `
                <div style="text-align: center; padding: 40px; color: #9ca3af;">
                    <div style="font-size: 48px; margin-bottom: 16px;">ğŸ”</div>
                    <div style="font-size: 18px; margin-bottom: 8px;">è¿˜æ²¡æœ‰APIå¯†é’¥</div>
                    <div style="font-size: 14px;">ç‚¹å‡»ã€ğŸ”Œ å‘å¸ƒAPIã€‘åˆ›å»ºç¬¬ä¸€ä¸ªå¯†é’¥</div>
                </div>
            ` : keys.map(key => `
                <div style="
                    background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 12px;
                    padding: 16px; margin-bottom: 12px;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div>
                            <div style="font-weight: 600; font-size: 16px; color: #1f2937;">${key.name}</div>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                                åˆ›å»ºäº ${new Date(key.created_date).toLocaleString('zh-CN')}
                            </div>
                        </div>
                        <div>
                            ${key.is_active ? 
                                '<span style="background: #d1fae5; color: #065f46; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">âœ… æ´»è·ƒ</span>' : 
                                '<span style="background: #fee2e2; color: #991b1b; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">âŒ å·²ç¦ç”¨</span>'
                            }
                        </div>
                    </div>
                    
                    <div style="
                        background: white; padding: 12px; border-radius: 8px;
                        font-family: monospace; font-size: 13px; word-break: break-all;
                        margin-bottom: 12px; border: 1px solid #e5e7eb;
                    ">${key.api_key}</div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 12px; color: #6b7280;">
                            <span>ğŸ“Š è°ƒç”¨æ¬¡æ•°: ${key.calls_count}</span>
                            <span style="margin-left: 16px;">ğŸ• æœ€åä½¿ç”¨: ${key.last_used ? new Date(key.last_used).toLocaleString('zh-CN') : 'ä»æœªä½¿ç”¨'}</span>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="event.stopPropagation(); copyToClipboard('${key.api_key}', 'API Key')" style="
                                padding: 6px 12px; background: #3b82f6; color: white;
                                border: none; border-radius: 6px; cursor: pointer; font-size: 12px;
                            ">ğŸ“‹ å¤åˆ¶</button>
                            <button onclick="event.stopPropagation(); deleteAPIKey(${key.id}, '${key.name}', ${workflowId}, '${workflowName}')" style="
                                padding: 6px 12px; background: #ef4444; color: white;
                                border: none; border-radius: 6px; cursor: pointer; font-size: 12px;
                            ">ğŸ—‘ï¸ åˆ é™¤</button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            modal.innerHTML = `
                <div style="
                    background: white; border-radius: 16px; padding: 32px;
                    max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="margin: 0; color: #1a1a1a; font-size: 24px;">
                            ğŸ”‘ APIå¯†é’¥ç®¡ç†
                        </h2>
                        <div style="font-size: 14px; color: #6b7280;">
                            å·¥ä½œæµ: ${workflowName}
                        </div>
                    </div>
                    
                    ${keys.length > 0 ? `
                        <div style="background: #eff6ff; border: 2px solid #3b82f6; border-radius: 8px; padding: 12px; margin-bottom: 20px;">
                            <strong>ğŸ’¡ æç¤ºï¼š</strong>
                            <ul style="margin: 8px 0 0 0; padding-left: 20px; color: #1e40af;">
                                <li>APIå¯†é’¥æ°¸ä¹…ä¿å­˜ï¼Œå…³é—­æµè§ˆå™¨åä¾ç„¶æœ‰æ•ˆ</li>
                                <li>è¯·å¦¥å–„ä¿ç®¡å¯†é’¥ï¼Œé¿å…æ³„éœ²</li>
                                <li>å¯ä»¥åˆ›å»ºå¤šä¸ªå¯†é’¥ç”¨äºä¸åŒåœºæ™¯</li>
                            </ul>
                        </div>
                    ` : ''}
                    
                    <div style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
                        ${keysHTML}
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button onclick="publishWorkflowAPI(${workflowId}, '${workflowName}'); this.closest('[style*=\\'position: fixed\\']').remove();" style="
                            flex: 1; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;
                        ">â• åˆ›å»ºæ–°å¯†é’¥</button>
                        <button onclick="this.closest('[style*=\\'position: fixed\\']').remove()" style="
                            flex: 1; padding: 12px; background: #f3f4f6; color: #374151;
                            border: none; border-radius: 8px; cursor: pointer; font-size: 16px;
                        ">å…³é—­</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
        }
        
        async function deleteAPIKey(keyId, keyName, workflowId, workflowName) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å¯†é’¥"${keyName}"å—ï¼Ÿ\n\nåˆ é™¤åä½¿ç”¨æ­¤å¯†é’¥çš„APIè°ƒç”¨å°†å¤±è´¥ï¼`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/workflows/api-keys/${keyId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showToast('âœ… å¯†é’¥å·²åˆ é™¤', 'success');
                    // å…³é—­å½“å‰æ¨¡æ€æ¡†
                    document.querySelectorAll('[style*="position: fixed"]').forEach(m => m.remove());
                    // é‡æ–°æ‰“å¼€å¯†é’¥åˆ—è¡¨
                    setTimeout(() => viewAPIKeys(workflowId, workflowName), 500);
                } else {
                    showToast('âŒ åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('âŒ åˆ é™¤å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶åŠ è½½æ•°æ®
        loadAgents();
        loadWorkflows();
    </script>
</body>
</html>

