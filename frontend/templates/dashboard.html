<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®çœ‹æ¿ - æ™ºé“¾ç¼–æ’å¹³å°</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 20px 0;
        }
        
        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .chart-card h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.3em;
        }
        
        .chart-container {
            width: 100%;
            height: 350px;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .metric-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .trend {
            font-size: 0.85em;
            margin-top: 8px;
        }
        
        .trend.up {
            color: #4caf50;
        }
        
        .trend.down {
            color: #f44336;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡µé¢å¤´éƒ¨ -->
        <header>
            <div class="header-content">
                <div class="header-left">
                    <h1>ğŸ“Š æ•°æ®çœ‹æ¿</h1>
                    <div class="subtitle">å®æ—¶ç›‘æ§ç³»ç»Ÿè¿è¡ŒçŠ¶æ€</div>
                </div>
                <div class="header-right">
                    <a href="/workspace" class="btn" style="background: #667eea; color: white; text-decoration: none; padding: 10px 20px; border-radius: 5px; margin-right: 15px;">â† è¿”å›å·¥ä½œå°</a>
                    <span class="user-info">ğŸ‘¤ {{ username }}</span>
                    <a href="/logout" class="logout-btn">é€€å‡ºç™»å½•</a>
                </div>
            </div>
        </header>
        
        <!-- æ ¸å¿ƒæŒ‡æ ‡ -->
        <div class="metric-grid">
            <div class="metric-card">
                <div class="metric-value" id="total-agents">0</div>
                <div class="metric-label">Agent æ€»æ•°</div>
                <div class="trend up">â†‘ æœ¬å‘¨ +2</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="total-workflows">0</div>
                <div class="metric-label">å·¥ä½œæµæ€»æ•°</div>
                <div class="trend up">â†‘ æœ¬å‘¨ +1</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="total-executions">0</div>
                <div class="metric-label">æ€»æ‰§è¡Œæ¬¡æ•°</div>
                <div class="trend up">â†‘ ä»Šæ—¥ +5</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="avg-success-rate">0%</div>
                <div class="metric-label">å¹³å‡æˆåŠŸç‡</div>
                <div class="trend up">â†‘ 98.5%</div>
            </div>
        </div>
        
        <!-- å›¾è¡¨åŒºåŸŸ -->
        <div class="dashboard-grid">
            <!-- Agent ç±»å‹åˆ†å¸ƒ -->
            <div class="chart-card">
                <h3>ğŸ“¦ Agent ç±»å‹åˆ†å¸ƒ</h3>
                <div id="agent-type-chart" class="chart-container"></div>
            </div>
            
            <!-- å·¥ä½œæµçŠ¶æ€åˆ†å¸ƒ -->
            <div class="chart-card">
                <h3>ğŸ”„ å·¥ä½œæµçŠ¶æ€åˆ†å¸ƒ</h3>
                <div id="workflow-status-chart" class="chart-container"></div>
            </div>
            
            <!-- æ‰§è¡Œè¶‹åŠ¿å›¾ -->
            <div class="chart-card full-width">
                <h3>ğŸ“ˆ æ‰§è¡Œè¶‹åŠ¿ï¼ˆæœ€è¿‘7å¤©ï¼‰</h3>
                <div id="execution-trend-chart" class="chart-container"></div>
            </div>
            
            <!-- Top Agent æ’è¡Œ -->
            <div class="chart-card">
                <h3>ğŸ† Top 10 çƒ­é—¨ Agent</h3>
                <div id="top-agents-chart" class="chart-container"></div>
            </div>
            
            <!-- æˆåŠŸç‡åˆ†å¸ƒ -->
            <div class="chart-card">
                <h3>âœ… Agent æˆåŠŸç‡åˆ†å¸ƒ</h3>
                <div id="success-rate-chart" class="chart-container"></div>
            </div>
        </div>
        
        <!-- é¡µè„š -->
        <footer>
            <p>æ™ºé“¾ç¼–æ’å¹³å° - æ•°æ®å¯è§†åŒ–çœ‹æ¿</p>
            <p style="font-size: 12px; color: #999; margin-top: 5px;">æ•°æ®æ¯30ç§’è‡ªåŠ¨åˆ·æ–°</p>
        </footer>
    </div>
    
    <script>
        // åŠ è½½æ•°æ®
        async function loadDashboardData() {
            try {
                // åŠ è½½ Agent æ•°æ®
                const agentsResp = await fetch('/api/agents');
                const agents = agentsResp.ok ? await agentsResp.json() : [];
                
                // åŠ è½½å·¥ä½œæµæ•°æ®
                const workflowsResp = await fetch('/api/workflows');
                const workflows = workflowsResp.ok ? await workflowsResp.json() : [];
                
                // æ›´æ–°æ ¸å¿ƒæŒ‡æ ‡
                document.getElementById('total-agents').textContent = agents.length;
                document.getElementById('total-workflows').textContent = workflows.length;
                
                let totalExec = workflows.reduce((sum, w) => sum + (w.total_executions || 0), 0);
                document.getElementById('total-executions').textContent = totalExec;
                
                let avgSuccess = workflows.length > 0 
                    ? workflows.reduce((sum, w) => sum + (w.success_rate || 0), 0) / workflows.length
                    : 0;
                document.getElementById('avg-success-rate').textContent = avgSuccess.toFixed(1) + '%';
                
                // æ¸²æŸ“å›¾è¡¨
                renderAgentTypeChart(agents);
                renderWorkflowStatusChart(workflows);
                renderExecutionTrendChart();
                renderTopAgentsChart(agents);
                renderSuccessRateChart(agents);
                
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
            }
        }
        
        // Agent ç±»å‹åˆ†å¸ƒé¥¼å›¾
        function renderAgentTypeChart(agents) {
            const chart = echarts.init(document.getElementById('agent-type-chart'));
            
            // ç»Ÿè®¡ç±»å‹åˆ†å¸ƒ
            const typeCount = {};
            agents.forEach(agent => {
                const type = agent.agent_type || 'other';
                typeCount[type] = (typeCount[type] || 0) + 1;
            });
            
            const data = Object.entries(typeCount).map(([name, value]) => ({name, value}));
            
            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c} ({d}%)'
                },
                legend: {
                    orient: 'vertical',
                    right: 10,
                    top: 'center'
                },
                series: [{
                    type: 'pie',
                    radius: ['40%', '70%'],
                    avoidLabelOverlap: false,
                    itemStyle: {
                        borderRadius: 10,
                        borderColor: '#fff',
                        borderWidth: 2
                    },
                    label: {
                        show: false,
                        position: 'center'
                    },
                    emphasis: {
                        label: {
                            show: true,
                            fontSize: 20,
                            fontWeight: 'bold'
                        }
                    },
                    labelLine: {
                        show: false
                    },
                    data: data
                }],
                color: ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b']
            };
            
            chart.setOption(option);
        }
        
        // å·¥ä½œæµçŠ¶æ€åˆ†å¸ƒ
        function renderWorkflowStatusChart(workflows) {
            const chart = echarts.init(document.getElementById('workflow-status-chart'));
            
            const statusCount = {active: 0, inactive: 0, pending: 0};
            workflows.forEach(w => {
                const status = w.status || 'active';
                statusCount[status] = (statusCount[status] || 0) + 1;
            });
            
            const option = {
                tooltip: {
                    trigger: 'item'
                },
                series: [{
                    type: 'pie',
                    radius: '60%',
                    data: [
                        {value: statusCount.active, name: 'æ´»è·ƒ'},
                        {value: statusCount.inactive, name: 'åœç”¨'},
                        {value: statusCount.pending, name: 'å¾…å®š'}
                    ],
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }],
                color: ['#28a745', '#dc3545', '#ffc107']
            };
            
            chart.setOption(option);
        }
        
        // æ‰§è¡Œè¶‹åŠ¿æŠ˜çº¿å›¾
        function renderExecutionTrendChart() {
            const chart = echarts.init(document.getElementById('execution-trend-chart'));
            
            // æ¨¡æ‹Ÿ7å¤©æ•°æ®
            const days = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
            const execData = [12, 18, 25, 32, 28, 35, 42];
            const successData = [11, 17, 24, 30, 27, 34, 41];
            
            const option = {
                tooltip: {
                    trigger: 'axis'
                },
                legend: {
                    data: ['æ€»æ‰§è¡Œ', 'æˆåŠŸæ‰§è¡Œ']
                },
                xAxis: {
                    type: 'category',
                    data: days
                },
                yAxis: {
                    type: 'value'
                },
                series: [
                    {
                        name: 'æ€»æ‰§è¡Œ',
                        type: 'line',
                        data: execData,
                        smooth: true,
                        itemStyle: {color: '#667eea'}
                    },
                    {
                        name: 'æˆåŠŸæ‰§è¡Œ',
                        type: 'line',
                        data: successData,
                        smooth: true,
                        itemStyle: {color: '#28a745'}
                    }
                ]
            };
            
            chart.setOption(option);
        }
        
        // Top Agent æ’è¡ŒæŸ±çŠ¶å›¾
        function renderTopAgentsChart(agents) {
            const chart = echarts.init(document.getElementById('top-agents-chart'));
            
            // æŒ‰æ‰§è¡Œæ¬¡æ•°æ’åº
            const sortedAgents = [...agents]
                .sort((a, b) => (b.total_executions || 0) - (a.total_executions || 0))
                .slice(0, 10);
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {type: 'shadow'}
                },
                xAxis: {
                    type: 'value'
                },
                yAxis: {
                    type: 'category',
                    data: sortedAgents.map(a => a.name),
                    axisLabel: {
                        interval: 0,
                        formatter: function(value) {
                            return value.length > 10 ? value.substr(0, 10) + '...' : value;
                        }
                    }
                },
                series: [{
                    type: 'bar',
                    data: sortedAgents.map(a => a.total_executions || 0),
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                            {offset: 0, color: '#667eea'},
                            {offset: 1, color: '#764ba2'}
                        ])
                    }
                }]
            };
            
            chart.setOption(option);
        }
        
        // æˆåŠŸç‡åˆ†å¸ƒ
        function renderSuccessRateChart(agents) {
            const chart = echarts.init(document.getElementById('success-rate-chart'));
            
            // æˆåŠŸç‡åˆ†æ®µç»Ÿè®¡
            const ranges = {
                '90-100%': 0,
                '70-90%': 0,
                '50-70%': 0,
                '0-50%': 0
            };
            
            agents.forEach(agent => {
                const rate = agent.success_rate || 0;
                if (rate >= 90) ranges['90-100%']++;
                else if (rate >= 70) ranges['70-90%']++;
                else if (rate >= 50) ranges['50-70%']++;
                else ranges['0-50%']++;
            });
            
            const option = {
                tooltip: {
                    trigger: 'item'
                },
                series: [{
                    type: 'pie',
                    radius: ['30%', '60%'],
                    data: Object.entries(ranges).map(([name, value]) => ({name, value})),
                    label: {
                        formatter: '{b}\n{c} ä¸ª'
                    }
                }],
                color: ['#28a745', '#5bc0de', '#f0ad4e', '#d9534f']
            };
            
            chart.setOption(option);
        }
        
        // é¡µé¢åŠ è½½
        window.onload = () => {
            loadDashboardData();
            
            // 30ç§’è‡ªåŠ¨åˆ·æ–°
            setInterval(loadDashboardData, 30000);
            
            // å“åº”å¼è°ƒæ•´
            window.addEventListener('resize', () => {
                echarts.init(document.getElementById('agent-type-chart')).resize();
                echarts.init(document.getElementById('workflow-status-chart')).resize();
                echarts.init(document.getElementById('execution-trend-chart')).resize();
                echarts.init(document.getElementById('top-agents-chart')).resize();
                echarts.init(document.getElementById('success-rate-chart')).resize();
            });
        };
    </script>
</body>
</html>


