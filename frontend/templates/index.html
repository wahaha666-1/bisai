<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºé“¾ç¼–æ’å¹³å° - å·¥ä½œå°</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* å¼¹çª—æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
        }
        
        .close:hover {
            color: #333;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .form-group textarea {
            min-height: 100px;
            font-family: 'Courier New', monospace;
        }
        
        .btn-create {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
        }
        
        .btn-create:hover {
            background: #5568d3;
        }
        
        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            margin-right: 10px;
        }
        
        .btn-execute {
            background: #28a745;
            color: white;
        }
        
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .btn-add {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .btn-add:hover {
            background: #5568d3;
        }
        
        .success-msg, .error-msg {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .success-msg {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error-msg {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡µé¢å¤´éƒ¨ -->
        <header>
            <div class="header-content">
                <div class="header-left">
                    <h1>ğŸ¤– æ™ºé“¾ç¼–æ’å¹³å°</h1>
                    <div class="subtitle">AI Agent å·¥ä½œæµç¼–æ’ - å·¥ä½œå°</div>
                </div>
                <div class="header-right">
                    <a href="/chat" class="btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; padding: 10px 20px; border-radius: 5px; margin-right: 15px;">ğŸ’¬ DeepSeek å¯¹è¯</a>
                    <a href="/tools" class="btn" style="background: #ff9800; color: white; text-decoration: none; padding: 10px 20px; border-radius: 5px; margin-right: 15px;">ğŸ› ï¸ å·¥å…·ç®¡ç†</a>
                    <a href="/dashboard" class="btn" style="background: #28a745; color: white; text-decoration: none; padding: 10px 20px; border-radius: 5px; margin-right: 15px;">ğŸ“Š æ•°æ®çœ‹æ¿</a>
                    {% if role == 'admin' %}
                    <a href="/admin" class="btn" style="background: #ff6b6b; color: white; text-decoration: none; padding: 10px 20px; border-radius: 5px; margin-right: 15px;">ğŸ”§ ç®¡ç†åå°</a>
                    {% endif %}
                    <span class="user-info">ğŸ‘¤ {{ username }}</span>
                    <a href="/logout" class="logout-btn">é€€å‡ºç™»å½•</a>
                </div>
            </div>
        </header>
        
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="agent-count">0</div>
                <div class="stat-label">å·²æ³¨å†Œ Agent</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="workflow-count">0</div>
                <div class="stat-label">å·¥ä½œæµ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="execution-count">0</div>
                <div class="stat-label">æ€»æ‰§è¡Œæ¬¡æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="success-rate">0%</div>
                <div class="stat-label">æˆåŠŸç‡</div>
            </div>
        </div>
        
        <!-- Agent åˆ—è¡¨ -->
        <div class="section">
            <div class="section-header">
                <h2>ğŸ“¦ Agent åº“</h2>
                <button class="btn-add" onclick="openCreateAgentModal()">â• åˆ›å»º Agent</button>
            </div>
            <div class="agent-list" id="agent-list">
                <p style="text-align: center; color: #999; padding: 40px;">â³ åŠ è½½ä¸­...</p>
            </div>
        </div>
        
        <!-- å·¥ä½œæµåˆ—è¡¨ -->
        <div class="section">
            <div class="section-header">
                <h2>ğŸ”„ å·¥ä½œæµ</h2>
                <button class="btn-add" onclick="openCreateWorkflowModal()">â• åˆ›å»ºå·¥ä½œæµ</button>
            </div>
            <div class="workflow-list" id="workflow-list">
                <p style="text-align: center; color: #999; padding: 40px;">â³ åŠ è½½ä¸­...</p>
            </div>
        </div>
        
        <!-- æ—¥å¿—åˆ—è¡¨ -->
        <div class="section">
            <h2>ğŸ“ æœ€è¿‘æ—¥å¿—</h2>
            <div id="log-list">
                <p style="text-align: center; color: #999; padding: 40px;">â³ åŠ è½½ä¸­...</p>
            </div>
        </div>
        
        <!-- é¡µè„š -->
        <footer>
            <p>æ™ºé“¾ç¼–æ’å¹³å° - è®© AI Agent ç¼–æ’åƒæ­ç§¯æœ¨ä¸€æ ·ç®€å•</p>
        </footer>
    </div>
    
    <!-- åˆ›å»º Agent å¼¹çª— -->
    <div id="createAgentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>â• åˆ›å»ºæ–° Agent</h2>
                <span class="close" onclick="closeCreateAgentModal()">&times;</span>
            </div>
            
            <div id="agent-msg-success" class="success-msg"></div>
            <div id="agent-msg-error" class="error-msg"></div>
            
            <form id="createAgentForm" onsubmit="createAgent(event)">
                <div class="form-group">
                    <label>Agent åç§° *</label>
                    <input type="text" id="agent-name" required placeholder="ä¾‹å¦‚ï¼šæ–‡æœ¬å¤„ç†å™¨">
                </div>
                
                <div class="form-group">
                    <label>Agent ç±»å‹ *</label>
                    <select id="agent-type" required>
                        <option value="processor">æ–‡æœ¬å¤„ç† (processor)</option>
                        <option value="analyzer">æ•°æ®åˆ†æ (analyzer)</option>
                        <option value="generator">å†…å®¹ç”Ÿæˆ (generator)</option>
                        <option value="crawler">ç½‘é¡µçˆ¬è™« (crawler)</option>
                        <option value="other">å…¶ä»– (other)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>æè¿°</label>
                    <textarea id="agent-description" placeholder="æè¿°è¿™ä¸ª Agent çš„åŠŸèƒ½..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>å‡½æ•°ä»£ç  *</label>
                    <textarea id="agent-code" required placeholder="def process_text(text: str) -> str:
    return text.upper()"></textarea>
                </div>
                
                <button type="submit" class="btn-create">âœ… åˆ›å»º Agent</button>
            </form>
        </div>
    </div>
    
    <!-- åˆ›å»ºå·¥ä½œæµå¼¹çª— -->
    <div id="createWorkflowModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>â• åˆ›å»ºæ–°å·¥ä½œæµ</h2>
                <span class="close" onclick="closeCreateWorkflowModal()">&times;</span>
            </div>
            
            <div id="workflow-msg-success" class="success-msg"></div>
            <div id="workflow-msg-error" class="error-msg"></div>
            
            <form id="createWorkflowForm" onsubmit="createWorkflow(event)">
                <div class="form-group">
                    <label>å·¥ä½œæµåç§° *</label>
                    <input type="text" id="workflow-name" required placeholder="ä¾‹å¦‚ï¼šæ•°æ®å¤„ç†æµç¨‹">
                </div>
                
                <div class="form-group">
                    <label>æè¿°</label>
                    <textarea id="workflow-description" placeholder="æè¿°è¿™ä¸ªå·¥ä½œæµçš„ç”¨é€”..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>åˆ†ç±»</label>
                    <select id="workflow-category">
                        <option value="æ•°æ®å¤„ç†">æ•°æ®å¤„ç†</option>
                        <option value="å†…å®¹ç”Ÿæˆ">å†…å®¹ç”Ÿæˆ</option>
                        <option value="è‡ªåŠ¨åŒ–">è‡ªåŠ¨åŒ–</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>å·¥ä½œæµå®šä¹‰ï¼ˆJSONæ ¼å¼ï¼‰*</label>
                    <textarea id="workflow-definition" required placeholder='{"agents": ["agent1", "agent2"], "sequence": [{"agent": "agent1", "next": "agent2"}]}'></textarea>
                    <small style="color: #666;">æç¤ºï¼šå®šä¹‰ Agent æ‰§è¡Œé¡ºåºå’Œæ•°æ®æµ</small>
                </div>
                
                <button type="submit" class="btn-create">âœ… åˆ›å»ºå·¥ä½œæµ</button>
            </form>
        </div>
    </div>
    
    <script src="{{ url_for('static', filename='js/main.js') }}?v=20251102125338"></script>
    <script>
        // ============================================================================
        // å†…è”æ‰§è¡Œå‡½æ•° - ç»•è¿‡ç¼“å­˜é—®é¢˜ï¼ˆè¦†ç›–å¤–éƒ¨JSä¸­çš„æ—§å‡½æ•°ï¼‰
        // ============================================================================
        
        // æ˜¾ç¤ºå·¥ä½œæµæ‰§è¡Œç»“æœçš„ç¾è§‚æ¨¡æ€æ¡†
        function showExecutionResult(result) {
            // ç§»é™¤æ—§çš„æ¨¡æ€æ¡†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const oldModal = document.getElementById('execution-result-modal');
            if (oldModal) oldModal.remove();
            
            const isSuccess = result.success;
            const statusIcon = isSuccess ? 'âœ…' : 'âŒ';
            const statusColor = isSuccess ? '#10b981' : '#ef4444';
            const statusText = isSuccess ? 'å·¥ä½œæµæ‰§è¡ŒæˆåŠŸï¼' : 'å·¥ä½œæµæ‰§è¡Œå¤±è´¥ï¼';
            
            // åˆ›å»ºæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.id = 'execution-result-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 16px;
                    padding: 32px;
                    max-width: 700px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                    animation: slideUp 0.3s ease;
                ">
                    <div style="text-align: center; margin-bottom: 24px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">${statusIcon}</div>
                        <h2 style="margin: 0; color: ${statusColor}; font-size: 24px;">${statusText}</h2>
                    </div>
                    
                    <div style="background: #f9fafb; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                        <div style="display: grid; grid-template-columns: auto 1fr; gap: 12px 16px; font-size: 14px;">
                            <div style="font-weight: 600; color: #6b7280;">å·¥ä½œæµï¼š</div>
                            <div style="color: #111827;">${result.workflow_name || 'N/A'}</div>
                            
                            <div style="font-weight: 600; color: #6b7280;">æ‰§è¡Œæ—¶é—´ï¼š</div>
                            <div style="color: #111827;">${result.execution_time ? result.execution_time.toFixed(3) : '0.000'} ç§’</div>
                            
                            <div style="font-weight: 600; color: #6b7280;">æ‰§è¡ŒIDï¼š</div>
                            <div style="color: #111827;">#${result.execution_id || 'N/A'}</div>
                        </div>
                    </div>
                    
                    ${result.error ? `
                        <div style="background: #fee2e2; border-left: 4px solid #ef4444; padding: 12px; border-radius: 4px; margin-bottom: 16px;">
                            <div style="font-weight: 600; color: #dc2626; margin-bottom: 8px;">âŒ é”™è¯¯ä¿¡æ¯ï¼š</div>
                            <div style="color: #991b1b; font-family: monospace; font-size: 13px; white-space: pre-wrap;">${result.error}</div>
                        </div>
                    ` : ''}
                    
                    <div style="background: #f9fafb; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                        <div style="font-weight: 600; color: #374151; margin-bottom: 12px;">ğŸ“‹ æ‰§è¡Œç»“æœï¼š</div>
                        <pre style="
                            background: #1f2937;
                            color: #10b981;
                            padding: 16px;
                            border-radius: 8px;
                            overflow-x: auto;
                            margin: 0;
                            font-size: 13px;
                            line-height: 1.5;
                            max-height: 300px;
                        ">${JSON.stringify(result.output, null, 2)}</pre>
                    </div>
                    
                    <button onclick="document.getElementById('execution-result-modal').remove(); if (typeof loadData === 'function') loadData();" style="
                        width: 100%;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border: none;
                        padding: 14px;
                        border-radius: 8px;
                        font-size: 16px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: transform 0.2s, box-shadow 0.2s;
                    " onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 8px 20px rgba(102, 126, 234, 0.4)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                        ç¡®å®š
                    </button>
                </div>
            `;
            
            // æ·»åŠ åŠ¨ç”»CSS
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                @keyframes slideUp {
                    from {
                        opacity: 0;
                        transform: translateY(30px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }
            `;
            if (!document.getElementById('modal-animations')) {
                style.id = 'modal-animations';
                document.head.appendChild(style);
            }
            
            document.body.appendChild(modal);
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                    if (typeof loadData === 'function') loadData();
                }
            });
        }
        
        // æ‰§è¡Œå·¥ä½œæµï¼ˆå†…è”ç‰ˆæœ¬ - ä¼šè¦†ç›– main.js ä¸­çš„æ—§ç‰ˆæœ¬ï¼‰
        window.executeWorkflow = async function(workflowId, workflowName) {
            try {
                // å¼¹å‡ºè¾“å…¥å‚æ•°å¯¹è¯æ¡†
                const inputParams = prompt(
                    `æ‰§è¡Œå·¥ä½œæµã€Œ${workflowName}ã€\n\nè¯·è¾“å…¥å‚æ•°ï¼ˆJSONæ ¼å¼ï¼‰ï¼š\nä¾‹å¦‚ï¼š{"text": "Hello World", "mode": "upper"}`,
                    '{"text": "Hello World", "mode": "upper"}'
                );
                
                if (inputParams === null) return; // ç”¨æˆ·å–æ¶ˆ
                
                // è§£æè¾“å…¥å‚æ•°
                let params = {};
                try {
                    params = JSON.parse(inputParams);
                } catch (e) {
                    alert(`âŒ JSONæ ¼å¼é”™è¯¯ï¼š${e.message}\n\nè¯·ä½¿ç”¨æ­£ç¡®çš„JSONæ ¼å¼ï¼Œä¾‹å¦‚ï¼š\n{"text": "Hello", "mode": "upper"}`);
                    return;
                }
                
                console.log(`[å†…è”ç‰ˆæœ¬] æ‰§è¡Œå·¥ä½œæµ ID: ${workflowId}, åç§°: ${workflowName}, å‚æ•°:`, params);
                
                const response = await fetch(`/api/workflows/${workflowId}/execute`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(params)
                });
                
                const result = await response.json();
                console.log('[å†…è”ç‰ˆæœ¬] æ‰§è¡Œç»“æœ:', result);
                
                // ä½¿ç”¨ç¾è§‚çš„æ¨¡æ€æ¡†æ˜¾ç¤ºç»“æœ
                showExecutionResult({
                    success: result.success,
                    workflow_name: workflowName,
                    execution_time: result.execution_time,
                    execution_id: result.execution_id,
                    output: result.output,
                    error: result.error
                });
                
            } catch (error) {
                showExecutionResult({
                    success: false,
                    workflow_name: workflowName,
                    error: error.message,
                    output: null
                });
                console.error('[å†…è”ç‰ˆæœ¬] æ‰§è¡Œå¤±è´¥:', error);
            }
        }
        
        // åˆ é™¤ Agent
        async function deleteAgent(agentName) {
            try {
                const confirmed = confirm(`ç¡®å®šè¦åˆ é™¤ Agentã€Œ${agentName}ã€å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`);
                if (!confirmed) return;
                
                const response = await fetch(`/api/agents/${encodeURIComponent(agentName)}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`âœ… Agent åˆ é™¤æˆåŠŸï¼`);
                    if (typeof loadData === 'function') {
                        loadData();
                    }
                } else {
                    alert(`âŒ åˆ é™¤å¤±è´¥ï¼\n\n${result.error || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                alert(`âŒ åˆ é™¤ Agent æ—¶å‘ç”Ÿé”™è¯¯ï¼\n\n${error.message}`);
                console.error('åˆ é™¤ Agent å¤±è´¥:', error);
            }
        }
        
        // åˆ é™¤å·¥ä½œæµ
        async function deleteWorkflow(workflowId, workflowName) {
            try {
                const confirmed = confirm(`ç¡®å®šè¦åˆ é™¤å·¥ä½œæµã€Œ${workflowName}ã€å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`);
                if (!confirmed) return;
                
                const response = await fetch(`/api/workflows/${workflowId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`âœ… å·¥ä½œæµåˆ é™¤æˆåŠŸï¼`);
                    if (typeof loadData === 'function') {
                        loadData();
                    }
                } else {
                    alert(`âŒ åˆ é™¤å¤±è´¥ï¼\n\n${result.error || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                alert(`âŒ åˆ é™¤å·¥ä½œæµæ—¶å‘ç”Ÿé”™è¯¯ï¼\n\n${error.message}`);
                console.error('åˆ é™¤å·¥ä½œæµå¤±è´¥:', error);
            }
        }
        
        console.log('[å†…è”è„šæœ¬] executeWorkflow, deleteAgent, deleteWorkflow å‡½æ•°å·²åŠ è½½');
        
        // ============================================================================
        // æ¨¡æ€æ¡†å‡½æ•°
        // ============================================================================
        
        // æ‰“å¼€/å…³é—­ Agent åˆ›å»ºå¼¹çª—
        function openCreateAgentModal() {
            document.getElementById('createAgentModal').style.display = 'block';
        }
        
        function closeCreateAgentModal() {
            document.getElementById('createAgentModal').style.display = 'none';
            document.getElementById('createAgentForm').reset();
            document.getElementById('agent-msg-success').style.display = 'none';
            document.getElementById('agent-msg-error').style.display = 'none';
        }
        
        // æ‰“å¼€/å…³é—­å·¥ä½œæµåˆ›å»ºå¼¹çª—
        function openCreateWorkflowModal() {
            document.getElementById('createWorkflowModal').style.display = 'block';
        }
        
        function closeCreateWorkflowModal() {
            document.getElementById('createWorkflowModal').style.display = 'none';
            document.getElementById('createWorkflowForm').reset();
            document.getElementById('workflow-msg-success').style.display = 'none';
            document.getElementById('workflow-msg-error').style.display = 'none';
        }
        
        // åˆ›å»º Agent
        async function createAgent(event) {
            event.preventDefault();
            
            const name = document.getElementById('agent-name').value;
            const type = document.getElementById('agent-type').value;
            const description = document.getElementById('agent-description').value;
            const code = document.getElementById('agent-code').value;
            
            try {
                const response = await fetch('/api/agents', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        name: name,
                        agent_type: type,
                        description: description,
                        code: code
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('agent-msg-success').textContent = 'âœ… Agent åˆ›å»ºæˆåŠŸï¼';
                    document.getElementById('agent-msg-success').style.display = 'block';
                    document.getElementById('agent-msg-error').style.display = 'none';
                    
                    setTimeout(() => {
                        closeCreateAgentModal();
                        loadAgents(); // é‡æ–°åŠ è½½åˆ—è¡¨
                    }, 1500);
                } else {
                    document.getElementById('agent-msg-error').textContent = 'âŒ ' + (data.error || 'åˆ›å»ºå¤±è´¥');
                    document.getElementById('agent-msg-error').style.display = 'block';
                    document.getElementById('agent-msg-success').style.display = 'none';
                }
            } catch (error) {
                document.getElementById('agent-msg-error').textContent = 'âŒ ç½‘ç»œé”™è¯¯ï¼š' + error.message;
                document.getElementById('agent-msg-error').style.display = 'block';
            }
        }
        
        // åˆ›å»ºå·¥ä½œæµ
        async function createWorkflow(event) {
            event.preventDefault();
            
            const name = document.getElementById('workflow-name').value;
            const description = document.getElementById('workflow-description').value;
            const category = document.getElementById('workflow-category').value;
            const definitionStr = document.getElementById('workflow-definition').value;
            
            try {
                // éªŒè¯ JSON æ ¼å¼
                const definition = JSON.parse(definitionStr);
                
                const response = await fetch('/api/workflows', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        name: name,
                        description: description,
                        category: category,
                        workflow_definition: definition
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('workflow-msg-success').textContent = 'âœ… å·¥ä½œæµåˆ›å»ºæˆåŠŸï¼';
                    document.getElementById('workflow-msg-success').style.display = 'block';
                    document.getElementById('workflow-msg-error').style.display = 'none';
                    
                    setTimeout(() => {
                        closeCreateWorkflowModal();
                        loadWorkflows(); // é‡æ–°åŠ è½½åˆ—è¡¨
                    }, 1500);
                } else {
                    document.getElementById('workflow-msg-error').textContent = 'âŒ ' + (data.error || 'åˆ›å»ºå¤±è´¥');
                    document.getElementById('workflow-msg-error').style.display = 'block';
                    document.getElementById('workflow-msg-success').style.display = 'none';
                }
            } catch (error) {
                document.getElementById('workflow-msg-error').textContent = 'âŒ JSON æ ¼å¼é”™è¯¯ï¼š' + error.message;
                document.getElementById('workflow-msg-error').style.display = 'block';
            }
        }
        
        // æ‰§è¡Œå·¥ä½œæµ
        async function executeWorkflow(workflowId, workflowName) {
            if (!confirm(`ç¡®å®šè¦æ‰§è¡Œå·¥ä½œæµã€Œ${workflowName}ã€å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/workflows/${workflowId}/execute`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({})
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    alert('âœ… å·¥ä½œæµæ‰§è¡ŒæˆåŠŸï¼\n\nç»“æœï¼š' + JSON.stringify(data.result, null, 2));
                    loadStats();
                    loadLogs();
                } else {
                    alert('âŒ å·¥ä½œæµæ‰§è¡Œå¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('âŒ ç½‘ç»œé”™è¯¯ï¼š' + error.message);
            }
        }
        
        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const agentModal = document.getElementById('createAgentModal');
            const workflowModal = document.getElementById('createWorkflowModal');
            
            if (event.target == agentModal) {
                closeCreateAgentModal();
            }
            if (event.target == workflowModal) {
                closeCreateWorkflowModal();
            }
        }
    </script>
    
    <!-- æ‰¹é‡åˆ é™¤åŠŸèƒ½ -->
    <script src="{{ url_for('static', filename='js/batch-operations.js') }}"></script>
</body>
</html>
